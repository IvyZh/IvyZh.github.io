<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Top团队大牛带你玩转Android性能分析与优化 | K的小屋</title><meta name="description" content="Top团队大牛带你玩转Android性能分析与优化"><meta name="keywords" content="Android,性能优化"><meta name="author" content="Kai"><meta name="copyright" content="Kai"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Top团队大牛带你玩转Android性能分析与优化"><meta name="twitter:description" content="Top团队大牛带你玩转Android性能分析与优化"><meta name="twitter:image" content="https://coding.imooc.com/static/module/class/content/img/308/section1-2.png"><meta property="og:type" content="article"><meta property="og:title" content="Top团队大牛带你玩转Android性能分析与优化"><meta property="og:url" content="https://www.google.com/2020/06/29/Top%E5%9B%A2%E9%98%9F%E5%A4%A7%E7%89%9B%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACAndroid%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96/"><meta property="og:site_name" content="K的小屋"><meta property="og:description" content="Top团队大牛带你玩转Android性能分析与优化"><meta property="og:image" content="https://coding.imooc.com/static/module/class/content/img/308/section1-2.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.google.com/2020/06/29/Top%E5%9B%A2%E9%98%9F%E5%A4%A7%E7%89%9B%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACAndroid%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96/"><link rel="next" title="Ubuntu18.04编译安卓" href="https://www.google.com/2020/06/25/Ubuntu18.04%E7%BC%96%E8%AF%91%E5%AE%89%E5%8D%93/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">24</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#第1章-课程导学与学习指南"><span class="toc-number">1.</span> <span class="toc-text">第1章 课程导学与学习指南</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第2章-App性能概览与平台化实践"><span class="toc-number">2.</span> <span class="toc-text">第2章 App性能概览与平台化实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第3章-App启动优化"><span class="toc-number">3.</span> <span class="toc-text">第3章 App启动优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#App启动分类"><span class="toc-number">3.1.</span> <span class="toc-text">App启动分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#冷启动"><span class="toc-number">3.1.1.</span> <span class="toc-text">冷启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#热启动"><span class="toc-number">3.1.2.</span> <span class="toc-text">热启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#温启动"><span class="toc-number">3.1.3.</span> <span class="toc-text">温启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#相关任务"><span class="toc-number">3.2.</span> <span class="toc-text">相关任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化方向"><span class="toc-number">3.3.</span> <span class="toc-text">优化方向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动时间测量方式"><span class="toc-number">3.4.</span> <span class="toc-text">启动时间测量方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#adb命令"><span class="toc-number">3.4.1.</span> <span class="toc-text">adb命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手动打点"><span class="toc-number">3.4.2.</span> <span class="toc-text">手动打点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动优化工具"><span class="toc-number">3.5.</span> <span class="toc-text">启动优化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TraceView"><span class="toc-number">3.5.1.</span> <span class="toc-text">TraceView</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Systrace"><span class="toc-number">3.5.2.</span> <span class="toc-text">Systrace</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取方法执行耗时实践"><span class="toc-number">3.6.</span> <span class="toc-text">获取方法执行耗时实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式"><span class="toc-number">3.6.1.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP方式"><span class="toc-number">3.6.2.</span> <span class="toc-text">AOP方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化技巧"><span class="toc-number">3.7.</span> <span class="toc-text">优化技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步优化（常规）"><span class="toc-number">3.8.</span> <span class="toc-text">异步优化（常规）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步初始化（最优解）"><span class="toc-number">3.9.</span> <span class="toc-text">异步初始化（最优解）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规异步痛点"><span class="toc-number">3.9.1.</span> <span class="toc-text">常规异步痛点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动器实现异步初始化"><span class="toc-number">3.9.2.</span> <span class="toc-text">启动器实现异步初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#延迟初始化"><span class="toc-number">3.10.</span> <span class="toc-text">延迟初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方案"><span class="toc-number">3.10.1.</span> <span class="toc-text">常规方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更优方案"><span class="toc-number">3.10.2.</span> <span class="toc-text">更优方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本章总结"><span class="toc-number">3.11.</span> <span class="toc-text">本章总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取方法耗时"><span class="toc-number">3.11.1.</span> <span class="toc-text">获取方法耗时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化总方针"><span class="toc-number">3.11.2.</span> <span class="toc-text">优化总方针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注意事项"><span class="toc-number">3.11.3.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他方案"><span class="toc-number">3.11.4.</span> <span class="toc-text">其他方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第4章-App内存优化"><span class="toc-number">4.</span> <span class="toc-text">第4章 App内存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#内存优化介绍"><span class="toc-number">4.1.</span> <span class="toc-text">内存优化介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内存问题"><span class="toc-number">4.1.1.</span> <span class="toc-text">内存问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化工具选择"><span class="toc-number">4.2.</span> <span class="toc-text">优化工具选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Memory-Profiler"><span class="toc-number">4.2.1.</span> <span class="toc-text">Memory Profiler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memory-Analyzer"><span class="toc-number">4.2.2.</span> <span class="toc-text">Memory Analyzer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeakCanary"><span class="toc-number">4.2.3.</span> <span class="toc-text">LeakCanary</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java内存管理机制"><span class="toc-number">4.3.</span> <span class="toc-text">Java内存管理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Java内存分配"><span class="toc-number">4.3.1.</span> <span class="toc-text">Java内存分配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java内存回收算法"><span class="toc-number">4.3.2.</span> <span class="toc-text">Java内存回收算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Android内存管理机制"><span class="toc-number">4.4.</span> <span class="toc-text">Android内存管理机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决内存抖动"><span class="toc-number">4.5.</span> <span class="toc-text">解决内存抖动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是内存抖动"><span class="toc-number">4.5.1.</span> <span class="toc-text">什么是内存抖动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解决方案"><span class="toc-number">4.5.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决内存泄露"><span class="toc-number">4.6.</span> <span class="toc-text">解决内存泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内存泄露介绍"><span class="toc-number">4.6.1.</span> <span class="toc-text">内存泄露介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#工具介绍"><span class="toc-number">4.6.2.</span> <span class="toc-text">工具介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解决方案-1"><span class="toc-number">4.6.3.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARTHook"><span class="toc-number">4.7.</span> <span class="toc-text">ARTHook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Bitmap内存模型"><span class="toc-number">4.7.1.</span> <span class="toc-text">Bitmap内存模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式-1"><span class="toc-number">4.7.2.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ARTHook实战"><span class="toc-number">4.7.3.</span> <span class="toc-text">ARTHook实战</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">4.7.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线上内存监控方案"><span class="toc-number">4.8.</span> <span class="toc-text">线上内存监控方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式-2"><span class="toc-number">4.8.1.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeakCanary-1"><span class="toc-number">4.8.2.</span> <span class="toc-text">LeakCanary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线上监控完整方案"><span class="toc-number">4.8.3.</span> <span class="toc-text">线上监控完整方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化方向-1"><span class="toc-number">4.9.</span> <span class="toc-text">优化方向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化细节"><span class="toc-number">4.10.</span> <span class="toc-text">优化细节</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第5章-App布局优化"><span class="toc-number">5.</span> <span class="toc-text">第5章 App布局优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第6章-App卡顿优化"><span class="toc-number">6.</span> <span class="toc-text">第6章 App卡顿优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第7章-App线程优化"><span class="toc-number">7.</span> <span class="toc-text">第7章 App线程优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第8章-App网络优化"><span class="toc-number">8.</span> <span class="toc-text">第8章 App网络优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第9章-App电量优化"><span class="toc-number">9.</span> <span class="toc-text">第9章 App电量优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第10章-App瘦身优化"><span class="toc-number">10.</span> <span class="toc-text">第10章 App瘦身优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第11章-App稳定性优化"><span class="toc-number">11.</span> <span class="toc-text">第11章 App稳定性优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第12章-App专项技术优化"><span class="toc-number">12.</span> <span class="toc-text">第12章 App专项技术优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第13章-课程总结"><span class="toc-number">13.</span> <span class="toc-text">第13章 课程总结</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://coding.imooc.com/static/module/class/content/img/308/section1-2.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">K的小屋</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Top团队大牛带你玩转Android性能分析与优化</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-06-29 10:30:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-06-29</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-02 19:05:40"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-02</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">5.9k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 23 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="第1章-课程导学与学习指南"><a href="#第1章-课程导学与学习指南" class="headerlink" title="第1章 课程导学与学习指南"></a>第1章 课程导学与学习指南</h2><h2 id="第2章-App性能概览与平台化实践"><a href="#第2章-App性能概览与平台化实践" class="headerlink" title="第2章 App性能概览与平台化实践"></a>第2章 App性能概览与平台化实践</h2><h2 id="第3章-App启动优化"><a href="#第3章-App启动优化" class="headerlink" title="第3章 App启动优化"></a>第3章 App启动优化</h2><p>说在前面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">优化方向：Application和Activity生命周期</span><br></pre></td></tr></table></figure>



<h3 id="App启动分类"><a href="#App启动分类" class="headerlink" title="App启动分类"></a>App启动分类</h3><ul>
<li>冷启动</li>
<li>热启动</li>
<li>温启动</li>
</ul>
<h4 id="冷启动"><a href="#冷启动" class="headerlink" title="冷启动"></a>冷启动</h4><p>耗时最多，衡量标准：</p>
<blockquote>
<p>Click Event-&gt;IPC-&gt;Process.start-&gt;ActivityThread-&gt;bindApplication-&gt;LifeCycle-&gt;ViewRootImpl</p>
</blockquote>
<h4 id="热启动"><a href="#热启动" class="headerlink" title="热启动"></a>热启动</h4><p>最快</p>
<blockquote>
<p>后台-&gt;前台</p>
</blockquote>
<h4 id="温启动"><a href="#温启动" class="headerlink" title="温启动"></a>温启动</h4><p>较快</p>
<blockquote>
<p>LifeCycle</p>
</blockquote>
<h3 id="相关任务"><a href="#相关任务" class="headerlink" title="相关任务"></a>相关任务</h3><ul>
<li>启动之前<ul>
<li>启动App</li>
<li>加载空白Window</li>
<li>创建进程</li>
</ul>
</li>
<li>随后任务<ul>
<li>创建Application</li>
<li>启动主线程</li>
<li>创建MainActivity</li>
<li>加载布局</li>
<li>布置屏幕</li>
<li>首帧绘制</li>
</ul>
</li>
</ul>
<h3 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h3><ul>
<li>Application和Activity生命周期</li>
</ul>
<h3 id="启动时间测量方式"><a href="#启动时间测量方式" class="headerlink" title="启动时间测量方式"></a>启动时间测量方式</h3><ul>
<li>adb命令</li>
<li>手动打点</li>
</ul>
<h4 id="adb命令"><a href="#adb命令" class="headerlink" title="adb命令"></a>adb命令</h4><blockquote>
<p>adb shell am start -W packagename/首屏Activity</p>
</blockquote>
<p>如：adb shell am start -W com.github.chinesepoetry/com.github.chinesepoetry.MainActivity</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630181507.png"  alt="adb命令测量启动时间"></p>
<ul>
<li>ThisTime：最后一个Activity启动耗时</li>
<li>TotalTime：所有Activity启动耗时，由于这个App只有一个界面，所以ThisTime=TotalTime</li>
<li>WaitTime：AMS启动Activity的总耗时</li>
</ul>
<p><strong>adb命令方式总结：</strong></p>
<ol>
<li>线下使用方便，不能带到线上</li>
<li>非严谨、精确的时间统计</li>
</ol>
<h4 id="手动打点"><a href="#手动打点" class="headerlink" title="手动打点"></a>手动打点</h4><blockquote>
<p>原理：启动时埋点，启动结束埋点，二者差值</p>
</blockquote>
<p>其实就是一个工具类在对应地方进行调用，获取前后差值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LauncherTimer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> sTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sTime = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        endRecord(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endRecord</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> cost = System.currentTimeMillis() - sTime;</span><br><span class="line">        L.d(msg + <span class="string">" cost "</span> + cost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意点：<code>onWindowFocusChanged</code>只是首帧时间，这里不建议将埋点放在这里，可以放在数据回显的时候调用endRecord方法，比如如果是List则可以获取第一条数据的时候进行统计。</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630191612.png"  alt="使用ViewTree统计"></p>
<p><strong>手动打点总结：</strong></p>
<ul>
<li>精确，可带到线上，推荐使用</li>
<li>避开误区，采用Feed第一条展示</li>
<li>addOnDrawListener要求Api16</li>
</ul>
<h3 id="启动优化工具"><a href="#启动优化工具" class="headerlink" title="启动优化工具"></a>启动优化工具</h3><ul>
<li>TraceView</li>
<li>Systrace</li>
</ul>
<p>两种方式互相补充，正确认识工具及不同场景选择合适的工具</p>
<h4 id="TraceView"><a href="#TraceView" class="headerlink" title="TraceView"></a>TraceView</h4><ul>
<li>图形的形式展示执行时间、调用栈等</li>
<li>信息全面，包含所有线程</li>
<li>使用方式<ul>
<li>Debug.startMethodTracing(“”);</li>
<li>Debug.stopMethodTracing();</li>
<li>生成的文件路径：/storage/emulated/0/Android/datapackageName/files</li>
</ul>
</li>
</ul>
<p>代码实践：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">        File externalFilesDir = getExternalFilesDir(<span class="keyword">null</span>);</span><br><span class="line">        L.e(<span class="string">"getExternalFilesDir:"</span> + externalFilesDir.getAbsolutePath());</span><br><span class="line">        Debug.startMethodTracing(<span class="string">"CpApp"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">            输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">            每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">            自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">            建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String processName = AppInfoUtils.getProcessName(android.os.Process.myPid());</span><br><span class="line">        L.d(processName);</span><br><span class="line">        CrashReport.UserStrategy strategy = <span class="keyword">new</span> CrashReport.UserStrategy(<span class="keyword">this</span>);</span><br><span class="line">        strategy.setUploadProcess(processName == <span class="keyword">null</span> || processName.equals(getPackageName()));</span><br><span class="line">        CrashReport.initCrashReport(getApplicationContext(), <span class="string">"abc123"</span>, BuildConfig.DEBUG, strategy);</span><br><span class="line"></span><br><span class="line">        Debug.stopMethodTracing();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">        LauncherTimer.startRecord();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到的Trace文件分析图如下：</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630201452.png"  alt="TraceView分析图"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630201519.png"  alt="TraceView分析图"></p>
<p><strong>TraceView使用总结：</strong></p>
<ul>
<li>运行时开销严重，整体会变慢</li>
<li>可能会带偏优化方向</li>
<li>traceview与cpu profile</li>
</ul>
<h4 id="Systrace"><a href="#Systrace" class="headerlink" title="Systrace"></a>Systrace</h4><ul>
<li><p>结合Android内核数据，生成Html报告</p>
</li>
<li><p>API18以上使用，推荐TraceCompat</p>
</li>
<li><p>使用方式</p>
<ul>
<li><p>TraceCompat.beginSection(“”)</p>
</li>
<li><p>TraceCompat.endSection()</p>
</li>
<li><p>Python</p>
<blockquote>
<p>python systrace.py -t 10 [other-options] [categories]</p>
</blockquote>
</li>
<li><p>在线</p>
<ul>
<li><a href="https://developer.android.com/studio/command-line/systrace" target="_blank" rel="noopener">https://developer.android.com/studio/command-line/systrace</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python D:\develop\Android\sdk\platform-tools\systrace\systrace.py -t 20 sched gfx view wm am app webview -a &quot;packageName&quot; -o log.html</span><br><span class="line"></span><br><span class="line">如：</span><br><span class="line">python D:\develop\Android\sdk\platform-tools\systrace\systrace.py -t 20 sched gfx view wm am app webview -a com.github.chinesepoetry -o log.html</span><br></pre></td></tr></table></figure>

<p>但是这样有个问题：只支持Python 2.7</p>
<blockquote>
<p>Systrace does not support Python 3.6. Please use Python 2.7.</p>
</blockquote>
<p>可以参考：<a href="https://www.jianshu.com/p/19b3245207e8" target="_blank" rel="noopener">https://www.jianshu.com/p/19b3245207e8</a></p>
<p><strong>Systrace使用总结：</strong></p>
<ul>
<li>轻量级，开销小</li>
<li>直观反映CPU利用率</li>
<li>cpu time与wall time的区别<ul>
<li>wall time是代码执行时间</li>
<li>cpu time是代码消耗cpu的时间（重点指标）</li>
<li>举例：锁冲突</li>
</ul>
</li>
</ul>
<h3 id="获取方法执行耗时实践"><a href="#获取方法执行耗时实践" class="headerlink" title="获取方法执行耗时实践"></a>获取方法执行耗时实践</h3><h4 id="常规方式"><a href="#常规方式" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>背景：需要知道启动阶段所有方法耗时</li>
<li>实现：手动埋点<ul>
<li>long time = System.currentTimeMillis();//或者SystemClock.currentThreadTimeMillis()</li>
<li>long cost =  System.currentTimeMillis() - time;</li>
<li>将上述的时间计算要挨个放在每个启动方法的前后</li>
</ul>
</li>
<li>总结<ul>
<li>侵入性强</li>
<li>工作量大</li>
</ul>
</li>
</ul>
<h4 id="AOP方式"><a href="#AOP方式" class="headerlink" title="AOP方式"></a>AOP方式</h4><ul>
<li><p>Aspect Oriented Programming，面向切面编程</p>
<ul>
<li>针对同一类问题的统一处理</li>
<li>无侵入添加代码</li>
</ul>
</li>
<li><p>AspectJ使用（AspectJ就是用来辅助AOP的）</p>
<ul>
<li><p>classpath ‘com.hujiang.aspectjx:gradle-android-plugin-aspectjx:2.0.8’</p>
<ul>
<li><a href="https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx" target="_blank" rel="noopener">https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx</a></li>
</ul>
</li>
<li><p>implementation ‘org.aspectj:aspectjrt:1.8.13’</p>
</li>
</ul>
</li>
<li><p>总结</p>
<ul>
<li>无侵入性</li>
<li>修改方便</li>
</ul>
</li>
</ul>
<p>说明：但是我在用这种方式的时候，发现无法切Application，正常的Activity是可以获取到方法耗时的。</p>
<p>针对上面说明继续说明：后来我在Application里面sleep了3s发现可以正常aop到里面的耗时方法了</p>
<p>参考文章：<a href="https://juejin.im/post/5e0b06ab5188253a82107b32" target="_blank" rel="noopener">https://juejin.im/post/5e0b06ab5188253a82107b32</a></p>
<h3 id="优化技巧"><a href="#优化技巧" class="headerlink" title="优化技巧"></a>优化技巧</h3><ul>
<li>Theme切换：感觉上快</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701105949.png"  alt="Theme切换"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701110012.png"  alt="Theme切换"></p>
<h3 id="异步优化（常规）"><a href="#异步优化（常规）" class="headerlink" title="异步优化（常规）"></a>异步优化（常规）</h3><ul>
<li>核心思想：子线程分担主线程任务，并行减少时间</li>
<li>方式：通过线程池将诸如Bugly、Umeng、Jpush、Fresco等三方SDK的初始化工作提交给子线程执行</li>
<li>注意：针对无法在异步初始化的情况下我们就不能优化了，然后还有一种，比如在Splash页面需要用到Weex相关组件，但是Weex是在子线程初始化的，就没法保证Weex能在Splash中使用了，可以通过CountDownLatch来解决</li>
</ul>
<p>接下来演示正常初始化和异步优化的对比：</p>
<p>先看不使用异步优化的效果，这里为了效果对比我们将Bugly和Weex的初始化分别睡眠了2s和3s</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Github</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createtime</span> 2020/7/1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> Application</span></span><br><span class="line"><span class="comment"> * Bugly、Umeng统计、高德地图、Fresco、Jpush推送、Weex、Stetho...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyApplication mApplication;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="keyword">int</span> CORE_POOL_SIZE = Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mApplication = <span class="keyword">this</span>;</span><br><span class="line">        LauncherTimer.startRecord();</span><br><span class="line">        ExecutorService service = Executors.newFixedThreadPool(CORE_POOL_SIZE);<span class="comment">//建议使用ThreadPoolExecutors创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">        <span class="comment">//File externalFilesDir = getExternalFilesDir(null);</span></span><br><span class="line">        <span class="comment">//L.e("getExternalFilesDir:" + externalFilesDir.getAbsolutePath());</span></span><br><span class="line">        <span class="comment">//Debug.startMethodTracing("CpApp");</span></span><br><span class="line">        <span class="comment">//TraceCompat.beginSection("CpApp2");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Bugly</span></span><br><span class="line"><span class="comment">            为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">            输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">            每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">            自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">            建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initBugly();</span><br><span class="line">        <span class="comment">/*service.submit(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                initBugly();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Fresco</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Fresco.initialize(mApplication);</span><br><span class="line">        <span class="comment">/*service.submit(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                Fresco.initialize(mApplication);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Umeng初始化SDK</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initUmeng();</span><br><span class="line">        <span class="comment">/*service.submit(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                initUmeng();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        initWeex();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">        <span class="comment">//TraceCompat.endSection();</span></span><br><span class="line">        LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initUmeng</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UMConfigure.init(mApplication, <span class="string">"xxid"</span>, <span class="string">"Umeng"</span>, UMConfigure.DEVICE_TYPE_PHONE, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 选用MANUAL页面采集模式</span></span><br><span class="line">        MobclickAgent.setPageCollectionMode(MobclickAgent.PageMode.AUTO);</span><br><span class="line">        <span class="comment">// 打开统计SDK调试模式</span></span><br><span class="line">        UMConfigure.setLogEnabled(BuildConfig.DEBUG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//LauncherTimer.startRecord();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟初始化Weex</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWeex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化Bugly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBugly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        String processName = AppInfoUtils.getProcessName(android.os.Process.myPid());</span><br><span class="line">        <span class="comment">//L.d(processName);</span></span><br><span class="line">        CrashReport.UserStrategy strategy = <span class="keyword">new</span> CrashReport.UserStrategy(mApplication);</span><br><span class="line">        strategy.setUploadProcess(processName == <span class="keyword">null</span> || processName.equals(getPackageName()));</span><br><span class="line">        CrashReport.initCrashReport(getApplicationContext(), <span class="string">"xxid"</span>, BuildConfig.DEBUG, strategy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: MyApplication.initBugly() aop_cost 2146<br>===&gt;: MyApplication.initUmeng() aop_cost 116<br>===&gt;: MyApplication.initWeex() aop_cost 3000<br>===&gt;: Application启动时间 cost 5312<br>===&gt;: MainActivity.request(..) aop_cost 23<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}</p>
</blockquote>
<p>可以发现耗时为5s，同时MainActivity里面的请求是在Application初始化之后才执行的。</p>
<p>那么，接下来我们通过线程池进行异步初始化看效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    mApplication = <span class="keyword">this</span>;</span><br><span class="line">    LauncherTimer.startRecord();</span><br><span class="line">    ExecutorService service = Executors.newFixedThreadPool(CORE_POOL_SIZE);<span class="comment">//建议使用ThreadPoolExecutors创建</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">    <span class="comment">//File externalFilesDir = getExternalFilesDir(null);</span></span><br><span class="line">    <span class="comment">//L.e("getExternalFilesDir:" + externalFilesDir.getAbsolutePath());</span></span><br><span class="line">    <span class="comment">//Debug.startMethodTracing("CpApp");</span></span><br><span class="line">    <span class="comment">//TraceCompat.beginSection("CpApp2");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Bugly</span></span><br><span class="line"><span class="comment">        为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">        输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">        每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">        自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">        建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//initBugly();</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            initBugly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Fresco</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//Fresco.initialize(mApplication);</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Fresco.initialize(mApplication);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Umeng初始化SDK</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//initUmeng();</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            initUmeng();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//initWeex();</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            initWeex();</span><br><span class="line">            <span class="comment">//mCountDownLatch.countDown();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">    <span class="comment">//TraceCompat.endSection();</span></span><br><span class="line">    <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">        mCountDownLatch.await();</span></span><br><span class="line"><span class="comment">    &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">        e.printStackTrace();</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: Application启动时间 cost 3<br>===&gt;: MainActivity.request(..) aop_cost 37<br>===&gt;: MyApplication.initUmeng() aop_cost 177<br>===&gt;: MyApplication.access$200(..) aop_cost 177<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}</p>
<p>===&gt;: MyApplication.initBugly() aop_cost 2075<br>===&gt;: MyApplication.access$000(..) aop_cost 2075<br>===&gt;: MyApplication.initWeex() aop_cost 3003<br>===&gt;: MyApplication.access$300(..) aop_cost 3003</p>
</blockquote>
<p>可以发现 Application启动时间 cost 3毫秒,同时MainActivity已经加载好了，并发送了请求。</p>
<p><strong>特殊场景：</strong></p>
<p>但假如有如下场景就比如Weex的初始化完成要在SplashActivity或MainActivity加载之前加载，那么我们应该如何操作呢？方案是使用CountDownLatch。</p>
<p>这里我们模拟要求initWeex初始化完毕之后才能调用MainActivity的request请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">   ...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate();</span><br><span class="line">       mApplication = <span class="keyword">this</span>;</span><br><span class="line">       LauncherTimer.startRecord();</span><br><span class="line">       ExecutorService service = Executors.newFixedThreadPool(CORE_POOL_SIZE);<span class="comment">//建议使用ThreadPoolExecutors创建</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">       <span class="comment">//File externalFilesDir = getExternalFilesDir(null);</span></span><br><span class="line">       <span class="comment">//L.e("getExternalFilesDir:" + externalFilesDir.getAbsolutePath());</span></span><br><span class="line">       <span class="comment">//Debug.startMethodTracing("CpApp");</span></span><br><span class="line">       <span class="comment">//TraceCompat.beginSection("CpApp2");</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Bugly</span></span><br><span class="line"><span class="comment">           为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">           输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">           每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">           自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">           建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//initBugly();</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               initBugly();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Fresco</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//Fresco.initialize(mApplication);</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               Fresco.initialize(mApplication);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Umeng初始化SDK</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//initUmeng();</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               initUmeng();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//initWeex();</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               initWeex();</span><br><span class="line">               mCountDownLatch.countDown();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">       <span class="comment">//TraceCompat.endSection();</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           mCountDownLatch.await();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: MyApplication.initUmeng() aop_cost 97<br>===&gt;: MyApplication.access$200(..) aop_cost 97<br>===&gt;: MyApplication.initBugly() aop_cost 2076<br>===&gt;: MyApplication.access$000(..) aop_cost 2076<br>===&gt;: MyApplication.initWeex() aop_cost 3001<br>===&gt;: MyApplication.access$300(..) aop_cost 3003<br>===&gt;: Application启动时间 cost 3120<br>===&gt;: MainActivity.request(..) aop_cost 20<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}</p>
</blockquote>
<p>通过日志发现，Application执行时间为3s，即为Weex的初始化时间，且当Application初始化Weex之后，MainActivity的request请求才会发出。</p>
<p>补充：假如Umeng初始化需要10s，我们看下日志输出，我们大概猜测因为umeng初始化是放在子线程当中的，日志输出顺序应该为 Application.initWeex–MainActivity.request-Application.initUmeng</p>
<blockquote>
<p>===&gt;: MyApplication.initBugly() aop_cost 2138<br>===&gt;: MyApplication.access$000(..) aop_cost 2138<br>===&gt;: MyApplication.<strong>initWeex</strong>() aop_cost 3001<br>===&gt;: MyApplication.access$300(..) aop_cost 3001<br>===&gt;: Application启动时间 cost 5141<br>===&gt;: MainActivity.<strong>request</strong>(..) aop_cost 22<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}<br>===&gt;: MyApplication.<strong>initUmeng</strong>() aop_cost 10075<br>===&gt;: MyApplication.access$200(..) aop_cost 10075</p>
</blockquote>
<p><strong>异步优化注意事项</strong></p>
<ul>
<li>不符合异步要求的要认真判断一下</li>
<li>需要在某阶段完成</li>
<li>区分CPU密集和IO密集型任务</li>
</ul>
<h3 id="异步初始化（最优解）"><a href="#异步初始化（最优解）" class="headerlink" title="异步初始化（最优解）"></a>异步初始化（最优解）</h3><h4 id="常规异步痛点"><a href="#常规异步痛点" class="headerlink" title="常规异步痛点"></a>常规异步痛点</h4><ul>
<li>代码不优雅</li>
<li>场景不好处理（依赖关系）</li>
<li>维护成本高</li>
</ul>
<h4 id="启动器实现异步初始化"><a href="#启动器实现异步初始化" class="headerlink" title="启动器实现异步初始化"></a>启动器实现异步初始化</h4><ul>
<li>启动器介绍<ul>
<li>核心思想：充分利用CPU多核，自动梳理任务顺序</li>
<li>启动器流程<ul>
<li>代码Task化，启动逻辑抽象为Task</li>
<li>根据所有任务依赖关系排序生成一个<strong>有向无环图（拓扑图）</strong></li>
<li>多线程按照排序后的优先级依次执行</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701140502.png"  alt="启动器流程图"></p>
<p><strong>代码实践</strong></p>
<p>涉及到的类有：TaskDispatcher、ITask、Task、TaskSortUtil、DispatcherRunnable</p>
<blockquote>
<p>代码后续贴出</p>
</blockquote>
<h3 id="延迟初始化"><a href="#延迟初始化" class="headerlink" title="延迟初始化"></a>延迟初始化</h3><h4 id="常规方案"><a href="#常规方案" class="headerlink" title="常规方案"></a>常规方案</h4><ul>
<li>new Handler().postDelayed</li>
<li>Feed展示后调用</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701141226.png"  alt="常规方案"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701141320.png"  alt="常规方案"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701141341.png"  alt="常规方案"></p>
<p><strong>常规方案总结：</strong></p>
<ul>
<li>时机不变控制</li>
<li>导致Feed卡顿</li>
</ul>
<h4 id="更优方案"><a href="#更优方案" class="headerlink" title="更优方案"></a>更优方案</h4><ul>
<li>核心思想：对延迟任务进行分批初始化<ul>
<li>利用IdleHandler特性，空闲执行</li>
</ul>
</li>
</ul>
<p>涉及到的类：DelayInitDispatcher</p>
<p>代码后续贴出</p>
<p>更优方案总结：</p>
<ul>
<li>执行时机明确</li>
<li>缓解Feed卡顿</li>
</ul>
<h3 id="本章总结"><a href="#本章总结" class="headerlink" title="本章总结"></a>本章总结</h3><h4 id="获取方法耗时"><a href="#获取方法耗时" class="headerlink" title="获取方法耗时"></a>获取方法耗时</h4><ul>
<li>常规方案</li>
<li>AOP</li>
<li>wall time 与 cpu time区别</li>
</ul>
<h4 id="优化总方针"><a href="#优化总方针" class="headerlink" title="优化总方针"></a>优化总方针</h4><ul>
<li>异步、延迟、懒加载</li>
<li>技术、业务相结合</li>
</ul>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>wall time与cpu time<ul>
<li>cpu time才是优化方向</li>
<li>按照systrace及cpu time跑满cpu</li>
</ul>
</li>
<li>监控的完善<ul>
<li>线上监控多阶段时间（App、Activity、生命周期间隔时间）</li>
<li>处理聚合看趋势</li>
</ul>
</li>
<li>收敛启动代码修改权限<ul>
<li>结合Ci修改启动代码需要Review或通知</li>
</ul>
</li>
</ul>
<h4 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h4><ul>
<li>提前加载SharedPreferences<ul>
<li>Multidex之前加载，利用此阶段的CPU</li>
<li>复写getApplicationContext()返回this</li>
</ul>
</li>
<li>启动阶段不启动子线程<ul>
<li>子线程会共享CPU资源，导致主线程CPU紧张</li>
<li>注意启动顺序：App OnCreate之前是ContentProvider</li>
</ul>
</li>
<li>类加载优化：提前异步类加载<ul>
<li>Class.forName() 只加载类本身及其静态变量的引用类</li>
<li>new 类实例可以额外加载类成员变量的引用类</li>
</ul>
</li>
<li>启动阶段抑制GC</li>
<li>CPU锁频</li>
</ul>
<h2 id="第4章-App内存优化"><a href="#第4章-App内存优化" class="headerlink" title="第4章 App内存优化"></a>第4章 App内存优化</h2><h3 id="内存优化介绍"><a href="#内存优化介绍" class="headerlink" title="内存优化介绍"></a>内存优化介绍</h3><h4 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h4><ul>
<li>内存抖动：锯齿状、GC导致卡顿</li>
<li>内存泄露：可用内存减少、频繁GC</li>
<li>内存溢出：OOM、程序异常</li>
</ul>
<h3 id="优化工具选择"><a href="#优化工具选择" class="headerlink" title="优化工具选择"></a>优化工具选择</h3><ul>
<li>Memory Profiler</li>
<li>Memory Analyzer</li>
<li>LeakCanary</li>
</ul>
<h4 id="Memory-Profiler"><a href="#Memory-Profiler" class="headerlink" title="Memory Profiler"></a>Memory Profiler</h4><ul>
<li>实时图标展示内存使用量</li>
<li>识别内存泄露、抖动等</li>
<li>提供捕获堆转储、强制GC以及跟踪内存分配的能力</li>
<li>方便直观</li>
<li>线下平时使用</li>
</ul>
<h4 id="Memory-Analyzer"><a href="#Memory-Analyzer" class="headerlink" title="Memory Analyzer"></a>Memory Analyzer</h4><ul>
<li>强大的Java Heap分析工具，查找内存泄露以及内存占用</li>
<li>生成整体报告、分析问题等</li>
<li>线下深入使用</li>
</ul>
<h4 id="LeakCanary"><a href="#LeakCanary" class="headerlink" title="LeakCanary"></a>LeakCanary</h4><ul>
<li>自动内存泄露监测</li>
<li>github:<a href="https://github.com/square/leakcanary" target="_blank" rel="noopener">https://github.com/square/leakcanary</a></li>
<li>线下集成</li>
</ul>
<h3 id="Java内存管理机制"><a href="#Java内存管理机制" class="headerlink" title="Java内存管理机制"></a>Java内存管理机制</h3><h4 id="Java内存分配"><a href="#Java内存分配" class="headerlink" title="Java内存分配"></a>Java内存分配</h4><p>java当中运行时数据区包含：方法区、堆、虚拟机栈、PC计数器、本地方法区</p>
<h4 id="Java内存回收算法"><a href="#Java内存回收算法" class="headerlink" title="Java内存回收算法"></a>Java内存回收算法</h4><ul>
<li><p>标记-清除算法</p>
<ul>
<li>标记出所有需要回收的对象（这样说不严谨，已经是标记可达的节点）</li>
<li>统一回收所有被标记的对象</li>
<li>标记和清除效率不高</li>
<li>产生大量不连续的内存碎片</li>
</ul>
</li>
</ul>
<ul>
<li><p>复制算法</p>
<ul>
<li>将内存划分为大小相等的两块</li>
<li>一块内存用完之后复制存活对象到另一块</li>
<li>清理另一块内存</li>
<li>实现简单，运行高效</li>
<li>浪费一半空间，代价大</li>
</ul>
</li>
</ul>
<ul>
<li><p>标记-整理算法</p>
<ul>
<li>标记过程与“标记-清除”算法一样</li>
<li>存活对象往一端进行移动</li>
<li>清理其余内存</li>
<li>避免了“标记-清理”导致的内存碎片</li>
<li>避免了“复制算法”的空间浪费</li>
</ul>
</li>
</ul>
<ul>
<li><p>分代手机算法</p>
<ul>
<li>结合多种收集算法优势</li>
<li>新生代对象存活率低，复制</li>
<li>老年代对象存活率搞，标记-整理</li>
</ul>
</li>
</ul>
<h3 id="Android内存管理机制"><a href="#Android内存管理机制" class="headerlink" title="Android内存管理机制"></a>Android内存管理机制</h3><ul>
<li>内存弹性分配，分配值与最大值受具体设备影响</li>
<li>OOM场景：内存真正不足、可用内存不足</li>
<li>Dalvik与Art区别<ul>
<li>Dalvik仅仅固定一种回收算法</li>
<li>Art回收算法可运行期选择</li>
<li>Art具备内存整理能力，减少内存空洞</li>
<li>Art是在5.0之后推出来的，当应用在前台的时候会时候标记-清除算法，在后台的时候会使用标记-整理算法</li>
</ul>
</li>
<li>Low Memory Killer<ul>
<li>进程分类（前台、可见、后台、空进程）</li>
<li>回收收益</li>
</ul>
</li>
</ul>
<h3 id="解决内存抖动"><a href="#解决内存抖动" class="headerlink" title="解决内存抖动"></a>解决内存抖动</h3><h4 id="什么是内存抖动"><a href="#什么是内存抖动" class="headerlink" title="什么是内存抖动"></a>什么是内存抖动</h4><ul>
<li>定义：内存频繁分配和回收导致内存不稳定</li>
<li>表现：频繁GC、内存曲线呈锯齿状</li>
<li>危害：导致卡顿、OOM</li>
</ul>
<p><strong>内存抖动导致OOM</strong></p>
<ul>
<li>频繁创建对象，导致内存不足及碎片（不连续）</li>
<li>不连续的内存片无法被分配，导致OOM</li>
</ul>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li>使用Memory Profiler初步排查</li>
<li>使用Memory Profiler或CPU Profiler结合代码排查</li>
<li>找出循环或者频繁调用的地方</li>
</ul>
<p>模拟内存抖动的场景：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryShakeActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(@NonNull Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//创造内存抖动</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                String arg[] = <span class="keyword">new</span> String[<span class="number">100000</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.sendEmptyMessageDelayed(<span class="number">0</span>, <span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHandler.sendEmptyMessageDelayed(<span class="number">0</span>, <span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_main;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702155328.png"  alt="内存抖动-Memory Profiler"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702155923.png"  alt="内存抖动-Memory Profiler"></p>
<h3 id="解决内存泄露"><a href="#解决内存泄露" class="headerlink" title="解决内存泄露"></a>解决内存泄露</h3><h4 id="内存泄露介绍"><a href="#内存泄露介绍" class="headerlink" title="内存泄露介绍"></a>内存泄露介绍</h4><ul>
<li>定义：内存中存在已久没有用的对象</li>
<li>表现：内存抖动、可用内存逐渐变少</li>
<li>危害：内存不足、GC频繁、OOM</li>
</ul>
<h4 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h4><ul>
<li>Memory Analyer<ul>
<li><a href="https://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">https://www.eclipse.org/mat/downloads.php</a></li>
<li>转换命令：hprof-conv 原文件路径 转换后文件路径</li>
</ul>
</li>
</ul>
<p>模拟内存泄露场景：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLeakActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ImageView imageView = findViewById(R.id.image);</span><br><span class="line">        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.cat);</span><br><span class="line">        imageView.setImageBitmap(bitmap);</span><br><span class="line">        CallbackManager.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_memory_leak;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Callback&gt; sCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">        sCallbacks.add(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">        sCallbacks.remove(callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>操作：通过MainActivity反复的进入/退出此页面MemoryLeakActivity，通过CPU Profiler工具我们可以看到内存一直在增加，通过手动gc也是无法回收的。</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702161945.png"  alt="GC也无法回收内存"></p>
<p>通过界面的<code>Dump Java Heap</code>的操作，我们得到一个文件<code>memory-20200702T162306.hprof</code>，然后通过D:\develop\Android\sdk\platform-tools 自带的hprof-conv.exe工具进行转化：</p>
<blockquote>
<p>hprof-conv C:\Users\Desktop\memory-20200702T162306.hprof C:\Users\Desktop\memory-20200702T162306_trans.hprof</p>
</blockquote>
<p>将转化后的文件<code>memory-20200702T162306_trans.hprof</code>使用MAT工具进行分析：</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163210.png"  alt="MAT工具"></p>
<p>右键-List Objects-with outgoing reference</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163459.png"  alt="MAT工具"></p>
<p>右键-Path To GC Roots-with all references</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163646.png"  alt="MAT工具"></p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p>找到问题原因，那么解决方案就是在Activity销毁的时候调用remove方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLeakActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ImageView imageView = findViewById(R.id.image);</span><br><span class="line">        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.cat);</span><br><span class="line">        imageView.setImageBitmap(bitmap);</span><br><span class="line">        CallbackManager.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_memory_leak;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        CallbackManager.remove(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163924.png"  alt="解决内存泄露问题"></p>
<p><strong>小结：</strong></p>
<ul>
<li>使用Memory Profiler初步观察</li>
<li>通过Memory Analyzer结合确认</li>
</ul>
<h3 id="ARTHook"><a href="#ARTHook" class="headerlink" title="ARTHook"></a>ARTHook</h3><h4 id="Bitmap内存模型"><a href="#Bitmap内存模型" class="headerlink" title="Bitmap内存模型"></a>Bitmap内存模型</h4><ul>
<li>API 10之前Bitmap自身在Dalvik Heap中，像素在Native中</li>
<li>API 10之后像素也被放在了Dalvik Heap中</li>
<li>API 26之后像素在Native</li>
<li>获取Bitmap占用内存<ul>
<li>getByteCount</li>
<li>宽 * 高 * 一像素占用内存数量（如果图片放在了res目录下面，则计算的时候需要乘以一个压缩比例）</li>
</ul>
</li>
</ul>
<h4 id="常规方式-1"><a href="#常规方式-1" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>背景：图片对内存优化至关重要、图片宽高大于控件宽高</li>
<li>实现：继承ImageView，覆盖实现计算大小</li>
<li>分析<ul>
<li>侵入性强</li>
<li>不通用</li>
</ul>
</li>
</ul>
<h4 id="ARTHook实战"><a href="#ARTHook实战" class="headerlink" title="ARTHook实战"></a>ARTHook实战</h4><p><strong>ARTHook介绍</strong></p>
<ul>
<li>挂钩，将额外的代码钩住原有方法，修改执行逻辑<ul>
<li>运行时插桩</li>
<li>性能分析</li>
</ul>
</li>
</ul>
<p><strong>Epic简介</strong></p>
<blockquote>
<p>Epic 是一个在虚拟机层面、以 Java Method 为粒度的 <strong>运行时</strong> AOP Hook 框架。简单来说，Epic 就是 ART 上的 <a href="https://github.com/alibaba/dexposed" target="_blank" rel="noopener">Dexposed</a>（支持 Android 4.0 ~ 10.0）。它可以拦截本进程内部几乎任意的 Java 方法调用，可用于实现 AOP 编程、运行时插桩、性能分析、安全审计等。</p>
<p>Epic 被 <a href="https://github.com/android-hacker/VirtualXposed" target="_blank" rel="noopener">VirtualXposed</a> 以及 <a href="https://www.coolapk.com/apk/me.weishu.exp" target="_blank" rel="noopener">太极</a> 使用，用来实现非 Root 场景下的 Xposed 功能，已经经过了相当广泛的验证。</p>
</blockquote>
<ul>
<li>Epic是一个虚拟机层面，以Java Method为粒度的运行时Hook框架</li>
<li>支持Android 4.0——10.0</li>
<li><a href="https://github.com/tiann/epic" target="_blank" rel="noopener">https://github.com/tiann/epic</a></li>
<li>Epic使用<ul>
<li>implementation ‘me.weishu:epic:1.0.0’,在Android 8.0真机上面测试没问题</li>
<li>继承XC_MethodHook，实现相应逻辑</li>
<li>注入Hook：DexposedBridge.findAndHookMethod</li>
</ul>
</li>
</ul>
<p>代码实践：</p>
<p>图片cat的真实尺寸：w:1000,h:709</p>
<p>布局文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"memoryLeak"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"模拟内存泄露"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/image"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"120dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"20dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/image2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"20dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ImageHook代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageHook</span> <span class="keyword">extends</span> <span class="title">XC_MethodHook</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">        <span class="comment">//实现我们自己的逻辑</span></span><br><span class="line">        ImageView imageView = (ImageView) param.thisObject;</span><br><span class="line">        checkBitmap(imageView, imageView.getDrawable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkBitmap</span><span class="params">(Object object, Drawable drawable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> BitmapDrawable &amp;&amp; object <span class="keyword">instanceof</span> View) &#123;</span><br><span class="line">            <span class="keyword">final</span> Bitmap bitmap = ((BitmapDrawable) drawable).getBitmap();</span><br><span class="line">            <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> View view = (View) object;</span><br><span class="line">                <span class="keyword">int</span> w = view.getWidth();</span><br><span class="line">                <span class="keyword">int</span> h = view.getHeight();</span><br><span class="line">                <span class="comment">//要判断宽高是否大于0，表示控件已经绘制完成了</span></span><br><span class="line">                <span class="keyword">if</span> (w &gt; <span class="number">0</span> &amp;&amp; h &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果宽高都大于view的2倍以上，则警告</span></span><br><span class="line">                    <span class="keyword">if</span> (bitmap.getWidth() &gt;= (w &lt;&lt; <span class="number">1</span>) &amp;&amp; bitmap.getHeight() &gt;= (h &lt;&lt; <span class="number">1</span>)) &#123;</span><br><span class="line">                        warn(bitmap.getWidth(), bitmap.getHeight(), w, h);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//RuntimeException stackTrace = new RuntimeException();</span></span><br><span class="line">                    view.getViewTreeObserver().addOnPreDrawListener(<span class="keyword">new</span> ViewTreeObserver.OnPreDrawListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">int</span> w = view.getWidth();</span><br><span class="line">                            <span class="keyword">int</span> h = view.getHeight();</span><br><span class="line">                            L.d(<span class="string">"w:"</span> + w + <span class="string">",h:"</span> + h);</span><br><span class="line">                            L.d(<span class="string">"b.w:"</span> + bitmap.getWidth() + <span class="string">",b.h:"</span> + bitmap.getHeight());</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (bitmap.getWidth() &gt;= (w &lt;&lt; <span class="number">1</span>) &amp;&amp; bitmap.getHeight() &gt;= (h &lt;&lt; <span class="number">1</span>)) &#123;</span><br><span class="line">                                warn(bitmap.getWidth(), bitmap.getHeight(), w, h);</span><br><span class="line">                            &#125;</span><br><span class="line">                            view.getViewTreeObserver().removeOnPreDrawListener(<span class="keyword">this</span>);</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">        String warnInfo = <span class="keyword">new</span> StringBuilder(<span class="string">"Bitmap size too large:"</span>)</span><br><span class="line">                .append(<span class="string">"  real size:("</span>).append(width).append(<span class="string">","</span>).append(height).append(<span class="string">")"</span>)</span><br><span class="line">                .append(<span class="string">"  desired size:("</span>).append(w).append(<span class="string">","</span>).append(h).append(<span class="string">")"</span>)</span><br><span class="line">                .append(<span class="string">"  call stack trace:"</span>)</span><br><span class="line">                <span class="comment">//.append(Log.getStackTraceString())</span></span><br><span class="line">                .toString();</span><br><span class="line"></span><br><span class="line">        L.w(warnInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在Activity或者Application里面进行Hook操作，这里我们选择在Application里面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyApplication mApplication;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mApplication = <span class="keyword">this</span>;</span><br><span class="line">        LauncherTimer.startRecord();</span><br><span class="line">        <span class="comment">/*TaskDispatcher.init(this);</span></span><br><span class="line"><span class="comment">        TaskDispatcher.createInstance()</span></span><br><span class="line"><span class="comment">                .addTask(new InitBuglyTask())</span></span><br><span class="line"><span class="comment">                .addTask(new InitUmengTask())</span></span><br><span class="line"><span class="comment">                .addTask(new InitFrescoTask())</span></span><br><span class="line"><span class="comment">                .addTask(new InitFrescoTask())</span></span><br><span class="line"><span class="comment">                .start();*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用ARTHook,Epic对图片加载进行监测,可以在Application注入也可以在Activity注入</span></span><br><span class="line">        DexposedBridge.hookAllConstructors(ImageView<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">XC_MethodHook</span>() </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">                DexposedBridge.findAndHookMethod(ImageView.class, "setImageBitmap", Bitmap.class, new ImageHook());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//LauncherTimer.startRecord();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行代码，看日志输出：</p>
<blockquote>
<p>===&gt;: w:360,h:300<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: Bitmap size too large:  real size:(1000,709)  desired size:(360,300)  call stack trace:<br>===&gt;: w:360,h:300<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: Bitmap size too large:  real size:(1000,709)  desired size:(360,300)  call stack trace:</p>
<p>===&gt;: w:1000,h:709<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: w:1000,h:709<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: w:1000,h:709<br>===&gt;: b.w:1000,b.h:709</p>
</blockquote>
<p>首先可以发现方法被重复调用了多次，其次被限定了大小尺寸显示的ImageView已经输出了warn信息，而warp_content的ImageView确没有输出warn信息。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>ARTHook无侵入性</li>
<li>通用性强</li>
<li>兼容问题大，开源方案不能带到线上环境</li>
</ul>
<h3 id="线上内存监控方案"><a href="#线上内存监控方案" class="headerlink" title="线上内存监控方案"></a>线上内存监控方案</h3><h4 id="常规方式-2"><a href="#常规方式-2" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>方式一：设定场景上Dump：Debug.dumpHprofData()<ul>
<li>实现流程：超过最大内存80%–&gt;内存Dum–&gt;回传文件–&gt;MAT手动分析</li>
<li>问题：Dump文件太大，和对象数正相关，可裁剪；上传失败率高、分析困难</li>
</ul>
</li>
<li>方式二：LeanCanary带到线上<ul>
<li>预设泄露怀疑点</li>
<li>发现泄露回传</li>
<li>总结：不适合所有情况，必须预设怀疑点；分析比较耗时、也容易OOM</li>
</ul>
</li>
</ul>
<h4 id="LeakCanary-1"><a href="#LeakCanary-1" class="headerlink" title="LeakCanary"></a>LeakCanary</h4><p><strong>原理</strong></p>
<ul>
<li>监控生命周期，onDestory添加RefWatcher监测</li>
<li>二次确认断定发生内存泄露</li>
<li>分析泄露，找引用链</li>
<li>监控组件+分析组件</li>
</ul>
<p><strong>定制</strong></p>
<ul>
<li>预设怀疑点——》自动找怀疑点</li>
<li>分析泄露链路——》分析Retain size大的对象</li>
<li>分析OOM——》对象裁剪，不全部加载到内存</li>
</ul>
<h4 id="线上监控完整方案"><a href="#线上监控完整方案" class="headerlink" title="线上监控完整方案"></a>线上监控完整方案</h4><ul>
<li>待机内存、重点模块内存、OOM率</li>
<li>整体及重点模块GC次数、GC时间</li>
<li>增强的LeakCanary自动化内存泄露分析</li>
</ul>
<h3 id="优化方向-1"><a href="#优化方向-1" class="headerlink" title="优化方向"></a>优化方向</h3><ul>
<li>内存泄露</li>
<li>内存抖动</li>
<li>Bitmap</li>
</ul>
<h3 id="优化细节"><a href="#优化细节" class="headerlink" title="优化细节"></a>优化细节</h3><ul>
<li>LargeHeap属性</li>
<li>onTrimMemory</li>
<li>使用优化过的集合：SparseArray</li>
<li>谨慎使用SharedPreference</li>
<li>谨慎使用外部库</li>
<li>业务架构设计合理</li>
</ul>
<h2 id="第5章-App布局优化"><a href="#第5章-App布局优化" class="headerlink" title="第5章 App布局优化"></a>第5章 App布局优化</h2><p>this.</p>
<h2 id="第6章-App卡顿优化"><a href="#第6章-App卡顿优化" class="headerlink" title="第6章 App卡顿优化"></a>第6章 App卡顿优化</h2><h2 id="第7章-App线程优化"><a href="#第7章-App线程优化" class="headerlink" title="第7章 App线程优化"></a>第7章 App线程优化</h2><h2 id="第8章-App网络优化"><a href="#第8章-App网络优化" class="headerlink" title="第8章 App网络优化"></a>第8章 App网络优化</h2><h2 id="第9章-App电量优化"><a href="#第9章-App电量优化" class="headerlink" title="第9章 App电量优化"></a>第9章 App电量优化</h2><h2 id="第10章-App瘦身优化"><a href="#第10章-App瘦身优化" class="headerlink" title="第10章 App瘦身优化"></a>第10章 App瘦身优化</h2><h2 id="第11章-App稳定性优化"><a href="#第11章-App稳定性优化" class="headerlink" title="第11章 App稳定性优化"></a>第11章 App稳定性优化</h2><h2 id="第12章-App专项技术优化"><a href="#第12章-App专项技术优化" class="headerlink" title="第12章 App专项技术优化"></a>第12章 App专项技术优化</h2><h2 id="第13章-课程总结"><a href="#第13章-课程总结" class="headerlink" title="第13章 课程总结"></a>第13章 课程总结</h2><p><strong>END.</strong></p>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></div><div class="post_share"><div class="social-share" data-image="https://coding.imooc.com/static/module/class/content/img/308/section1-2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/06/25/Ubuntu18.04%E7%BC%96%E8%AF%91%E5%AE%89%E5%8D%93/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ubuntu18.04编译安卓</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/05/25/Android源码分析——Dagger2（未完）/" title="Android源码分析——Dagger2（未完）"><img class="relatedPosts_cover lazyload"data-src="https://img.cniao5.com/o_1b3rl8h6mk8d162i1i0p1ha6p989.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-25</div><div class="relatedPosts_title">Android源码分析——Dagger2（未完）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/18/Android源码分析——Retrofit/" title="Android源码分析——Retrofit"><img class="relatedPosts_cover lazyload"data-src="https://img.cniao5.com/o_1avp1uvsgh7irrvv158jn7mf9.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-18</div><div class="relatedPosts_title">Android源码分析——Retrofit</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/21/Android源码分析——Glide/" title="Android源码分析——Glide"><img class="relatedPosts_cover lazyload"data-src="http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-21</div><div class="relatedPosts_title">Android源码分析——Glide</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/21/博文地址推荐/" title="博文地址推荐"><img class="relatedPosts_cover lazyload"data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591889554697&di=6cd48317171455e6e367313f3430a2e2&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180717%2Fab8a30734c7f45ad847ca089864e25e4.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-21</div><div class="relatedPosts_title">博文地址推荐</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/13/开发技能汇总/" title="开发技能汇总"><img class="relatedPosts_cover lazyload"data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1589358596541&di=ec2608777052785cb20f0d366f2d82b7&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20170830%2F544fed872efd40a5acf7ebcec0067fc1.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-13</div><div class="relatedPosts_title">开发技能汇总</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/25/Android源码分析——EventBus/" title="Android源码分析——EventBus"><img class="relatedPosts_cover lazyload"data-src="https://img-blog.csdnimg.cn/20181208105518324.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-25</div><div class="relatedPosts_title">Android源码分析——EventBus</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Kai</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>