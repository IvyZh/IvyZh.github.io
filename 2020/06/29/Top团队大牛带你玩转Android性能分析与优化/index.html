<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Top团队大牛带你玩转Android性能分析与优化 | K的小屋</title><meta name="description" content="Top团队大牛带你玩转Android性能分析与优化"><meta name="keywords" content="Android,性能优化"><meta name="author" content="Kai"><meta name="copyright" content="Kai"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Top团队大牛带你玩转Android性能分析与优化"><meta name="twitter:description" content="Top团队大牛带你玩转Android性能分析与优化"><meta name="twitter:image" content="https://coding.imooc.com/static/module/class/content/img/308/section1-2.png"><meta property="og:type" content="article"><meta property="og:title" content="Top团队大牛带你玩转Android性能分析与优化"><meta property="og:url" content="https://www.google.com/2020/06/29/Top%E5%9B%A2%E9%98%9F%E5%A4%A7%E7%89%9B%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACAndroid%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96/"><meta property="og:site_name" content="K的小屋"><meta property="og:description" content="Top团队大牛带你玩转Android性能分析与优化"><meta property="og:image" content="https://coding.imooc.com/static/module/class/content/img/308/section1-2.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.google.com/2020/06/29/Top%E5%9B%A2%E9%98%9F%E5%A4%A7%E7%89%9B%E5%B8%A6%E4%BD%A0%E7%8E%A9%E8%BD%ACAndroid%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96/"><link rel="prev" title="股票基础知识学习（一）.md" href="https://www.google.com/2020/07/04/%E8%82%A1%E7%A5%A8%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/"><link rel="next" title="Ubuntu18.04编译安卓" href="https://www.google.com/2020/06/25/Ubuntu18.04%E7%BC%96%E8%AF%91%E5%AE%89%E5%8D%93/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">25</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">13</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#第1章-课程导学与学习指南"><span class="toc-number">1.</span> <span class="toc-text">第1章 课程导学与学习指南</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第2章-App性能概览与平台化实践"><span class="toc-number">2.</span> <span class="toc-text">第2章 App性能概览与平台化实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第3章-App启动优化"><span class="toc-number">3.</span> <span class="toc-text">第3章 App启动优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#App启动分类"><span class="toc-number">3.1.</span> <span class="toc-text">App启动分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#冷启动"><span class="toc-number">3.1.1.</span> <span class="toc-text">冷启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#热启动"><span class="toc-number">3.1.2.</span> <span class="toc-text">热启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#温启动"><span class="toc-number">3.1.3.</span> <span class="toc-text">温启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#相关任务"><span class="toc-number">3.2.</span> <span class="toc-text">相关任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化方向"><span class="toc-number">3.3.</span> <span class="toc-text">优化方向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动时间测量方式"><span class="toc-number">3.4.</span> <span class="toc-text">启动时间测量方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#adb命令"><span class="toc-number">3.4.1.</span> <span class="toc-text">adb命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手动打点"><span class="toc-number">3.4.2.</span> <span class="toc-text">手动打点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动优化工具"><span class="toc-number">3.5.</span> <span class="toc-text">启动优化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TraceView"><span class="toc-number">3.5.1.</span> <span class="toc-text">TraceView</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Systrace-未实践"><span class="toc-number">3.5.2.</span> <span class="toc-text">Systrace[未实践]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取方法执行耗时实践"><span class="toc-number">3.6.</span> <span class="toc-text">获取方法执行耗时实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式"><span class="toc-number">3.6.1.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP方式"><span class="toc-number">3.6.2.</span> <span class="toc-text">AOP方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化技巧"><span class="toc-number">3.7.</span> <span class="toc-text">优化技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步优化（常规）"><span class="toc-number">3.8.</span> <span class="toc-text">异步优化（常规）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步初始化（最优解）"><span class="toc-number">3.9.</span> <span class="toc-text">异步初始化（最优解）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规异步痛点"><span class="toc-number">3.9.1.</span> <span class="toc-text">常规异步痛点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动器实现异步初始化"><span class="toc-number">3.9.2.</span> <span class="toc-text">启动器实现异步初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#延迟初始化"><span class="toc-number">3.10.</span> <span class="toc-text">延迟初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方案"><span class="toc-number">3.10.1.</span> <span class="toc-text">常规方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更优方案"><span class="toc-number">3.10.2.</span> <span class="toc-text">更优方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本章总结"><span class="toc-number">3.11.</span> <span class="toc-text">本章总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取方法耗时"><span class="toc-number">3.11.1.</span> <span class="toc-text">获取方法耗时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化总方针"><span class="toc-number">3.11.2.</span> <span class="toc-text">优化总方针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注意事项"><span class="toc-number">3.11.3.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他方案"><span class="toc-number">3.11.4.</span> <span class="toc-text">其他方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第4章-App内存优化"><span class="toc-number">4.</span> <span class="toc-text">第4章 App内存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#内存优化介绍"><span class="toc-number">4.1.</span> <span class="toc-text">内存优化介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内存问题"><span class="toc-number">4.1.1.</span> <span class="toc-text">内存问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化工具选择"><span class="toc-number">4.2.</span> <span class="toc-text">优化工具选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Memory-Profiler"><span class="toc-number">4.2.1.</span> <span class="toc-text">Memory Profiler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memory-Analyzer"><span class="toc-number">4.2.2.</span> <span class="toc-text">Memory Analyzer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeakCanary"><span class="toc-number">4.2.3.</span> <span class="toc-text">LeakCanary</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java内存管理机制"><span class="toc-number">4.3.</span> <span class="toc-text">Java内存管理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Java内存分配"><span class="toc-number">4.3.1.</span> <span class="toc-text">Java内存分配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java内存回收算法"><span class="toc-number">4.3.2.</span> <span class="toc-text">Java内存回收算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Android内存管理机制"><span class="toc-number">4.4.</span> <span class="toc-text">Android内存管理机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决内存抖动"><span class="toc-number">4.5.</span> <span class="toc-text">解决内存抖动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是内存抖动"><span class="toc-number">4.5.1.</span> <span class="toc-text">什么是内存抖动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解决方案"><span class="toc-number">4.5.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决内存泄露"><span class="toc-number">4.6.</span> <span class="toc-text">解决内存泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内存泄露介绍"><span class="toc-number">4.6.1.</span> <span class="toc-text">内存泄露介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#工具介绍"><span class="toc-number">4.6.2.</span> <span class="toc-text">工具介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解决方案-1"><span class="toc-number">4.6.3.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARTHook"><span class="toc-number">4.7.</span> <span class="toc-text">ARTHook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Bitmap内存模型"><span class="toc-number">4.7.1.</span> <span class="toc-text">Bitmap内存模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式-1"><span class="toc-number">4.7.2.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ARTHook实战"><span class="toc-number">4.7.3.</span> <span class="toc-text">ARTHook实战</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">4.7.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线上内存监控方案"><span class="toc-number">4.8.</span> <span class="toc-text">线上内存监控方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式-2"><span class="toc-number">4.8.1.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LeakCanary-1"><span class="toc-number">4.8.2.</span> <span class="toc-text">LeakCanary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线上监控完整方案"><span class="toc-number">4.8.3.</span> <span class="toc-text">线上监控完整方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化方向-1"><span class="toc-number">4.9.</span> <span class="toc-text">优化方向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化细节"><span class="toc-number">4.10.</span> <span class="toc-text">优化细节</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第5章-App布局优化"><span class="toc-number">5.</span> <span class="toc-text">第5章 App布局优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#绘制和布局加载原理"><span class="toc-number">5.1.</span> <span class="toc-text">绘制和布局加载原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#绘制"><span class="toc-number">5.1.1.</span> <span class="toc-text">绘制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加载"><span class="toc-number">5.1.2.</span> <span class="toc-text">加载</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取界面布局耗时"><span class="toc-number">5.2.</span> <span class="toc-text">获取界面布局耗时</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#常规方式-3"><span class="toc-number">5.2.1.</span> <span class="toc-text">常规方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP-ARTHook"><span class="toc-number">5.2.2.</span> <span class="toc-text">AOP&#x2F;ARTHook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取任一控件耗时"><span class="toc-number">5.2.3.</span> <span class="toc-text">获取任一控件耗时</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异步Inflate"><span class="toc-number">5.3.</span> <span class="toc-text">异步Inflate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#背景介绍"><span class="toc-number">5.3.1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AsyncLayoutInflater实战"><span class="toc-number">5.3.2.</span> <span class="toc-text">AsyncLayoutInflater实战</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#布局加载优化实践"><span class="toc-number">5.4.</span> <span class="toc-text">布局加载优化实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#背景介绍-1"><span class="toc-number">5.4.1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java代码写布局"><span class="toc-number">5.4.2.</span> <span class="toc-text">Java代码写布局</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X2C介绍（未实现，有问题）"><span class="toc-number">5.4.3.</span> <span class="toc-text">X2C介绍（未实现，有问题）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#视图绘制优化实战"><span class="toc-number">5.5.</span> <span class="toc-text">视图绘制优化实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#优化布局层级及复杂度"><span class="toc-number">5.5.1.</span> <span class="toc-text">优化布局层级及复杂度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#避免过度绘制"><span class="toc-number">5.5.2.</span> <span class="toc-text">避免过度绘制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第6章-App卡顿优化"><span class="toc-number">6.</span> <span class="toc-text">第6章 App卡顿优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#卡顿优化工具"><span class="toc-number">6.1.</span> <span class="toc-text">卡顿优化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU-Profiler"><span class="toc-number">6.1.1.</span> <span class="toc-text">CPU Profiler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Systrace（需要Python2-7配合）"><span class="toc-number">6.1.2.</span> <span class="toc-text">Systrace（需要Python2.7配合）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StrictMode（没有预期输出）"><span class="toc-number">6.1.3.</span> <span class="toc-text">StrictMode（没有预期输出）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动化检测方案"><span class="toc-number">6.2.</span> <span class="toc-text">自动化检测方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方案原理"><span class="toc-number">6.2.1.</span> <span class="toc-text">方案原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#具体实现"><span class="toc-number">6.2.2.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AndroidPerformanceMonitor"><span class="toc-number">6.2.3.</span> <span class="toc-text">AndroidPerformanceMonitor</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ANR分析与实战"><span class="toc-number">6.3.</span> <span class="toc-text">ANR分析与实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ANR介绍"><span class="toc-number">6.3.1.</span> <span class="toc-text">ANR介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线上ANR监控方案"><span class="toc-number">6.3.2.</span> <span class="toc-text">线上ANR监控方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ANR-WatchDog"><span class="toc-number">6.3.3.</span> <span class="toc-text">ANR-WatchDog</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#卡顿单点问题检查方案"><span class="toc-number">6.4.</span> <span class="toc-text">卡顿单点问题检查方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#背景"><span class="toc-number">6.4.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPC问题检测"><span class="toc-number">6.4.2.</span> <span class="toc-text">IPC问题检测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#界面秒开实现"><span class="toc-number">6.5.</span> <span class="toc-text">界面秒开实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lancet"><span class="toc-number">6.5.1.</span> <span class="toc-text">Lancet</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优雅监控耗时盲区（略）"><span class="toc-number">6.6.</span> <span class="toc-text">优雅监控耗时盲区（略）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第7章-App线程优化"><span class="toc-number">7.</span> <span class="toc-text">第7章 App线程优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第8章-App网络优化"><span class="toc-number">8.</span> <span class="toc-text">第8章 App网络优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第9章-App电量优化"><span class="toc-number">9.</span> <span class="toc-text">第9章 App电量优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第10章-App瘦身优化"><span class="toc-number">10.</span> <span class="toc-text">第10章 App瘦身优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第11章-App稳定性优化"><span class="toc-number">11.</span> <span class="toc-text">第11章 App稳定性优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第12章-App专项技术优化"><span class="toc-number">12.</span> <span class="toc-text">第12章 App专项技术优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第13章-课程总结"><span class="toc-number">13.</span> <span class="toc-text">第13章 课程总结</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://coding.imooc.com/static/module/class/content/img/308/section1-2.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">K的小屋</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Top团队大牛带你玩转Android性能分析与优化</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-06-29 10:30:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-06-29</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-06 15:00:52"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-06</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">10.8k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 47 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="第1章-课程导学与学习指南"><a href="#第1章-课程导学与学习指南" class="headerlink" title="第1章 课程导学与学习指南"></a>第1章 课程导学与学习指南</h2><h2 id="第2章-App性能概览与平台化实践"><a href="#第2章-App性能概览与平台化实践" class="headerlink" title="第2章 App性能概览与平台化实践"></a>第2章 App性能概览与平台化实践</h2><h2 id="第3章-App启动优化"><a href="#第3章-App启动优化" class="headerlink" title="第3章 App启动优化"></a>第3章 App启动优化</h2><p>说在前面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">优化方向：Application和Activity生命周期</span><br></pre></td></tr></table></figure>



<h3 id="App启动分类"><a href="#App启动分类" class="headerlink" title="App启动分类"></a>App启动分类</h3><ul>
<li>冷启动</li>
<li>热启动</li>
<li>温启动</li>
</ul>
<h4 id="冷启动"><a href="#冷启动" class="headerlink" title="冷启动"></a>冷启动</h4><p>耗时最多，衡量标准：</p>
<blockquote>
<p>Click Event-&gt;IPC-&gt;Process.start-&gt;ActivityThread-&gt;bindApplication-&gt;LifeCycle-&gt;ViewRootImpl</p>
</blockquote>
<h4 id="热启动"><a href="#热启动" class="headerlink" title="热启动"></a>热启动</h4><p>最快</p>
<blockquote>
<p>后台-&gt;前台</p>
</blockquote>
<h4 id="温启动"><a href="#温启动" class="headerlink" title="温启动"></a>温启动</h4><p>较快</p>
<blockquote>
<p>LifeCycle</p>
</blockquote>
<h3 id="相关任务"><a href="#相关任务" class="headerlink" title="相关任务"></a>相关任务</h3><ul>
<li>启动之前<ul>
<li>启动App</li>
<li>加载空白Window</li>
<li>创建进程</li>
</ul>
</li>
<li>随后任务<ul>
<li>创建Application</li>
<li>启动主线程</li>
<li>创建MainActivity</li>
<li>加载布局</li>
<li>布置屏幕</li>
<li>首帧绘制</li>
</ul>
</li>
</ul>
<h3 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h3><ul>
<li>Application和Activity生命周期</li>
</ul>
<h3 id="启动时间测量方式"><a href="#启动时间测量方式" class="headerlink" title="启动时间测量方式"></a>启动时间测量方式</h3><ul>
<li>adb命令</li>
<li>手动打点</li>
</ul>
<h4 id="adb命令"><a href="#adb命令" class="headerlink" title="adb命令"></a>adb命令</h4><blockquote>
<p>adb shell am start -W packagename/首屏Activity</p>
</blockquote>
<p>如：adb shell am start -W com.github.chinesepoetry/com.github.chinesepoetry.MainActivity</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630181507.png"  alt="adb命令测量启动时间"></p>
<ul>
<li>ThisTime：最后一个Activity启动耗时</li>
<li>TotalTime：所有Activity启动耗时，由于这个App只有一个界面，所以ThisTime=TotalTime</li>
<li>WaitTime：AMS启动Activity的总耗时</li>
</ul>
<p><strong>adb命令方式总结：</strong></p>
<ol>
<li>线下使用方便，不能带到线上</li>
<li>非严谨、精确的时间统计</li>
</ol>
<h4 id="手动打点"><a href="#手动打点" class="headerlink" title="手动打点"></a>手动打点</h4><blockquote>
<p>原理：启动时埋点，启动结束埋点，二者差值</p>
</blockquote>
<p>其实就是一个工具类在对应地方进行调用，获取前后差值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LauncherTimer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> sTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sTime = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        endRecord(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endRecord</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> cost = System.currentTimeMillis() - sTime;</span><br><span class="line">        L.d(msg + <span class="string">" cost "</span> + cost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意点：<code>onWindowFocusChanged</code>只是首帧时间，这里不建议将埋点放在这里，可以放在数据回显的时候调用endRecord方法，比如如果是List则可以获取第一条数据的时候进行统计。</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630191612.png"  alt="使用ViewTree统计"></p>
<p><strong>手动打点总结：</strong></p>
<ul>
<li>精确，可带到线上，推荐使用</li>
<li>避开误区，采用Feed第一条展示</li>
<li>addOnDrawListener要求Api16</li>
</ul>
<h3 id="启动优化工具"><a href="#启动优化工具" class="headerlink" title="启动优化工具"></a>启动优化工具</h3><ul>
<li>TraceView</li>
<li>Systrace</li>
</ul>
<p>两种方式互相补充，正确认识工具及不同场景选择合适的工具</p>
<h4 id="TraceView"><a href="#TraceView" class="headerlink" title="TraceView"></a>TraceView</h4><ul>
<li>图形的形式展示执行时间、调用栈等</li>
<li>信息全面，包含所有线程</li>
<li>使用方式<ul>
<li>Debug.startMethodTracing(“”);</li>
<li>Debug.stopMethodTracing();</li>
<li>生成的文件路径：/storage/emulated/0/Android/datapackageName/files</li>
</ul>
</li>
</ul>
<p>代码实践：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">        File externalFilesDir = getExternalFilesDir(<span class="keyword">null</span>);</span><br><span class="line">        L.e(<span class="string">"getExternalFilesDir:"</span> + externalFilesDir.getAbsolutePath());</span><br><span class="line">        Debug.startMethodTracing(<span class="string">"CpApp"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">            输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">            每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">            自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">            建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String processName = AppInfoUtils.getProcessName(android.os.Process.myPid());</span><br><span class="line">        L.d(processName);</span><br><span class="line">        CrashReport.UserStrategy strategy = <span class="keyword">new</span> CrashReport.UserStrategy(<span class="keyword">this</span>);</span><br><span class="line">        strategy.setUploadProcess(processName == <span class="keyword">null</span> || processName.equals(getPackageName()));</span><br><span class="line">        CrashReport.initCrashReport(getApplicationContext(), <span class="string">"abc123"</span>, BuildConfig.DEBUG, strategy);</span><br><span class="line"></span><br><span class="line">        Debug.stopMethodTracing();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">        LauncherTimer.startRecord();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到的Trace文件分析图如下：</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630201452.png"  alt="TraceView分析图"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200630201519.png"  alt="TraceView分析图"></p>
<p><strong>TraceView使用总结：</strong></p>
<ul>
<li>运行时开销严重，整体会变慢</li>
<li>可能会带偏优化方向</li>
<li>traceview与cpu profile</li>
</ul>
<h4 id="Systrace-未实践"><a href="#Systrace-未实践" class="headerlink" title="Systrace[未实践]"></a>Systrace[未实践]</h4><ul>
<li><p>结合Android内核数据，生成Html报告</p>
</li>
<li><p>API18以上使用，推荐TraceCompat</p>
</li>
<li><p>使用方式</p>
<ul>
<li><p>TraceCompat.beginSection(“”)</p>
</li>
<li><p>TraceCompat.endSection()</p>
</li>
<li><p>Python</p>
<blockquote>
<p>python systrace.py -t 10 [other-options] [categories]</p>
</blockquote>
</li>
<li><p>在线</p>
<ul>
<li><a href="https://developer.android.com/studio/command-line/systrace" target="_blank" rel="noopener">https://developer.android.com/studio/command-line/systrace</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python D:\develop\Android\sdk\platform-tools\systrace\systrace.py -t 20 sched gfx view wm am app webview -a &quot;packageName&quot; -o log.html</span><br><span class="line"></span><br><span class="line">如：</span><br><span class="line">python D:\develop\Android\sdk\platform-tools\systrace\systrace.py -t 20 sched gfx view wm am app webview -a com.github.chinesepoetry -o log.html</span><br></pre></td></tr></table></figure>

<p>但是这样有个问题：只支持Python 2.7</p>
<blockquote>
<p>Systrace does not support Python 3.6. Please use Python 2.7.</p>
</blockquote>
<p>可以参考：<a href="https://www.jianshu.com/p/19b3245207e8" target="_blank" rel="noopener">https://www.jianshu.com/p/19b3245207e8</a></p>
<p><strong>Systrace使用总结：</strong></p>
<ul>
<li>轻量级，开销小</li>
<li>直观反映CPU利用率</li>
<li>cpu time与wall time的区别<ul>
<li>wall time是代码执行时间</li>
<li>cpu time是代码消耗cpu的时间（重点指标）</li>
<li>举例：锁冲突</li>
</ul>
</li>
</ul>
<h3 id="获取方法执行耗时实践"><a href="#获取方法执行耗时实践" class="headerlink" title="获取方法执行耗时实践"></a>获取方法执行耗时实践</h3><h4 id="常规方式"><a href="#常规方式" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>背景：需要知道启动阶段所有方法耗时</li>
<li>实现：手动埋点<ul>
<li>long time = System.currentTimeMillis();//或者SystemClock.currentThreadTimeMillis()</li>
<li>long cost =  System.currentTimeMillis() - time;</li>
<li>将上述的时间计算要挨个放在每个启动方法的前后</li>
</ul>
</li>
<li>总结<ul>
<li>侵入性强</li>
<li>工作量大</li>
</ul>
</li>
</ul>
<h4 id="AOP方式"><a href="#AOP方式" class="headerlink" title="AOP方式"></a>AOP方式</h4><ul>
<li><p>Aspect Oriented Programming，面向切面编程</p>
<ul>
<li>针对同一类问题的统一处理</li>
<li>无侵入添加代码</li>
</ul>
</li>
<li><p>AspectJ使用（AspectJ就是用来辅助AOP的）</p>
<ul>
<li><p>classpath ‘com.hujiang.aspectjx:gradle-android-plugin-aspectjx:2.0.8’</p>
<ul>
<li><a href="https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx" target="_blank" rel="noopener">https://github.com/HujiangTechnology/gradle_plugin_android_aspectjx</a></li>
</ul>
</li>
<li><p>implementation ‘org.aspectj:aspectjrt:1.8.13’</p>
</li>
</ul>
</li>
<li><p>总结</p>
<ul>
<li>无侵入性</li>
<li>修改方便</li>
</ul>
</li>
</ul>
<p>说明：但是我在用这种方式的时候，发现无法切Application，正常的Activity是可以获取到方法耗时的。</p>
<p>针对上面说明继续说明：后来我在Application里面sleep了3s发现可以正常aop到里面的耗时方法了</p>
<p>参考文章：<a href="https://juejin.im/post/5e0b06ab5188253a82107b32" target="_blank" rel="noopener">https://juejin.im/post/5e0b06ab5188253a82107b32</a></p>
<h3 id="优化技巧"><a href="#优化技巧" class="headerlink" title="优化技巧"></a>优化技巧</h3><ul>
<li>Theme切换：感觉上快</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701105949.png"  alt="Theme切换"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701110012.png"  alt="Theme切换"></p>
<h3 id="异步优化（常规）"><a href="#异步优化（常规）" class="headerlink" title="异步优化（常规）"></a>异步优化（常规）</h3><ul>
<li>核心思想：子线程分担主线程任务，并行减少时间</li>
<li>方式：通过线程池将诸如Bugly、Umeng、Jpush、Fresco等三方SDK的初始化工作提交给子线程执行</li>
<li>注意：针对无法在异步初始化的情况下我们就不能优化了，然后还有一种，比如在Splash页面需要用到Weex相关组件，但是Weex是在子线程初始化的，就没法保证Weex能在Splash中使用了，可以通过CountDownLatch来解决</li>
</ul>
<p>接下来演示正常初始化和异步优化的对比：</p>
<p>先看不使用异步优化的效果，这里为了效果对比我们将Bugly和Weex的初始化分别睡眠了2s和3s</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Github</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createtime</span> 2020/7/1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> Application</span></span><br><span class="line"><span class="comment"> * Bugly、Umeng统计、高德地图、Fresco、Jpush推送、Weex、Stetho...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyApplication mApplication;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> CPU_COUNT = Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="keyword">int</span> CORE_POOL_SIZE = Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mApplication = <span class="keyword">this</span>;</span><br><span class="line">        LauncherTimer.startRecord();</span><br><span class="line">        ExecutorService service = Executors.newFixedThreadPool(CORE_POOL_SIZE);<span class="comment">//建议使用ThreadPoolExecutors创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">        <span class="comment">//File externalFilesDir = getExternalFilesDir(null);</span></span><br><span class="line">        <span class="comment">//L.e("getExternalFilesDir:" + externalFilesDir.getAbsolutePath());</span></span><br><span class="line">        <span class="comment">//Debug.startMethodTracing("CpApp");</span></span><br><span class="line">        <span class="comment">//TraceCompat.beginSection("CpApp2");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Bugly</span></span><br><span class="line"><span class="comment">            为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">            输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">            每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">            自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">            建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initBugly();</span><br><span class="line">        <span class="comment">/*service.submit(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                initBugly();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Fresco</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Fresco.initialize(mApplication);</span><br><span class="line">        <span class="comment">/*service.submit(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                Fresco.initialize(mApplication);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Umeng初始化SDK</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        initUmeng();</span><br><span class="line">        <span class="comment">/*service.submit(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void run() &#123;</span></span><br><span class="line"><span class="comment">                initUmeng();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line"></span><br><span class="line">        initWeex();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">        <span class="comment">//TraceCompat.endSection();</span></span><br><span class="line">        LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initUmeng</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UMConfigure.init(mApplication, <span class="string">"xxid"</span>, <span class="string">"Umeng"</span>, UMConfigure.DEVICE_TYPE_PHONE, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 选用MANUAL页面采集模式</span></span><br><span class="line">        MobclickAgent.setPageCollectionMode(MobclickAgent.PageMode.AUTO);</span><br><span class="line">        <span class="comment">// 打开统计SDK调试模式</span></span><br><span class="line">        UMConfigure.setLogEnabled(BuildConfig.DEBUG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//LauncherTimer.startRecord();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟初始化Weex</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWeex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化Bugly</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBugly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        String processName = AppInfoUtils.getProcessName(android.os.Process.myPid());</span><br><span class="line">        <span class="comment">//L.d(processName);</span></span><br><span class="line">        CrashReport.UserStrategy strategy = <span class="keyword">new</span> CrashReport.UserStrategy(mApplication);</span><br><span class="line">        strategy.setUploadProcess(processName == <span class="keyword">null</span> || processName.equals(getPackageName()));</span><br><span class="line">        CrashReport.initCrashReport(getApplicationContext(), <span class="string">"xxid"</span>, BuildConfig.DEBUG, strategy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: MyApplication.initBugly() aop_cost 2146<br>===&gt;: MyApplication.initUmeng() aop_cost 116<br>===&gt;: MyApplication.initWeex() aop_cost 3000<br>===&gt;: Application启动时间 cost 5312<br>===&gt;: MainActivity.request(..) aop_cost 23<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}</p>
</blockquote>
<p>可以发现耗时为5s，同时MainActivity里面的请求是在Application初始化之后才执行的。</p>
<p>那么，接下来我们通过线程池进行异步初始化看效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    mApplication = <span class="keyword">this</span>;</span><br><span class="line">    LauncherTimer.startRecord();</span><br><span class="line">    ExecutorService service = Executors.newFixedThreadPool(CORE_POOL_SIZE);<span class="comment">//建议使用ThreadPoolExecutors创建</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">    <span class="comment">//File externalFilesDir = getExternalFilesDir(null);</span></span><br><span class="line">    <span class="comment">//L.e("getExternalFilesDir:" + externalFilesDir.getAbsolutePath());</span></span><br><span class="line">    <span class="comment">//Debug.startMethodTracing("CpApp");</span></span><br><span class="line">    <span class="comment">//TraceCompat.beginSection("CpApp2");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Bugly</span></span><br><span class="line"><span class="comment">        为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">        输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">        每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">        自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">        建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//initBugly();</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            initBugly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Fresco</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//Fresco.initialize(mApplication);</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Fresco.initialize(mApplication);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Umeng初始化SDK</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//initUmeng();</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            initUmeng();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//initWeex();</span></span><br><span class="line">    service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            initWeex();</span><br><span class="line">            <span class="comment">//mCountDownLatch.countDown();</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">    <span class="comment">//TraceCompat.endSection();</span></span><br><span class="line">    <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">        mCountDownLatch.await();</span></span><br><span class="line"><span class="comment">    &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">        e.printStackTrace();</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: Application启动时间 cost 3<br>===&gt;: MainActivity.request(..) aop_cost 37<br>===&gt;: MyApplication.initUmeng() aop_cost 177<br>===&gt;: MyApplication.access$200(..) aop_cost 177<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}</p>
<p>===&gt;: MyApplication.initBugly() aop_cost 2075<br>===&gt;: MyApplication.access$000(..) aop_cost 2075<br>===&gt;: MyApplication.initWeex() aop_cost 3003<br>===&gt;: MyApplication.access$300(..) aop_cost 3003</p>
</blockquote>
<p>可以发现 Application启动时间 cost 3毫秒,同时MainActivity已经加载好了，并发送了请求。</p>
<p><strong>特殊场景：</strong></p>
<p>但假如有如下场景就比如Weex的初始化完成要在SplashActivity或MainActivity加载之前加载，那么我们应该如何操作呢？方案是使用CountDownLatch。</p>
<p>这里我们模拟要求initWeex初始化完毕之后才能调用MainActivity的request请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">   ...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate();</span><br><span class="line">       mApplication = <span class="keyword">this</span>;</span><br><span class="line">       LauncherTimer.startRecord();</span><br><span class="line">       ExecutorService service = Executors.newFixedThreadPool(CORE_POOL_SIZE);<span class="comment">//建议使用ThreadPoolExecutors创建</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//存放位置/storage/emulated/0/Android/data/com.github.chinesepoetry/files</span></span><br><span class="line">       <span class="comment">//File externalFilesDir = getExternalFilesDir(null);</span></span><br><span class="line">       <span class="comment">//L.e("getExternalFilesDir:" + externalFilesDir.getAbsolutePath());</span></span><br><span class="line">       <span class="comment">//Debug.startMethodTracing("CpApp");</span></span><br><span class="line">       <span class="comment">//TraceCompat.beginSection("CpApp2");</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Bugly</span></span><br><span class="line"><span class="comment">           为了保证运营数据的准确性，建议不要在异步线程初始化Bugly</span></span><br><span class="line"><span class="comment">           输出详细的Bugly SDK的Log；</span></span><br><span class="line"><span class="comment">           每一条Crash都会被立即上报；</span></span><br><span class="line"><span class="comment">           自定义日志将会在Logcat中输出。</span></span><br><span class="line"><span class="comment">           建议在测试阶段建议设置成true，发布时设置为false。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//initBugly();</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               initBugly();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Fresco</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//Fresco.initialize(mApplication);</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               Fresco.initialize(mApplication);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Umeng初始化SDK</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//initUmeng();</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               initUmeng();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//initWeex();</span></span><br><span class="line">       service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               initWeex();</span><br><span class="line">               mCountDownLatch.countDown();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">       <span class="comment">//TraceCompat.endSection();</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           mCountDownLatch.await();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: MyApplication.initUmeng() aop_cost 97<br>===&gt;: MyApplication.access$200(..) aop_cost 97<br>===&gt;: MyApplication.initBugly() aop_cost 2076<br>===&gt;: MyApplication.access$000(..) aop_cost 2076<br>===&gt;: MyApplication.initWeex() aop_cost 3001<br>===&gt;: MyApplication.access$300(..) aop_cost 3003<br>===&gt;: Application启动时间 cost 3120<br>===&gt;: MainActivity.request(..) aop_cost 20<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}</p>
</blockquote>
<p>通过日志发现，Application执行时间为3s，即为Weex的初始化时间，且当Application初始化Weex之后，MainActivity的request请求才会发出。</p>
<p>补充：假如Umeng初始化需要10s，我们看下日志输出，我们大概猜测因为umeng初始化是放在子线程当中的，日志输出顺序应该为 Application.initWeex–MainActivity.request-Application.initUmeng</p>
<blockquote>
<p>===&gt;: MyApplication.initBugly() aop_cost 2138<br>===&gt;: MyApplication.access$000(..) aop_cost 2138<br>===&gt;: MyApplication.<strong>initWeex</strong>() aop_cost 3001<br>===&gt;: MyApplication.access$300(..) aop_cost 3001<br>===&gt;: Application启动时间 cost 5141<br>===&gt;: MainActivity.<strong>request</strong>(..) aop_cost 22<br>===&gt;: 结果：WeatherModel{status=101, message=’AK参数不存在’}<br>===&gt;: MyApplication.<strong>initUmeng</strong>() aop_cost 10075<br>===&gt;: MyApplication.access$200(..) aop_cost 10075</p>
</blockquote>
<p><strong>异步优化注意事项</strong></p>
<ul>
<li>不符合异步要求的要认真判断一下</li>
<li>需要在某阶段完成</li>
<li>区分CPU密集和IO密集型任务</li>
</ul>
<h3 id="异步初始化（最优解）"><a href="#异步初始化（最优解）" class="headerlink" title="异步初始化（最优解）"></a>异步初始化（最优解）</h3><h4 id="常规异步痛点"><a href="#常规异步痛点" class="headerlink" title="常规异步痛点"></a>常规异步痛点</h4><ul>
<li>代码不优雅</li>
<li>场景不好处理（依赖关系）</li>
<li>维护成本高</li>
</ul>
<h4 id="启动器实现异步初始化"><a href="#启动器实现异步初始化" class="headerlink" title="启动器实现异步初始化"></a>启动器实现异步初始化</h4><ul>
<li>启动器介绍<ul>
<li>核心思想：充分利用CPU多核，自动梳理任务顺序</li>
<li>启动器流程<ul>
<li>代码Task化，启动逻辑抽象为Task</li>
<li>根据所有任务依赖关系排序生成一个<strong>有向无环图（拓扑图）</strong></li>
<li>多线程按照排序后的优先级依次执行</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701140502.png"  alt="启动器流程图"></p>
<p><strong>代码实践</strong></p>
<p>涉及到的类有：TaskDispatcher、ITask、Task、TaskSortUtil、DispatcherRunnable</p>
<blockquote>
<p>代码后续贴出</p>
</blockquote>
<h3 id="延迟初始化"><a href="#延迟初始化" class="headerlink" title="延迟初始化"></a>延迟初始化</h3><h4 id="常规方案"><a href="#常规方案" class="headerlink" title="常规方案"></a>常规方案</h4><ul>
<li>new Handler().postDelayed</li>
<li>Feed展示后调用</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701141226.png"  alt="常规方案"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701141320.png"  alt="常规方案"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200701141341.png"  alt="常规方案"></p>
<p><strong>常规方案总结：</strong></p>
<ul>
<li>时机不变控制</li>
<li>导致Feed卡顿</li>
</ul>
<h4 id="更优方案"><a href="#更优方案" class="headerlink" title="更优方案"></a>更优方案</h4><ul>
<li>核心思想：对延迟任务进行分批初始化<ul>
<li>利用IdleHandler特性，空闲执行</li>
</ul>
</li>
</ul>
<p>涉及到的类：DelayInitDispatcher</p>
<p>代码后续贴出</p>
<p>更优方案总结：</p>
<ul>
<li>执行时机明确</li>
<li>缓解Feed卡顿</li>
</ul>
<h3 id="本章总结"><a href="#本章总结" class="headerlink" title="本章总结"></a>本章总结</h3><h4 id="获取方法耗时"><a href="#获取方法耗时" class="headerlink" title="获取方法耗时"></a>获取方法耗时</h4><ul>
<li>常规方案</li>
<li>AOP</li>
<li>wall time 与 cpu time区别</li>
</ul>
<h4 id="优化总方针"><a href="#优化总方针" class="headerlink" title="优化总方针"></a>优化总方针</h4><ul>
<li>异步、延迟、懒加载</li>
<li>技术、业务相结合</li>
</ul>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>wall time与cpu time<ul>
<li>cpu time才是优化方向</li>
<li>按照systrace及cpu time跑满cpu</li>
</ul>
</li>
<li>监控的完善<ul>
<li>线上监控多阶段时间（App、Activity、生命周期间隔时间）</li>
<li>处理聚合看趋势</li>
</ul>
</li>
<li>收敛启动代码修改权限<ul>
<li>结合Ci修改启动代码需要Review或通知</li>
</ul>
</li>
</ul>
<h4 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h4><ul>
<li>提前加载SharedPreferences<ul>
<li>Multidex之前加载，利用此阶段的CPU</li>
<li>复写getApplicationContext()返回this</li>
</ul>
</li>
<li>启动阶段不启动子线程<ul>
<li>子线程会共享CPU资源，导致主线程CPU紧张</li>
<li>注意启动顺序：App OnCreate之前是ContentProvider</li>
</ul>
</li>
<li>类加载优化：提前异步类加载<ul>
<li>Class.forName() 只加载类本身及其静态变量的引用类</li>
<li>new 类实例可以额外加载类成员变量的引用类</li>
</ul>
</li>
<li>启动阶段抑制GC</li>
<li>CPU锁频</li>
</ul>
<h2 id="第4章-App内存优化"><a href="#第4章-App内存优化" class="headerlink" title="第4章 App内存优化"></a>第4章 App内存优化</h2><h3 id="内存优化介绍"><a href="#内存优化介绍" class="headerlink" title="内存优化介绍"></a>内存优化介绍</h3><h4 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h4><ul>
<li>内存抖动：锯齿状、GC导致卡顿</li>
<li>内存泄露：可用内存减少、频繁GC</li>
<li>内存溢出：OOM、程序异常</li>
</ul>
<h3 id="优化工具选择"><a href="#优化工具选择" class="headerlink" title="优化工具选择"></a>优化工具选择</h3><ul>
<li>Memory Profiler</li>
<li>Memory Analyzer</li>
<li>LeakCanary</li>
</ul>
<h4 id="Memory-Profiler"><a href="#Memory-Profiler" class="headerlink" title="Memory Profiler"></a>Memory Profiler</h4><ul>
<li>实时图标展示内存使用量</li>
<li>识别内存泄露、抖动等</li>
<li>提供捕获堆转储、强制GC以及跟踪内存分配的能力</li>
<li>方便直观</li>
<li>线下平时使用</li>
</ul>
<h4 id="Memory-Analyzer"><a href="#Memory-Analyzer" class="headerlink" title="Memory Analyzer"></a>Memory Analyzer</h4><ul>
<li>强大的Java Heap分析工具，查找内存泄露以及内存占用</li>
<li>生成整体报告、分析问题等</li>
<li>线下深入使用</li>
</ul>
<h4 id="LeakCanary"><a href="#LeakCanary" class="headerlink" title="LeakCanary"></a>LeakCanary</h4><ul>
<li>自动内存泄露监测</li>
<li>github:<a href="https://github.com/square/leakcanary" target="_blank" rel="noopener">https://github.com/square/leakcanary</a></li>
<li>线下集成</li>
</ul>
<h3 id="Java内存管理机制"><a href="#Java内存管理机制" class="headerlink" title="Java内存管理机制"></a>Java内存管理机制</h3><h4 id="Java内存分配"><a href="#Java内存分配" class="headerlink" title="Java内存分配"></a>Java内存分配</h4><p>java当中运行时数据区包含：方法区、堆、虚拟机栈、PC计数器、本地方法区</p>
<h4 id="Java内存回收算法"><a href="#Java内存回收算法" class="headerlink" title="Java内存回收算法"></a>Java内存回收算法</h4><ul>
<li><p>标记-清除算法</p>
<ul>
<li>标记出所有需要回收的对象（这样说不严谨，已经是标记可达的节点）</li>
<li>统一回收所有被标记的对象</li>
<li>标记和清除效率不高</li>
<li>产生大量不连续的内存碎片</li>
</ul>
</li>
</ul>
<ul>
<li><p>复制算法</p>
<ul>
<li>将内存划分为大小相等的两块</li>
<li>一块内存用完之后复制存活对象到另一块</li>
<li>清理另一块内存</li>
<li>实现简单，运行高效</li>
<li>浪费一半空间，代价大</li>
</ul>
</li>
</ul>
<ul>
<li><p>标记-整理算法</p>
<ul>
<li>标记过程与“标记-清除”算法一样</li>
<li>存活对象往一端进行移动</li>
<li>清理其余内存</li>
<li>避免了“标记-清理”导致的内存碎片</li>
<li>避免了“复制算法”的空间浪费</li>
</ul>
</li>
</ul>
<ul>
<li><p>分代手机算法</p>
<ul>
<li>结合多种收集算法优势</li>
<li>新生代对象存活率低，复制</li>
<li>老年代对象存活率搞，标记-整理</li>
</ul>
</li>
</ul>
<h3 id="Android内存管理机制"><a href="#Android内存管理机制" class="headerlink" title="Android内存管理机制"></a>Android内存管理机制</h3><ul>
<li>内存弹性分配，分配值与最大值受具体设备影响</li>
<li>OOM场景：内存真正不足、可用内存不足</li>
<li>Dalvik与Art区别<ul>
<li>Dalvik仅仅固定一种回收算法</li>
<li>Art回收算法可运行期选择</li>
<li>Art具备内存整理能力，减少内存空洞</li>
<li>Art是在5.0之后推出来的，当应用在前台的时候会时候标记-清除算法，在后台的时候会使用标记-整理算法</li>
</ul>
</li>
<li>Low Memory Killer<ul>
<li>进程分类（前台、可见、后台、空进程）</li>
<li>回收收益</li>
</ul>
</li>
</ul>
<h3 id="解决内存抖动"><a href="#解决内存抖动" class="headerlink" title="解决内存抖动"></a>解决内存抖动</h3><h4 id="什么是内存抖动"><a href="#什么是内存抖动" class="headerlink" title="什么是内存抖动"></a>什么是内存抖动</h4><ul>
<li>定义：内存频繁分配和回收导致内存不稳定</li>
<li>表现：频繁GC、内存曲线呈锯齿状</li>
<li>危害：导致卡顿、OOM</li>
</ul>
<p><strong>内存抖动导致OOM</strong></p>
<ul>
<li>频繁创建对象，导致内存不足及碎片（不连续）</li>
<li>不连续的内存片无法被分配，导致OOM</li>
</ul>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li>使用Memory Profiler初步排查</li>
<li>使用Memory Profiler或CPU Profiler结合代码排查</li>
<li>找出循环或者频繁调用的地方</li>
</ul>
<p>模拟内存抖动的场景：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryShakeActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(@NonNull Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//创造内存抖动</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                String arg[] = <span class="keyword">new</span> String[<span class="number">100000</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.sendEmptyMessageDelayed(<span class="number">0</span>, <span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHandler.sendEmptyMessageDelayed(<span class="number">0</span>, <span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_main;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702155328.png"  alt="内存抖动-Memory Profiler"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702155923.png"  alt="内存抖动-Memory Profiler"></p>
<h3 id="解决内存泄露"><a href="#解决内存泄露" class="headerlink" title="解决内存泄露"></a>解决内存泄露</h3><h4 id="内存泄露介绍"><a href="#内存泄露介绍" class="headerlink" title="内存泄露介绍"></a>内存泄露介绍</h4><ul>
<li>定义：内存中存在已久没有用的对象</li>
<li>表现：内存抖动、可用内存逐渐变少</li>
<li>危害：内存不足、GC频繁、OOM</li>
</ul>
<h4 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h4><ul>
<li>Memory Analyer<ul>
<li><a href="https://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener">https://www.eclipse.org/mat/downloads.php</a></li>
<li>转换命令：hprof-conv 原文件路径 转换后文件路径</li>
</ul>
</li>
</ul>
<p>模拟内存泄露场景：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLeakActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ImageView imageView = findViewById(R.id.image);</span><br><span class="line">        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.cat);</span><br><span class="line">        imageView.setImageBitmap(bitmap);</span><br><span class="line">        CallbackManager.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_memory_leak;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Callback&gt; sCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">        sCallbacks.add(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">        sCallbacks.remove(callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>操作：通过MainActivity反复的进入/退出此页面MemoryLeakActivity，通过CPU Profiler工具我们可以看到内存一直在增加，通过手动gc也是无法回收的。</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702161945.png"  alt="GC也无法回收内存"></p>
<p>通过界面的<code>Dump Java Heap</code>的操作，我们得到一个文件<code>memory-20200702T162306.hprof</code>，然后通过D:\develop\Android\sdk\platform-tools 自带的hprof-conv.exe工具进行转化：</p>
<blockquote>
<p>hprof-conv C:\Users\Desktop\memory-20200702T162306.hprof C:\Users\Desktop\memory-20200702T162306_trans.hprof</p>
</blockquote>
<p>将转化后的文件<code>memory-20200702T162306_trans.hprof</code>使用MAT工具进行分析：</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163210.png"  alt="MAT工具"></p>
<p>右键-List Objects-with outgoing reference</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163459.png"  alt="MAT工具"></p>
<p>右键-Path To GC Roots-with all references</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163646.png"  alt="MAT工具"></p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p>找到问题原因，那么解决方案就是在Activity销毁的时候调用remove方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLeakActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ImageView imageView = findViewById(R.id.image);</span><br><span class="line">        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.cat);</span><br><span class="line">        imageView.setImageBitmap(bitmap);</span><br><span class="line">        CallbackManager.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_memory_leak;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        CallbackManager.remove(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200702163924.png"  alt="解决内存泄露问题"></p>
<p><strong>小结：</strong></p>
<ul>
<li>使用Memory Profiler初步观察</li>
<li>通过Memory Analyzer结合确认</li>
</ul>
<h3 id="ARTHook"><a href="#ARTHook" class="headerlink" title="ARTHook"></a>ARTHook</h3><h4 id="Bitmap内存模型"><a href="#Bitmap内存模型" class="headerlink" title="Bitmap内存模型"></a>Bitmap内存模型</h4><ul>
<li>API 10之前Bitmap自身在Dalvik Heap中，像素在Native中</li>
<li>API 10之后像素也被放在了Dalvik Heap中</li>
<li>API 26之后像素在Native</li>
<li>获取Bitmap占用内存<ul>
<li>getByteCount</li>
<li>宽 * 高 * 一像素占用内存数量（如果图片放在了res目录下面，则计算的时候需要乘以一个压缩比例）</li>
</ul>
</li>
</ul>
<h4 id="常规方式-1"><a href="#常规方式-1" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>背景：图片对内存优化至关重要、图片宽高大于控件宽高</li>
<li>实现：继承ImageView，覆盖实现计算大小</li>
<li>分析<ul>
<li>侵入性强</li>
<li>不通用</li>
</ul>
</li>
</ul>
<h4 id="ARTHook实战"><a href="#ARTHook实战" class="headerlink" title="ARTHook实战"></a>ARTHook实战</h4><p><strong>ARTHook介绍</strong></p>
<ul>
<li>挂钩，将额外的代码钩住原有方法，修改执行逻辑<ul>
<li>运行时插桩</li>
<li>性能分析</li>
</ul>
</li>
</ul>
<p><strong>Epic简介</strong></p>
<blockquote>
<p>Epic 是一个在虚拟机层面、以 Java Method 为粒度的 <strong>运行时</strong> AOP Hook 框架。简单来说，Epic 就是 ART 上的 <a href="https://github.com/alibaba/dexposed" target="_blank" rel="noopener">Dexposed</a>（支持 Android 4.0 ~ 10.0）。它可以拦截本进程内部几乎任意的 Java 方法调用，可用于实现 AOP 编程、运行时插桩、性能分析、安全审计等。</p>
<p>Epic 被 <a href="https://github.com/android-hacker/VirtualXposed" target="_blank" rel="noopener">VirtualXposed</a> 以及 <a href="https://www.coolapk.com/apk/me.weishu.exp" target="_blank" rel="noopener">太极</a> 使用，用来实现非 Root 场景下的 Xposed 功能，已经经过了相当广泛的验证。</p>
</blockquote>
<ul>
<li>Epic是一个虚拟机层面，以Java Method为粒度的运行时Hook框架</li>
<li>支持Android 4.0——10.0</li>
<li><a href="https://github.com/tiann/epic" target="_blank" rel="noopener">https://github.com/tiann/epic</a></li>
<li>Epic使用<ul>
<li>implementation ‘me.weishu:epic:1.0.0’,在Android 8.0真机上面测试没问题</li>
<li>继承XC_MethodHook，实现相应逻辑</li>
<li>注入Hook：DexposedBridge.findAndHookMethod</li>
</ul>
</li>
</ul>
<p>代码实践：</p>
<p>图片cat的真实尺寸：w:1000,h:709</p>
<p>布局文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:onClick</span>=<span class="string">"memoryLeak"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"模拟内存泄露"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/image"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"120dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"20dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/image2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"20dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ImageHook代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageHook</span> <span class="keyword">extends</span> <span class="title">XC_MethodHook</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">        <span class="comment">//实现我们自己的逻辑</span></span><br><span class="line">        ImageView imageView = (ImageView) param.thisObject;</span><br><span class="line">        checkBitmap(imageView, imageView.getDrawable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkBitmap</span><span class="params">(Object object, Drawable drawable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> BitmapDrawable &amp;&amp; object <span class="keyword">instanceof</span> View) &#123;</span><br><span class="line">            <span class="keyword">final</span> Bitmap bitmap = ((BitmapDrawable) drawable).getBitmap();</span><br><span class="line">            <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> View view = (View) object;</span><br><span class="line">                <span class="keyword">int</span> w = view.getWidth();</span><br><span class="line">                <span class="keyword">int</span> h = view.getHeight();</span><br><span class="line">                <span class="comment">//要判断宽高是否大于0，表示控件已经绘制完成了</span></span><br><span class="line">                <span class="keyword">if</span> (w &gt; <span class="number">0</span> &amp;&amp; h &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果宽高都大于view的2倍以上，则警告</span></span><br><span class="line">                    <span class="keyword">if</span> (bitmap.getWidth() &gt;= (w &lt;&lt; <span class="number">1</span>) &amp;&amp; bitmap.getHeight() &gt;= (h &lt;&lt; <span class="number">1</span>)) &#123;</span><br><span class="line">                        warn(bitmap.getWidth(), bitmap.getHeight(), w, h);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//RuntimeException stackTrace = new RuntimeException();</span></span><br><span class="line">                    view.getViewTreeObserver().addOnPreDrawListener(<span class="keyword">new</span> ViewTreeObserver.OnPreDrawListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">int</span> w = view.getWidth();</span><br><span class="line">                            <span class="keyword">int</span> h = view.getHeight();</span><br><span class="line">                            L.d(<span class="string">"w:"</span> + w + <span class="string">",h:"</span> + h);</span><br><span class="line">                            L.d(<span class="string">"b.w:"</span> + bitmap.getWidth() + <span class="string">",b.h:"</span> + bitmap.getHeight());</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (bitmap.getWidth() &gt;= (w &lt;&lt; <span class="number">1</span>) &amp;&amp; bitmap.getHeight() &gt;= (h &lt;&lt; <span class="number">1</span>)) &#123;</span><br><span class="line">                                warn(bitmap.getWidth(), bitmap.getHeight(), w, h);</span><br><span class="line">                            &#125;</span><br><span class="line">                            view.getViewTreeObserver().removeOnPreDrawListener(<span class="keyword">this</span>);</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">        String warnInfo = <span class="keyword">new</span> StringBuilder(<span class="string">"Bitmap size too large:"</span>)</span><br><span class="line">                .append(<span class="string">"  real size:("</span>).append(width).append(<span class="string">","</span>).append(height).append(<span class="string">")"</span>)</span><br><span class="line">                .append(<span class="string">"  desired size:("</span>).append(w).append(<span class="string">","</span>).append(h).append(<span class="string">")"</span>)</span><br><span class="line">                .append(<span class="string">"  call stack trace:"</span>)</span><br><span class="line">                <span class="comment">//.append(Log.getStackTraceString())</span></span><br><span class="line">                .toString();</span><br><span class="line"></span><br><span class="line">        L.w(warnInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在Activity或者Application里面进行Hook操作，这里我们选择在Application里面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyApplication mApplication;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        mApplication = <span class="keyword">this</span>;</span><br><span class="line">        LauncherTimer.startRecord();</span><br><span class="line">        <span class="comment">/*TaskDispatcher.init(this);</span></span><br><span class="line"><span class="comment">        TaskDispatcher.createInstance()</span></span><br><span class="line"><span class="comment">                .addTask(new InitBuglyTask())</span></span><br><span class="line"><span class="comment">                .addTask(new InitUmengTask())</span></span><br><span class="line"><span class="comment">                .addTask(new InitFrescoTask())</span></span><br><span class="line"><span class="comment">                .addTask(new InitFrescoTask())</span></span><br><span class="line"><span class="comment">                .start();*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用ARTHook,Epic对图片加载进行监测,可以在Application注入也可以在Activity注入</span></span><br><span class="line">        DexposedBridge.hookAllConstructors(ImageView<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">XC_MethodHook</span>() </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">                DexposedBridge.findAndHookMethod(ImageView.class, "setImageBitmap", Bitmap.class, new ImageHook());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        LauncherTimer.endRecord(<span class="string">"Application启动时间"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//LauncherTimer.startRecord();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行代码，看日志输出：</p>
<blockquote>
<p>===&gt;: w:360,h:300<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: Bitmap size too large:  real size:(1000,709)  desired size:(360,300)  call stack trace:<br>===&gt;: w:360,h:300<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: Bitmap size too large:  real size:(1000,709)  desired size:(360,300)  call stack trace:</p>
<p>===&gt;: w:1000,h:709<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: w:1000,h:709<br>===&gt;: b.w:1000,b.h:709<br>===&gt;: w:1000,h:709<br>===&gt;: b.w:1000,b.h:709</p>
</blockquote>
<p>首先可以发现方法被重复调用了多次，其次被限定了大小尺寸显示的ImageView已经输出了warn信息，而warp_content的ImageView确没有输出warn信息。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>ARTHook无侵入性</li>
<li>通用性强</li>
<li>兼容问题大，开源方案不能带到线上环境</li>
</ul>
<h3 id="线上内存监控方案"><a href="#线上内存监控方案" class="headerlink" title="线上内存监控方案"></a>线上内存监控方案</h3><h4 id="常规方式-2"><a href="#常规方式-2" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>方式一：设定场景上Dump：Debug.dumpHprofData()<ul>
<li>实现流程：超过最大内存80%–&gt;内存Dum–&gt;回传文件–&gt;MAT手动分析</li>
<li>问题：Dump文件太大，和对象数正相关，可裁剪；上传失败率高、分析困难</li>
</ul>
</li>
<li>方式二：LeanCanary带到线上<ul>
<li>预设泄露怀疑点</li>
<li>发现泄露回传</li>
<li>总结：不适合所有情况，必须预设怀疑点；分析比较耗时、也容易OOM</li>
</ul>
</li>
</ul>
<h4 id="LeakCanary-1"><a href="#LeakCanary-1" class="headerlink" title="LeakCanary"></a>LeakCanary</h4><p><strong>原理</strong></p>
<ul>
<li>监控生命周期，onDestory添加RefWatcher监测</li>
<li>二次确认断定发生内存泄露</li>
<li>分析泄露，找引用链</li>
<li>监控组件+分析组件</li>
</ul>
<p><strong>定制</strong></p>
<ul>
<li>预设怀疑点——》自动找怀疑点</li>
<li>分析泄露链路——》分析Retain size大的对象</li>
<li>分析OOM——》对象裁剪，不全部加载到内存</li>
</ul>
<h4 id="线上监控完整方案"><a href="#线上监控完整方案" class="headerlink" title="线上监控完整方案"></a>线上监控完整方案</h4><ul>
<li>待机内存、重点模块内存、OOM率</li>
<li>整体及重点模块GC次数、GC时间</li>
<li>增强的LeakCanary自动化内存泄露分析</li>
</ul>
<h3 id="优化方向-1"><a href="#优化方向-1" class="headerlink" title="优化方向"></a>优化方向</h3><ul>
<li>内存泄露</li>
<li>内存抖动</li>
<li>Bitmap</li>
</ul>
<h3 id="优化细节"><a href="#优化细节" class="headerlink" title="优化细节"></a>优化细节</h3><ul>
<li>LargeHeap属性</li>
<li>onTrimMemory</li>
<li>使用优化过的集合：SparseArray</li>
<li>谨慎使用SharedPreference</li>
<li>谨慎使用外部库</li>
<li>业务架构设计合理</li>
</ul>
<h2 id="第5章-App布局优化"><a href="#第5章-App布局优化" class="headerlink" title="第5章 App布局优化"></a>第5章 App布局优化</h2><h3 id="绘制和布局加载原理"><a href="#绘制和布局加载原理" class="headerlink" title="绘制和布局加载原理"></a>绘制和布局加载原理</h3><h4 id="绘制"><a href="#绘制" class="headerlink" title="绘制"></a>绘制</h4><p><strong>绘制原理</strong></p>
<ul>
<li>CPU负责计算显示内容</li>
<li>GPU负责栅格化（UI元素绘制到屏幕上）</li>
<li>16ms发出VSync信号触发UI渲染</li>
<li>大多数的Android设备屏幕刷新频率：60Hz</li>
</ul>
<p><strong>优化工具</strong></p>
<ul>
<li>Systrace[未实践，需要Python2.7的环境]<ul>
<li>关注Frames</li>
<li>正常：绿色圆点，丢帧：黄色或红色</li>
<li>Alerts栏</li>
</ul>
</li>
<li>Layout Inspector<ul>
<li>Android Studio自带工具</li>
<li>查看视层次图结构</li>
</ul>
</li>
<li>Choreographyer<ul>
<li>获取FPS，线上使用，具备实时性<ul>
<li>API 16之后</li>
<li>Choreographer.getInstance().postFrameCallback()</li>
<li>参考文章：<a href="https://www.jianshu.com/p/bab0b454e39e" target="_blank" rel="noopener">https://www.jianshu.com/p/bab0b454e39e</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Choreographyer使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_main;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getFPS();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mStartFrameTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFrameCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MONITOR_INTERVAL = <span class="number">160L</span>;<span class="comment">//单次计算FPS使用160毫秒</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MONITOR_INTERVAL_NANOS = MONITOR_INTERVAL * <span class="number">1000L</span> * <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_INTERVAL = <span class="number">1000L</span>;<span class="comment">//设置计算fps的单位时间间隔1000ms，即fps/s</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getFPS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Choreographer.getInstance().postFrameCallback(<span class="keyword">new</span> Choreographer.FrameCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (mStartFrameTime == <span class="number">0</span>) &#123;</span><br><span class="line">                    mStartFrameTime = frameTimeNanos;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">long</span> interval = frameTimeNanos - mStartFrameTime;</span><br><span class="line">                <span class="keyword">if</span> (interval &gt; MONITOR_INTERVAL_NANOS) &#123;</span><br><span class="line">                    <span class="keyword">double</span> fps = (((<span class="keyword">double</span>) (mFrameCount * <span class="number">1000L</span> * <span class="number">1000L</span>)) / interval) * MAX_INTERVAL;</span><br><span class="line">                    L.d(<span class="string">"fps:"</span> + fps);</span><br><span class="line">                    mFrameCount = <span class="number">0</span>;</span><br><span class="line">                    mStartFrameTime = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ++mFrameCount;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//注意生命周期</span></span><br><span class="line">                Choreographer.getInstance().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>D/===&gt;: fps:54.000002160000086<br>D/===&gt;: fps:54.000002160000086<br>D/===&gt;: fps:60.0000024000001<br>D/===&gt;: fps:60.0000024000001<br>D/===&gt;: fps:60.0000024000001<br>D/===&gt;: fps:60.0000024000001</p>
</blockquote>
<h4 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h4><p><strong>布局加载流程</strong></p>
<p>setContentView —LayoutInflater—inflate—getLayout—createViewFromTag—Factory—createView</p>
<p><strong>性能瓶颈</strong></p>
<ul>
<li>布局文件解析：IO过程</li>
<li>创建View对象：反射</li>
</ul>
<p><strong>LayoutInflater.Factory</strong></p>
<ul>
<li>LayoutInflater创建View的一个Hook</li>
<li>定制创建View的过程：全局替换自定义TextView等</li>
</ul>
<p><strong>Factory与Factory2</strong></p>
<ul>
<li>Factory2继承于Factory</li>
<li>多了一个参数：parent</li>
</ul>
<h3 id="获取界面布局耗时"><a href="#获取界面布局耗时" class="headerlink" title="获取界面布局耗时"></a>获取界面布局耗时</h3><h4 id="常规方式-3"><a href="#常规方式-3" class="headerlink" title="常规方式"></a>常规方式</h4><ul>
<li>背景：获取每个界面加载耗时</li>
<li>实现：复写方法、手动埋点</li>
</ul>
<h4 id="AOP-ARTHook"><a href="#AOP-ARTHook" class="headerlink" title="AOP/ARTHook"></a>AOP/ARTHook</h4><ul>
<li>切Activity的setContentView</li>
</ul>
<p><strong>AOP方式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">//call：插入在函数体里面</span></span><br><span class="line">    <span class="comment">//execution：插入在函数体外面</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"execution (* android.app.Activity.setContentView(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getSetContentViewTime</span><span class="params">(ProceedingJoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        Signature signature = joinPoint.getSignature();</span><br><span class="line">        String name = signature.toShortString();</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        L.d(name + <span class="string">" cost "</span> + (System.currentTimeMillis() - time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"call (* com.github.chinesepoetry.MyApplication.**(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getApplicationMethodTime</span><span class="params">(ProceedingJoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        Signature signature = joinPoint.getSignature();</span><br><span class="line">        String name = signature.toShortString();</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        L.d(name + <span class="string">" cost "</span> + (System.currentTimeMillis() - time));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出日志：</p>
<blockquote>
<p>===&gt;: MyApplication.initMethod1() cost 1000<br>===&gt;: MyApplication.initMethod2() cost 2001<br>===&gt;: MyApplication.initMethod3() cost 3001<br>===&gt;: Application启动时间 cost 6005<br>===&gt;: AppCompatActivity.setContentView(..) cost 28  //第一个界面<br>===&gt;: AppCompatActivity.setContentView(..) cost 2 //这是跳入到第二个界面的耗时</p>
</blockquote>
<p><strong>ARTHook方式（作业）</strong></p>
<h4 id="获取任一控件耗时"><a href="#获取任一控件耗时" class="headerlink" title="获取任一控件耗时"></a>获取任一控件耗时</h4><ul>
<li>低侵入性</li>
<li>LayoutInflater.Factory</li>
</ul>
<p>这个方法我们要写在BaseActivity里面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取每一个控件的加载耗时，要在onCreate方法之前</span></span><br><span class="line">        LayoutInflaterCompat.setFactory2(getLayoutInflater(), <span class="keyword">new</span> LayoutInflater.Factory2() &#123;</span><br><span class="line">            <span class="meta">@Nullable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(@Nullable View parent, @NonNull String name, @NonNull Context context, @NonNull AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.equals(<span class="string">"TextView"</span>, name)) &#123;</span><br><span class="line">                    <span class="comment">//其实这里可以做自定义View，参考换肤</span></span><br><span class="line">                    L.d(name + <span class="string">"其实这里可以做自定义View，参考换肤"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                LauncherTimer.startRecord();</span><br><span class="line"></span><br><span class="line">                View view = getDelegate().createView(parent, name, context, attrs);</span><br><span class="line">                LauncherTimer.endRecord(name);</span><br><span class="line">                <span class="keyword">return</span> view;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Nullable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(@NonNull String name, @NonNull Context context, @NonNull AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(getContentView());</span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line"> 	 <span class="comment">//....</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<blockquote>
<p>===&gt;: MyApplication.initMethod1() cost 1001<br>===&gt;: MyApplication.initMethod2() cost 2001<br>===&gt;: MyApplication.initMethod3() cost 3000<br>===&gt;: Application启动时间 cost 6004<br>===&gt;: LinearLayout cost 0<br>===&gt;: ViewStub cost 0<br>===&gt;: FrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarOverlayLayout cost 0<br>===&gt;: androidx.appcompat.widget.ContentFrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContainer cost 0<br>===&gt;: androidx.appcompat.widget.Toolbar cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContextView cost 0<br>===&gt;: LinearLayout cost 0<br>===&gt;: Button cost 3<br>===&gt;: Button cost 0<br>===&gt;: AppCompatActivity.setContentView(..) cost 25<br>===&gt;: LinearLayout cost 0<br>===&gt;: ViewStub cost 0<br>===&gt;: FrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarOverlayLayout cost 1<br>===&gt;: androidx.appcompat.widget.ContentFrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContainer cost 0<br>===&gt;: androidx.appcompat.widget.Toolbar cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContextView cost 0<br>===&gt;: LinearLayout cost 0<br>===&gt;: TextView其实这里可以做自定义View，参考换肤<br>===&gt;: TextView cost 0<br>===&gt;: ImageView cost 0<br>===&gt;: ImageView cost 0<br>===&gt;: AppCompatActivity.setContentView(..) cost 11</p>
</blockquote>
<h3 id="异步Inflate"><a href="#异步Inflate" class="headerlink" title="异步Inflate"></a>异步Inflate</h3><h4 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h4><ul>
<li>布局文件读取慢：IO过程</li>
<li>创建View：反射（比new慢3倍）</li>
</ul>
<h4 id="AsyncLayoutInflater实战"><a href="#AsyncLayoutInflater实战" class="headerlink" title="AsyncLayoutInflater实战"></a>AsyncLayoutInflater实战</h4><ul>
<li>简称异步Inflate<ul>
<li>WorkThread加载布局</li>
<li>回调主线程</li>
<li>节约主线程时间</li>
<li>com.android.support:asynclayoutinflater</li>
</ul>
</li>
<li>注意事项<ul>
<li>不能设置LayoutInflater.Factory（自定义解决）</li>
<li>注意View中不能有依赖主线程的操作</li>
</ul>
</li>
</ul>
<p>参考：<a href="https://www.jianshu.com/p/f0c0eda06ae4" target="_blank" rel="noopener">https://www.jianshu.com/p/f0c0eda06ae4</a></p>
<p>代码实践：</p>
<p>引入依赖：com.android.support:asynclayoutinflater</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取每一个控件的加载耗时，要在onCreate方法之前</span></span><br><span class="line">        LayoutInflaterCompat.setFactory2(getLayoutInflater(), <span class="keyword">new</span> LayoutInflater.Factory2() &#123;</span><br><span class="line">            <span class="meta">@Nullable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(@Nullable View parent, @NonNull String name, @NonNull Context context, @NonNull AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.equals(<span class="string">"TextView"</span>, name)) &#123;</span><br><span class="line">                    <span class="comment">//其实这里可以做自定义View，参考换肤</span></span><br><span class="line">                    L.d(name + <span class="string">"其实这里可以做自定义View，参考换肤"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                LauncherTimer.startRecord();</span><br><span class="line">                View view = getDelegate().createView(parent, name, context, attrs);</span><br><span class="line">                LauncherTimer.endRecord(name);</span><br><span class="line">                <span class="keyword">return</span> view;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Nullable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(@NonNull String name, @NonNull Context context, @NonNull AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!asyncInflate()) &#123;</span><br><span class="line">            setContentView(getContentView());</span><br><span class="line">            initView();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">asyncInflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line"> 	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    Button btn;</span><br><span class="line">    Handler handler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(@NonNull Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">asyncInflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> AsyncLayoutInflater(<span class="keyword">this</span>).inflate(R.layout.activity_main, <span class="keyword">null</span>, <span class="keyword">new</span> AsyncLayoutInflater.OnInflateFinishedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInflateFinished</span><span class="params">(@NonNull View view, <span class="keyword">int</span> resid, @Nullable ViewGroup parent)</span> </span>&#123;</span><br><span class="line">                L.d(<span class="string">"onInflateFinished..."</span>);</span><br><span class="line">                setContentView(view);</span><br><span class="line">                btn = findViewById(R.id.btn);</span><br><span class="line">                btn.setText(<span class="string">"Async Inflater"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_main;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        btn = findViewById(R.id.btn);</span><br><span class="line"></span><br><span class="line">        btn.getViewTreeObserver().addOnPreDrawListener(<span class="keyword">new</span> ViewTreeObserver.OnPreDrawListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                btn.getViewTreeObserver().removeOnPreDrawListener(<span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">//LauncherTimer.endRecord("MainActivity");</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// getFPS();</span></span><br><span class="line">        <span class="comment">// ChoreographerUtils.getFPS();</span></span><br><span class="line">        initMethod1();</span><br><span class="line">    &#125;</span><br><span class="line"> 	<span class="comment">//...   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果比对：</p>
<blockquote>
<p>===&gt;: MyApplication.initMethod1() cost 1001<br>===&gt;: Application启动时间 cost 1001<br>===&gt;: LinearLayout cost 1<br>===&gt;: ViewStub cost 0<br>===&gt;: FrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarOverlayLayout cost 0<br>===&gt;: androidx.appcompat.widget.ContentFrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContainer cost 0<br>===&gt;: androidx.appcompat.widget.Toolbar cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContextView cost 0<br>===&gt;: onInflateFinished…<br>===&gt;: AppCompatActivity.setContentView(..) cost 0</p>
</blockquote>
<p>使用之前：</p>
<blockquote>
<p>===&gt;: MyApplication.initMethod1() cost 1000<br>===&gt;: Application启动时间 cost 1001<br>===&gt;: LinearLayout cost 0<br>===&gt;: ViewStub cost 0<br>===&gt;: FrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarOverlayLayout cost 0<br>===&gt;: androidx.appcompat.widget.ContentFrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContainer cost 0<br>===&gt;: androidx.appcompat.widget.Toolbar cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContextView cost 0<br>===&gt;: LinearLayout cost 0<br>===&gt;: Button cost 4<br>===&gt;: Button cost 0<br>===&gt;: AppCompatActivity.setContentView(..) cost 42</p>
</blockquote>
<h3 id="布局加载优化实践"><a href="#布局加载优化实践" class="headerlink" title="布局加载优化实践"></a>布局加载优化实践</h3><h4 id="背景介绍-1"><a href="#背景介绍-1" class="headerlink" title="背景介绍"></a>背景介绍</h4><ul>
<li>IO操作、反射</li>
<li>AsyncLayoutInflater只是缓解</li>
</ul>
<h4 id="Java代码写布局"><a href="#Java代码写布局" class="headerlink" title="Java代码写布局"></a>Java代码写布局</h4><ul>
<li>本质上解决了性能问题</li>
<li>引入了新问题：不便开发、可维护性差</li>
</ul>
<h4 id="X2C介绍（未实现，有问题）"><a href="#X2C介绍（未实现，有问题）" class="headerlink" title="X2C介绍（未实现，有问题）"></a>X2C介绍（未实现，有问题）</h4><ul>
<li>保留XML优点，解决其性能问题<ul>
<li>开发人员写XML，加载Java代码</li>
<li>原理：APT编译期翻译XML为Java代码</li>
<li><a href="https://github.com/iReaderAndroid/X2C" target="_blank" rel="noopener">https://github.com/iReaderAndroid/X2C</a></li>
</ul>
</li>
</ul>
<blockquote>
<p>annotationProcessor ‘com.zhangyue.we:x2c-apt:1.1.2’<br>implementation ‘com.zhangyue.we:x2c-lib:1.0.6’</p>
</blockquote>
<p>代码实践：</p>
<p>我们要加载的布局文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"Hello World!"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"模拟内存泄露"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"按钮"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"文本"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">"@mipmap/cat"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X2CActivty</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_x2c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>正常加载的日志：</p>
<blockquote>
<p>===&gt;: LinearLayout cost 0<br>===&gt;: ViewStub cost 0<br>===&gt;: FrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarOverlayLayout cost 0<br>===&gt;: androidx.appcompat.widget.ContentFrameLayout cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContainer cost 0<br>===&gt;: androidx.appcompat.widget.Toolbar cost 0<br>===&gt;: androidx.appcompat.widget.ActionBarContextView cost 0<br>===&gt;: LinearLayout cost 0<br>===&gt;: Button cost 0<br>===&gt;: Button cost 0<br>===&gt;: Button cost 1<br>===&gt;: TextView其实这里可以做自定义View，参考换肤<br>===&gt;: TextView cost 0<br>===&gt;: ImageView cost 23<br>===&gt;: AppCompatActivity.setContentView(..) cost 31</p>
</blockquote>
<p>接下来使用X2C进行优化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Xml</span>(layouts = <span class="string">"activity_x2c"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X2CActivty</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回true，则表示getContentView和initView不会被调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">asyncInflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//可以在这个方法里面进行配置X2C</span></span><br><span class="line">        X2C.setContentView(<span class="keyword">this</span>, R.layout.activity_x2c);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_x2c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过make工程，会在build/out目录下面生成一个<code>X2C0_Activity_X2c</code>文件，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WARN!!! dont edit this file</span></span><br><span class="line"><span class="comment"> * translate from &#123;<span class="doctag">@link</span>  com.github.chinesepoetry.R.layout.activity_x2c&#125;</span></span><br><span class="line"><span class="comment"> * autho chengwei </span></span><br><span class="line"><span class="comment"> * email chengwei@zhangyue.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X2C0_Activity_X2c</span> <span class="keyword">implements</span> <span class="title">IViewCreator</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> View <span class="title">createView</span><span class="params">(Context ctx)</span> </span>&#123;</span><br><span class="line">    	Resources res = ctx.getResources();</span><br><span class="line"></span><br><span class="line">        LinearLayout linearLayout0 = <span class="keyword">new</span> LinearLayout(ctx);</span><br><span class="line">        linearLayout0.setOrientation(LinearLayout.VERTICAL);</span><br><span class="line"></span><br><span class="line">        Button button1 = <span class="keyword">new</span> Button(ctx);</span><br><span class="line">        LinearLayout.LayoutParams layoutParam1 = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        button1.setId(R.id.btn);</span><br><span class="line">        button1.setText(<span class="string">"Hello World!"</span>);</span><br><span class="line">        button1.setLayoutParams(layoutParam1);</span><br><span class="line">        linearLayout0.addView(button1);</span><br><span class="line"></span><br><span class="line">        Button button2 = <span class="keyword">new</span> Button(ctx);</span><br><span class="line">        LinearLayout.LayoutParams layoutParam2 = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        button2.setText(<span class="string">"模拟内存泄露"</span>);</span><br><span class="line">        button2.setLayoutParams(layoutParam2);</span><br><span class="line">        linearLayout0.addView(button2);</span><br><span class="line"></span><br><span class="line">        Button button3 = <span class="keyword">new</span> Button(ctx);</span><br><span class="line">        LinearLayout.LayoutParams layoutParam3 = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        button3.setText(<span class="string">"按钮"</span>);</span><br><span class="line">        button3.setLayoutParams(layoutParam3);</span><br><span class="line">        linearLayout0.addView(button3);</span><br><span class="line"></span><br><span class="line">        TextView textView4 = <span class="keyword">new</span> TextView(ctx);</span><br><span class="line">        LinearLayout.LayoutParams layoutParam4 = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        textView4.setText(<span class="string">"文本"</span>);</span><br><span class="line">        textView4.setLayoutParams(layoutParam4);</span><br><span class="line">        linearLayout0.addView(textView4);</span><br><span class="line"></span><br><span class="line">        ImageView imageView5 = <span class="keyword">new</span> ImageView(ctx);</span><br><span class="line">        LinearLayout.LayoutParams layoutParam5 = <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        imageView5.setImageResource(R.mipmap.cat);</span><br><span class="line">        imageView5.setLayoutParams(layoutParam5);</span><br><span class="line">        linearLayout0.addView(imageView5);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> linearLayout0;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行一下，看下效果：</p>
<p>应该是生成X2C127_Activity_X2c文件啊，怎么回事X2C0_Activity_X2c？留着呆解决吧</p>
<blockquote>
</blockquote>
<p><strong>X2C问题</strong></p>
<ul>
<li>部分属性Java不支持</li>
<li>失去了系统的兼容（Appcompat），具体还要看最新版的X2C有没有解决这些问题</li>
</ul>
<h3 id="视图绘制优化实战"><a href="#视图绘制优化实战" class="headerlink" title="视图绘制优化实战"></a>视图绘制优化实战</h3><h4 id="优化布局层级及复杂度"><a href="#优化布局层级及复杂度" class="headerlink" title="优化布局层级及复杂度"></a>优化布局层级及复杂度</h4><p><strong>视图绘制回顾</strong></p>
<ul>
<li>测量：确定大小</li>
<li>布局：确定位置</li>
<li>绘制：绘制视图</li>
</ul>
<p><strong>性能瓶颈</strong></p>
<ul>
<li>每个阶段耗时</li>
<li>自顶向下的遍历</li>
<li>触发多次</li>
</ul>
<p><strong>布局层次及复杂度</strong></p>
<ul>
<li>准则<ul>
<li>减少View树层级</li>
<li>宽而浅，避免窄而深</li>
</ul>
</li>
</ul>
<p><strong>ConstraintLayout</strong></p>
<ul>
<li>实现几乎完全扁平化布局</li>
<li>构建复杂布局性能更高</li>
<li>具有RelativeLayout和LinearLayout特性</li>
</ul>
<p><strong>布局层级及复杂度</strong></p>
<ul>
<li>不嵌套使用RelativeLayout</li>
<li>不在嵌套LinearLayout中使用weight</li>
<li>merge标签：减少一个层级，只能用于根View</li>
</ul>
<h4 id="避免过度绘制"><a href="#避免过度绘制" class="headerlink" title="避免过度绘制"></a>避免过度绘制</h4><ul>
<li>一个像素最好只被绘制一次</li>
<li>调试GPU过度绘制</li>
<li>蓝色可接受</li>
</ul>
<p><strong>避免过度绘制方法</strong></p>
<ul>
<li>去掉多余背景色，减少复杂shape使用</li>
<li>避免层级叠加</li>
<li>自定义View使用clipRect屏蔽被遮盖View绘制</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200703141237.png"  alt="过度绘制"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200703141302.png"  alt="优化之后"></p>
<p><strong>其他技巧</strong></p>
<ul>
<li>Viewstub：高效占位符、延迟初始化</li>
<li>onDraw中避免：创建大对象、耗时操作</li>
<li>TextView优化</li>
</ul>
<h2 id="第6章-App卡顿优化"><a href="#第6章-App卡顿优化" class="headerlink" title="第6章 App卡顿优化"></a>第6章 App卡顿优化</h2><h3 id="卡顿优化工具"><a href="#卡顿优化工具" class="headerlink" title="卡顿优化工具"></a>卡顿优化工具</h3><ul>
<li>CPU Profiler</li>
<li>Systrace（需要python2.7）</li>
<li>StrictMode</li>
</ul>
<h4 id="CPU-Profiler"><a href="#CPU-Profiler" class="headerlink" title="CPU Profiler"></a>CPU Profiler</h4><ul>
<li>图形的形式展示执行时间、调用栈等</li>
<li>信息全面，包含所有线程</li>
<li>运行时开销严重，整体都会慢</li>
<li>使用方式<ul>
<li>Debug.startMethodTracing(“”)</li>
<li>Debug.endMethodTracing();</li>
<li>生成的文件位置：/storage/emulated/0/Android/data/包名/files</li>
</ul>
</li>
</ul>
<h4 id="Systrace（需要Python2-7配合）"><a href="#Systrace（需要Python2-7配合）" class="headerlink" title="Systrace（需要Python2.7配合）"></a>Systrace（需要Python2.7配合）</h4><ul>
<li><p>结合Android内核数据，生成Html报告</p>
</li>
<li><p>API18以上使用，推荐TraceCompat</p>
</li>
<li><p>使用方式</p>
<ul>
<li><p>TraceCompat.beginSection(“”)</p>
</li>
<li><p>TraceCompat.endSection()</p>
</li>
<li><p>Python</p>
<blockquote>
<p>python systrace.py -t 10 [other-options] [categories]</p>
</blockquote>
</li>
<li><p>在线</p>
<ul>
<li><a href="https://developer.android.com/studio/command-line/systrace" target="_blank" rel="noopener">https://developer.android.com/studio/command-line/systrace</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python D:\develop\Android\sdk\platform-tools\systrace\systrace.py -t 20 sched gfx view wm am app webview -a &quot;packageName&quot; -o log.html</span><br><span class="line"></span><br><span class="line">如：</span><br><span class="line">python D:\develop\Android\sdk\platform-tools\systrace\systrace.py -t 20 sched gfx view wm am app webview -a com.github.chinesepoetry -o log.html</span><br></pre></td></tr></table></figure>

<p>但是这样有个问题：只支持Python 2.7</p>
<blockquote>
<p>Systrace does not support Python 3.6. Please use Python 2.7.</p>
</blockquote>
<p>可以参考：<a href="https://www.jianshu.com/p/19b3245207e8" target="_blank" rel="noopener">https://www.jianshu.com/p/19b3245207e8</a></p>
<p><strong>Systrace使用总结：</strong></p>
<ul>
<li>轻量级，开销小</li>
<li>直观反映CPU利用率</li>
<li>给出建议</li>
</ul>
<h4 id="StrictMode（没有预期输出）"><a href="#StrictMode（没有预期输出）" class="headerlink" title="StrictMode（没有预期输出）"></a>StrictMode（没有预期输出）</h4><ul>
<li>严苛模式，Android提供的一种运行时检测机制</li>
<li>方便强大，容易被忽略</li>
<li>包含：线程策略和虚拟机策略检测</li>
<li>参考文章<ul>
<li><a href="https://www.jianshu.com/p/d4309061291b" target="_blank" rel="noopener">https://www.jianshu.com/p/d4309061291b</a></li>
<li><a href="https://www.jianshu.com/p/113b9c54b5d1" target="_blank" rel="noopener">https://www.jianshu.com/p/113b9c54b5d1</a></li>
</ul>
</li>
</ul>
<p><strong>虚拟机策略</strong></p>
<ul>
<li>Activity泄露，detectActivityLeaks</li>
<li>Sqlite对象泄露，detectLeakedSqlLiteObjects</li>
<li>检测实例数量：setClassInstanceLimit()</li>
</ul>
<p>代码实践：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        initStrictMode();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initStrictMode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(<span class="keyword">new</span> StrictMode.ThreadPolicy.Builder()</span><br><span class="line">                    .detectCustomSlowCalls()<span class="comment">//：主要用于帮助开发者发现UI线程中调用的哪些方法执行的比较慢，要和StrictMode.noteSlowCall配合使用，只有通过  StrictMode.noteSlowCall标记“可能会”执行比较慢的方法，只有标记过的方法才能被检测到，日志中会记录方法的执行时间（注意：只有在主线程中执行的方法才会显示执行时间，在其他线程中执行的方法，就算是使用StrictMode.noteSlowCall标记，在日志中也不会打印执行时间）</span></span><br><span class="line">                    .detectDiskReads()<span class="comment">//磁盘读写检查</span></span><br><span class="line">                    .detectDiskWrites()<span class="comment">//磁盘读写检查</span></span><br><span class="line">                    .detectNetwork()<span class="comment">//用于检查UI线程中是否有网络请求</span></span><br><span class="line">                    .penaltyLog()<span class="comment">//logcat中打印违规异常信息</span></span><br><span class="line">                    .build());</span><br><span class="line"></span><br><span class="line">            StrictMode.setVmPolicy(<span class="keyword">new</span> StrictMode.VmPolicy.Builder()</span><br><span class="line">                    .detectLeakedSqlLiteObjects()<span class="comment">//资源没有正确关闭时回触发，detectLeakedSqlLiteObjects() 和 detectLeakedClosableObjects()的用法类似，只不过是用来检查 SQLiteCursor 或者 其他 SQLite 对象是否被正确关闭</span></span><br><span class="line">                    .detectLeakedClosableObjects()</span><br><span class="line">                    .detectActivityLeaks()<span class="comment">//检查 Activity 的内存泄露情况</span></span><br><span class="line">                    .setClassInstanceLimit(Person<span class="class">.<span class="keyword">class</span>, 1)//设置某个类的同时处于内存中的实例上限，可以协助检查内存泄露</span></span><br><span class="line"><span class="class">                    .<span class="title">penaltyLog</span>()</span></span><br><span class="line"><span class="class">                    .<span class="title">build</span>()</span></span><br><span class="line"><span class="class">            )</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们在MainActivity生成两个Person对象实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MainActivity:</span><br><span class="line">Person p1 &#x3D; new Person();</span><br><span class="line">Person p2 &#x3D; new Person();</span><br></pre></td></tr></table></figure>

<p>日志输出：但是发现没有预期的日志内存输出*</p>
<h3 id="自动化检测方案"><a href="#自动化检测方案" class="headerlink" title="自动化检测方案"></a>自动化检测方案</h3><p>为什么需要自动化检测方案？</p>
<ul>
<li>系统工具适合线下针对性分析</li>
<li>线上及测试环节需要自动化检测方案</li>
</ul>
<h4 id="方案原理"><a href="#方案原理" class="headerlink" title="方案原理"></a>方案原理</h4><ul>
<li>消息处理机制，一个线程只有一个Looper</li>
<li>mLogging对象在每个Message处理前后都被调用</li>
<li>主线程发生卡顿，是在dispatchMessage执行耗时操作</li>
</ul>
<p>看Looper源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Looper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">        <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">        <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">        Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow overriding a threshold with a system prop. e.g.</span></span><br><span class="line">        <span class="comment">// adb shell 'setprop log.looper.1000.main.slow 1 &amp;&amp; stop &amp;&amp; start'</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> thresholdOverride =</span><br><span class="line">                SystemProperties.getInt(<span class="string">"log.looper."</span></span><br><span class="line">                        + Process.myUid() + <span class="string">"."</span></span><br><span class="line">                        + Thread.currentThread().getName()</span><br><span class="line">                        + <span class="string">".slow"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> slowDeliveryDetected = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">            <span class="keyword">final</span> Printer logging = me.mLogging;</span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//关键代码</span></span><br><span class="line">                logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</span><br><span class="line">                        msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Make sure the observer won't change while processing a transaction.</span></span><br><span class="line">            <span class="keyword">final</span> Observer observer = sObserver;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</span><br><span class="line">            <span class="keyword">long</span> slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;</span><br><span class="line">            <span class="keyword">long</span> slowDeliveryThresholdMs = me.mSlowDeliveryThresholdMs;</span><br><span class="line">            <span class="keyword">if</span> (thresholdOverride &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                slowDispatchThresholdMs = thresholdOverride;</span><br><span class="line">                slowDeliveryThresholdMs = thresholdOverride;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logSlowDelivery = (slowDeliveryThresholdMs &gt; <span class="number">0</span>) &amp;&amp; (msg.when &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logSlowDispatch = (slowDispatchThresholdMs &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> needStartTime = logSlowDelivery || logSlowDispatch;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> needEndTime = logSlowDispatch;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">                Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> dispatchStart = needStartTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> dispatchEnd;</span><br><span class="line">            Object token = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                token = observer.messageDispatchStarting();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> origWorkSource = ThreadLocalWorkSource.setUid(msg.workSourceUid);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                msg.target.dispatchMessage(msg);</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    observer.messageDispatched(token, msg);</span><br><span class="line">                &#125;</span><br><span class="line">                dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    observer.dispatchingThrewException(token, msg, exception);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> exception;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">                <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                    Trace.traceEnd(traceTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDelivery) &#123;</span><br><span class="line">                <span class="keyword">if</span> (slowDeliveryDetected) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((dispatchStart - msg.when) &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Drained"</span>);</span><br><span class="line">                        slowDeliveryDetected = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (showSlowLog(slowDeliveryThresholdMs, msg.when, dispatchStart, <span class="string">"delivery"</span>,</span><br><span class="line">                            msg)) &#123;</span><br><span class="line">                        <span class="comment">// Once we write a slow delivery log, suppress until the queue drains.</span></span><br><span class="line">                        slowDeliveryDetected = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDispatch) &#123;</span><br><span class="line">                showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, <span class="string">"dispatch"</span>, msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//关键代码</span></span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">            <span class="comment">// identity of the thread wasn't corrupted.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></span><br><span class="line">                        + Long.toHexString(ident) + <span class="string">" to 0x"</span></span><br><span class="line">                        + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">" "</span></span><br><span class="line">                        + msg.callback + <span class="string">" what="</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            msg.recycleUnchecked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键两行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> + msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</span><br></pre></td></tr></table></figure>

<h4 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h4><ul>
<li>Looper.getMainLooper.setMessageLogging()</li>
<li>匹配 &gt;&gt;&gt;&gt;&gt; Dispatching to，阈值时间后执行任务（获取堆栈）</li>
<li>匹配&lt;&lt;&lt;&lt;&lt; Finished to ，任务启动之前取消掉</li>
</ul>
<h4 id="AndroidPerformanceMonitor"><a href="#AndroidPerformanceMonitor" class="headerlink" title="AndroidPerformanceMonitor"></a>AndroidPerformanceMonitor</h4><p><strong>AndroidPerformanceMonitor</strong></p>
<ul>
<li><p>非侵入性的性能监控组件，通知形式弹出卡顿信息</p>
</li>
<li><p>Github：<a href="https://github.com/markzhai/AndroidPerformanceMonitor" target="_blank" rel="noopener">https://github.com/markzhai/AndroidPerformanceMonitor</a></p>
</li>
<li><p>使用</p>
<ul>
<li><p>compile ‘com.github.markzhai:blockcanary-android:1.5.0’</p>
</li>
<li><p>在Application初始化</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Do it on main process</span></span><br><span class="line">        BlockCanary.install(<span class="keyword">this</span>, <span class="keyword">new</span> AppBlockCanaryContext()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>说明：由于作者不维护了这个库，所在在新版本AS中会出现编译问题 build.gradle: Configuration ‘compile’ is obsolete and has been replaced with，解决方案参考：<a href="https://blog.csdn.net/go_going/article/details/81077034" target="_blank" rel="noopener">https://blog.csdn.net/go_going/article/details/81077034</a></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200706145904.png"  alt="BlockCanary日志"></p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200706145817.png"  alt="BlockCanary日志"></p>
<h3 id="ANR分析与实战"><a href="#ANR分析与实战" class="headerlink" title="ANR分析与实战"></a>ANR分析与实战</h3><h4 id="ANR介绍"><a href="#ANR介绍" class="headerlink" title="ANR介绍"></a>ANR介绍</h4><ul>
<li>KeyDispatchTimeout ,5s</li>
<li>BroadcatTimeout，前台10s，后台60s</li>
<li>ServiceTimeout，前台20s，后台200s</li>
</ul>
<p><strong>ANR执行流程</strong></p>
<ul>
<li>发生ANR</li>
<li>进程接收异常终止信号，开始写入进程ANR信息</li>
<li>弹出ANR提示（Rom表现不一）</li>
</ul>
<p><strong>ANR解决套路</strong></p>
<ul>
<li>存储路径：adb pull data/anr/traces.txt  本地路径</li>
<li>详情分析：CPU、IO、锁</li>
<li>关于如何导出anr文件，参考：<a href="https://blog.csdn.net/cui130/article/details/82686732" target="_blank" rel="noopener">https://blog.csdn.net/cui130/article/details/82686732</a></li>
</ul>
<p><strong>模拟一个ANR</strong></p>
<p>这块关于ANR文件的导出出现了一点问题，权限问题。</p>
<h4 id="线上ANR监控方案"><a href="#线上ANR监控方案" class="headerlink" title="线上ANR监控方案"></a>线上ANR监控方案</h4><ul>
<li>通过FileObserver监控文件变化，但是有高版本权限问题</li>
<li>ANR-WatchDog</li>
</ul>
<h4 id="ANR-WatchDog"><a href="#ANR-WatchDog" class="headerlink" title="ANR-WatchDog"></a>ANR-WatchDog</h4><ul>
<li>非侵入的ANR监控组件</li>
<li><a href="https://github.com/SalomonBrys/ANR-WatchDog" target="_blank" rel="noopener">https://github.com/SalomonBrys/ANR-WatchDog</a></li>
<li>compile ‘com.github.anrwatchdog:anrwatchdog:1.4.0’</li>
<li>new ANRWatchDog().start();</li>
</ul>
<p><strong>ANR-WatchDog原理</strong></p>
<ul>
<li><p>ANR-WatchDog创建一个监测线程，该线程不断往UI线程post一个任务，然后睡眠固定时间，等该线程重新起来后检测之前post的任务是否执行了，如果任务未被执行，则生成ANRError,并终止进程</p>
</li>
<li><p>start-post消息改值-sleep-检测是否修改-判断ANR发生</p>
</li>
</ul>
<p><strong>方案总结</strong></p>
<ul>
<li>非侵入性</li>
<li>弥补高版本无权限问题</li>
</ul>
<p>模拟一个ANR</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ANRActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        findViewById(R.id.tv_hello).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                L.d(<span class="string">"hello"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                L.d(<span class="string">"hello end"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_anr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志输出：</p>
<p><img src="/" class="lazyload" data-src="https://gitee.com/vxo/img/raw/master/blog/20200706144859.png"  alt="ANR日志输出"></p>
<p><strong>方案对比</strong></p>
<ul>
<li>AndroidPerformanceMonitor：监控msg</li>
<li>ANR-WatchDog：看最终结果</li>
<li>前者适合监控卡顿，后者适合补充ANR监控</li>
</ul>
<p>说明：由于作者不维护了这个库，所在在新版本AS中会出现编译问题 build.gradle: Configuration ‘compile’ is obsolete and has been replaced with，所以目前还未能实践</p>
<h3 id="卡顿单点问题检查方案"><a href="#卡顿单点问题检查方案" class="headerlink" title="卡顿单点问题检查方案"></a>卡顿单点问题检查方案</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><ul>
<li>自动卡顿检测方案并不够</li>
<li>体系化解决方案务必尽早暴露问题</li>
<li>单点问题：主线程IPC、DB</li>
</ul>
<h4 id="IPC问题检测"><a href="#IPC问题检测" class="headerlink" title="IPC问题检测"></a>IPC问题检测</h4><ul>
<li>监控指标<ul>
<li>IPC调用类型</li>
<li>调用耗时、次数</li>
<li>调用堆栈、发生线程</li>
</ul>
</li>
</ul>
<p><strong>IPC问题检测</strong></p>
<p>常规方案：</p>
<ul>
<li>IPC前后加埋点</li>
<li>不优雅，容易忘记</li>
<li>维护成本大</li>
</ul>
<p>IPC问题监控技巧：</p>
<ul>
<li>adb命令<ul>
<li>adb shell am trace-ipc start</li>
<li>adb shell am trace-ipc stop –dump-file /data/local/tmp/ipc-trace.txt</li>
<li>adb pull /data/local/tmp/ipc-trace.txt</li>
</ul>
</li>
</ul>
<p>优雅方案：</p>
<ul>
<li>ARTHook还是AspectJ</li>
<li>ARTHook：可以Hook系统方法，模拟器运行会崩溃</li>
<li>AspectJ：非系统方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EpicUtils</span> </span>&#123; </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BinderProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DexposedBridge.findAndHookMethod(Class.forName(<span class="string">"android.os.BinderProxy"</span>), <span class="string">"transact"</span>, <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>, <span class="title">Parcel</span>.<span class="title">class</span>, <span class="title">Parcel</span>.<span class="title">class</span>, <span class="title">int</span>.<span class="title">class</span>, <span class="title">new</span> <span class="title">XC_MethodHook</span>() </span>&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    L.d(<span class="string">"BinderProxy beforeHookedMethod "</span> + param.thisObject.getClass().getSimpleName() + <span class="string">"\n"</span> +</span><br><span class="line">                            Log.getStackTraceString(<span class="keyword">new</span> Throwable()));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>卡顿问题监控总结</strong></p>
<ul>
<li>利用ARTHook完善线下工具</li>
<li>开发阶段Hook相关操作，暴露、分析问题</li>
</ul>
<p><strong>监控维度</strong></p>
<ul>
<li>IPC</li>
<li>IO、DB</li>
<li>View绘制</li>
</ul>
<h3 id="界面秒开实现"><a href="#界面秒开实现" class="headerlink" title="界面秒开实现"></a>界面秒开实现</h3><ul>
<li>界面秒开就是一个小的启动优化</li>
<li>可以借鉴启动优化及布局优化章节</li>
<li>方案<ul>
<li>Systrace，优雅异步+优雅延迟初始化</li>
<li>异步Inflate、X2C、绘制优化</li>
<li>提前获取页面数据</li>
</ul>
</li>
</ul>
<p><strong>界面秒开率统计</strong></p>
<ul>
<li>onCreate到onWindowFocusChanged</li>
<li>特定接口</li>
</ul>
<h4 id="Lancet"><a href="#Lancet" class="headerlink" title="Lancet"></a>Lancet</h4><ul>
<li>轻量级Android AOP框架<ul>
<li>编译速度快，支持增量编译</li>
<li>API简单，没有任何多余代码插入apk</li>
<li><a href="https://github.com/eleme/lancet" target="_blank" rel="noopener">https://github.com/eleme/lancet</a></li>
</ul>
</li>
<li>@Procy通常用于对系统API调用的Hook</li>
<li>@Insert常用于操作App与library的类</li>
<li>参考文章：<a href="https://blog.csdn.net/lwj_zeal/article/details/89502145" target="_blank" rel="noopener">https://blog.csdn.net/lwj_zeal/article/details/89502145</a></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityHooker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ActivityRecord sActivityRecord;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        sActivityRecord = <span class="keyword">new</span> ActivityRecord();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Proxy</span>(<span class="string">"d"</span>)</span><br><span class="line">    <span class="meta">@TargetClass</span>(<span class="string">"android.util.Log"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">d</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        msg = msg + <span class="string">" by lancet"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) Origin.call();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(value = <span class="string">"onCreate"</span>, mayCreateSuper = <span class="keyword">true</span>)</span><br><span class="line">    <span class="meta">@TargetClass</span>(value = <span class="string">"androidx.appcompat.app.AppCompatActivity"</span>, scope = Scope.LEAF)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        sActivityRecord.mOnCreateTime = System.currentTimeMillis();</span><br><span class="line">        Origin.callVoid();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(value = <span class="string">"onWindowFocusChanged"</span>, mayCreateSuper = <span class="keyword">true</span>)</span><br><span class="line">    <span class="meta">@TargetClass</span>(value = <span class="string">"androidx.appcompat.app.AppCompatActivity"</span>, scope = Scope.LEAF)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span> </span>&#123;</span><br><span class="line">        sActivityRecord.mOnWindowFocusChangedTime = System.currentTimeMillis();</span><br><span class="line">        L.d(<span class="string">"onWindowFocusChanged cost-&gt;"</span> + (sActivityRecord.mOnWindowFocusChangedTime - sActivityRecord.mOnCreateTime));</span><br><span class="line">        Origin.callVoid();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> mOnCreateTime;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> mOnWindowFocusChangedTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出日志：</p>
<blockquote>
<p>D/===&gt;: MyApplication.initMethod1() cost 1001 by lancet<br>D/===&gt;: Application启动时间 cost 1046 by lancet<br>D/===&gt;: LinearLayout cost 4 by lancet<br>D/===&gt;: onWindowFocusChanged cost-&gt;1355 by lancet</p>
</blockquote>
<h3 id="优雅监控耗时盲区（略）"><a href="#优雅监控耗时盲区（略）" class="headerlink" title="优雅监控耗时盲区（略）"></a>优雅监控耗时盲区（略）</h3><h2 id="第7章-App线程优化"><a href="#第7章-App线程优化" class="headerlink" title="第7章 App线程优化"></a>第7章 App线程优化</h2><p>this.</p>
<h2 id="第8章-App网络优化"><a href="#第8章-App网络优化" class="headerlink" title="第8章 App网络优化"></a>第8章 App网络优化</h2><h2 id="第9章-App电量优化"><a href="#第9章-App电量优化" class="headerlink" title="第9章 App电量优化"></a>第9章 App电量优化</h2><h2 id="第10章-App瘦身优化"><a href="#第10章-App瘦身优化" class="headerlink" title="第10章 App瘦身优化"></a>第10章 App瘦身优化</h2><h2 id="第11章-App稳定性优化"><a href="#第11章-App稳定性优化" class="headerlink" title="第11章 App稳定性优化"></a>第11章 App稳定性优化</h2><h2 id="第12章-App专项技术优化"><a href="#第12章-App专项技术优化" class="headerlink" title="第12章 App专项技术优化"></a>第12章 App专项技术优化</h2><h2 id="第13章-课程总结"><a href="#第13章-课程总结" class="headerlink" title="第13章 课程总结"></a>第13章 课程总结</h2><p><strong>END.</strong></p>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></div><div class="post_share"><div class="social-share" data-image="http://www.juu8.com/uploads/allimg/180805/1634004351-0.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/04/%E8%82%A1%E7%A5%A8%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/"><img class="prev_cover lazyload" data-src="http://www.juu8.com/uploads/allimg/180805/1634004351-0.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">股票基础知识学习（一）.md</div></div></a></div><div class="next-post pull_right"><a href="/2020/06/25/Ubuntu18.04%E7%BC%96%E8%AF%91%E5%AE%89%E5%8D%93/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ubuntu18.04编译安卓</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/05/25/Android源码分析——Dagger2（未完）/" title="Android源码分析——Dagger2（未完）"><img class="relatedPosts_cover lazyload"data-src="https://img.cniao5.com/o_1b3rl8h6mk8d162i1i0p1ha6p989.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-25</div><div class="relatedPosts_title">Android源码分析——Dagger2（未完）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/18/Android源码分析——Retrofit/" title="Android源码分析——Retrofit"><img class="relatedPosts_cover lazyload"data-src="https://img.cniao5.com/o_1avp1uvsgh7irrvv158jn7mf9.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-18</div><div class="relatedPosts_title">Android源码分析——Retrofit</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/21/Android源码分析——Glide/" title="Android源码分析——Glide"><img class="relatedPosts_cover lazyload"data-src="http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-21</div><div class="relatedPosts_title">Android源码分析——Glide</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/21/博文地址推荐/" title="博文地址推荐"><img class="relatedPosts_cover lazyload"data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591889554697&di=6cd48317171455e6e367313f3430a2e2&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180717%2Fab8a30734c7f45ad847ca089864e25e4.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-21</div><div class="relatedPosts_title">博文地址推荐</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/13/开发技能汇总/" title="开发技能汇总"><img class="relatedPosts_cover lazyload"data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1589358596541&di=ec2608777052785cb20f0d366f2d82b7&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20170830%2F544fed872efd40a5acf7ebcec0067fc1.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-13</div><div class="relatedPosts_title">开发技能汇总</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/25/Android源码分析——EventBus/" title="Android源码分析——EventBus"><img class="relatedPosts_cover lazyload"data-src="https://img-blog.csdnimg.cn/20181208105518324.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-25</div><div class="relatedPosts_title">Android源码分析——EventBus</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Kai</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>