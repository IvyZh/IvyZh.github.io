<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android源码分析——Glide | K的小屋</title><meta name="description" content="Android源码分析——Glide"><meta name="keywords" content="Android,Glide"><meta name="author" content="Kai"><meta name="copyright" content="Kai"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Android源码分析——Glide"><meta name="twitter:description" content="Android源码分析——Glide"><meta name="twitter:image" content="http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Android源码分析——Glide"><meta property="og:url" content="https://www.google.com/2020/05/21/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Glide/"><meta property="og:site_name" content="K的小屋"><meta property="og:description" content="Android源码分析——Glide"><meta property="og:image" content="http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://www.google.com/2020/05/21/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Glide/"><link rel="prev" title="博文地址推荐" href="https://www.google.com/2020/05/21/%E5%8D%9A%E6%96%87%E5%9C%B0%E5%9D%80%E6%8E%A8%E8%8D%90/"><link rel="next" title="Android源码分析——Retrofit" href="https://www.google.com/2020/05/18/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Retrofit/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">1.</span> <span class="toc-text">参考文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用版本"><span class="toc-number">2.</span> <span class="toc-text">使用版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内容概括"><span class="toc-number">3.</span> <span class="toc-text">内容概括</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#图片加载框架对比"><span class="toc-number">4.</span> <span class="toc-text">图片加载框架对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Glide框架基本使用"><span class="toc-number">5.</span> <span class="toc-text">Glide框架基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#库的引入及混淆配置"><span class="toc-number">5.1.</span> <span class="toc-text">库的引入及混淆配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用"><span class="toc-number">5.2.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完整配置"><span class="toc-number">5.3.</span> <span class="toc-text">完整配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Glide源码整体流程梳理"><span class="toc-number">6.</span> <span class="toc-text">Glide源码整体流程梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#几个概念"><span class="toc-number">6.1.</span> <span class="toc-text">几个概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主流程图"><span class="toc-number">6.2.</span> <span class="toc-text">主流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主流程细化"><span class="toc-number">6.3.</span> <span class="toc-text">主流程细化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#with"><span class="toc-number">6.3.1.</span> <span class="toc-text">with</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Glide类"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">Glide类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RequestManagerRetriever类"><span class="toc-number">6.3.1.2.</span> <span class="toc-text">RequestManagerRetriever类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RequestManagerFragment类"><span class="toc-number">6.3.1.3.</span> <span class="toc-text">RequestManagerFragment类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#load"><span class="toc-number">6.3.2.</span> <span class="toc-text">load</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RequestManager类"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">RequestManager类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DrawableTypeRequest类"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">DrawableTypeRequest类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DrawableRequestBuilder类（DrawableTypeRequest的父类）"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">DrawableRequestBuilder类（DrawableTypeRequest的父类）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GenericRequestBuilder类（DrawableRequestBuilder的父类）"><span class="toc-number">6.3.2.4.</span> <span class="toc-text">GenericRequestBuilder类（DrawableRequestBuilder的父类）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Glide类-1"><span class="toc-number">6.3.2.5.</span> <span class="toc-text">Glide类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#into-1"><span class="toc-number">6.3.3.</span> <span class="toc-text">into-1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DrawableRequestBuilder类"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">DrawableRequestBuilder类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GenericRequestBuilder类"><span class="toc-number">6.3.3.2.</span> <span class="toc-text">GenericRequestBuilder类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Glide类-2"><span class="toc-number">6.3.3.3.</span> <span class="toc-text">Glide类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ImageViewTargetFactory类"><span class="toc-number">6.3.3.4.</span> <span class="toc-text">ImageViewTargetFactory类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RequestTracker类"><span class="toc-number">6.3.3.5.</span> <span class="toc-text">RequestTracker类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GenericRequest类"><span class="toc-number">6.3.3.6.</span> <span class="toc-text">GenericRequest类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#into-2-onSizeReady"><span class="toc-number">6.3.4.</span> <span class="toc-text">into-2 onSizeReady</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GenericRequest类-1"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">GenericRequest类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Engine类"><span class="toc-number">6.3.4.2.</span> <span class="toc-text">Engine类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#into-3-run"><span class="toc-number">6.3.5.</span> <span class="toc-text">into-3-run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#into-4"><span class="toc-number">6.3.6.</span> <span class="toc-text">into-4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#into-5"><span class="toc-number">6.3.7.</span> <span class="toc-text">into-5</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#END"><span class="toc-number">7.</span> <span class="toc-text">END.</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://inthecheesefactory.com/uploads/source/glidepicasso/cover.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">K的小屋</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Android源码分析——Glide</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-05-21 15:00:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-05-21</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-05-21 20:41:11"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-05-21</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">10k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 42 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><blockquote>
<p>Glide优势与特点:</p>
<p><a href="https://blog.csdn.net/u013240038/article/details/51474900" target="_blank" rel="noopener">https://blog.csdn.net/u013240038/article/details/51474900</a></p>
</blockquote>
<h2 id="使用版本"><a href="#使用版本" class="headerlink" title="使用版本"></a>使用版本</h2><p>使用版本：’com.github.bumptech.glide:glide:3.7.0’</p>
<h2 id="内容概括"><a href="#内容概括" class="headerlink" title="内容概括"></a>内容概括</h2><ul>
<li>框架对比：<a href="https://www.jianshu.com/p/89ab4f415bf8" target="_blank" rel="noopener">https://www.jianshu.com/p/89ab4f415bf8</a></li>
<li>基本使用：<a href="https://www.jianshu.com/p/be6d053e2b6b" target="_blank" rel="noopener">https://www.jianshu.com/p/be6d053e2b6b</a></li>
<li>源码分析</li>
</ul>
<h2 id="图片加载框架对比"><a href="#图片加载框架对比" class="headerlink" title="图片加载框架对比"></a>图片加载框架对比</h2><blockquote>
<p>主要比对框架包括：Universal Imageloader（下文简称 UIL）、Picasso、 Glide、Fresco。先对各个框架做简单介绍，再对框架进行对比</p>
</blockquote>
<h2 id="Glide框架基本使用"><a href="#Glide框架基本使用" class="headerlink" title="Glide框架基本使用"></a>Glide框架基本使用</h2><h3 id="库的引入及混淆配置"><a href="#库的引入及混淆配置" class="headerlink" title="库的引入及混淆配置"></a>库的引入及混淆配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Glide源码分析所需依赖</span><br><span class="line">implementation &#39;com.github.bumptech.glide:glide:3.7.0&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-keep public class * implements com.bumptech.glide.module.GlideModule</span><br><span class="line">-keep public enum com.bumptech.glide.load.resource.bitmap.ImageHeaderParser$** &#123;</span><br><span class="line">      **[] $VALUES;</span><br><span class="line">      public *;</span><br><span class="line">    &#125;</span><br><span class="line"># for DexGuard only  </span><br><span class="line">-keepresourcexmlelements manifest&#x2F;application&#x2F;meta-data@value&#x3D;GlideModule</span><br></pre></td></tr></table></figure>

<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">simple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Glide.with(<span class="keyword">this</span>)</span><br><span class="line">            .load(url)</span><br><span class="line">            .into(imageView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如上是一行最简单的图片加载代码，涉及的三个函数是Glide的核心。<br> 第一个函数：with，参数为各种context，可传入Activity，Fragment等对象，这里传入的Context不同会影响图片加载的生命周期，比如传入一个activity，那当这个activity的onPause的时候会停止加载，onReusme时再恢复加载。<br> 第二个函数：load，参数为定位图片资源的路径，有多种重载参数，如图片地址的Uri对象，int类型的本地资源id，本地图片的文件对象及指向assets、raw、本地存储等路径下图片的String类型。<br> 第三个函数：into，参数为一个ImageView或Taget对象，Taget对象可以理解为一个回调，这块下面单独介绍。</p>
</blockquote>
<h3 id="完整配置"><a href="#完整配置" class="headerlink" title="完整配置"></a>完整配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * glide已经有线程切换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">complex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Glide最简单的加载图片方式是直接将图片从下载、处理到最后的展示都封装了起来，最后直接展示到ImageView上，如果我们想在中间做些处理的话，可以使用回调，</span></span><br><span class="line"><span class="comment">     * 比如只下载不立即展示，或者下载后设置到一个非ImageView的自定义View中，或者对请求过程的错误结果或成功结果进行拦截</span></span><br><span class="line"><span class="comment">     * Glide可以设置两种回调，RequestListener和Target.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">///RequestListener是对过程进行拦截的，可以拦截错误状态和成功的结果。在onException中如果返回true则说明错误被处理了，不会向下进行传递，</span></span><br><span class="line">    <span class="comment">// 可以根据错误和其他传入参数进行一些处理。返回false则错误会继续由Glide进行处理。onResourceReady也是同理，可以在结果最终返回之前，进行各种处理。</span></span><br><span class="line">    RequestListener listener = <span class="keyword">new</span> RequestListener&lt;String, GlideDrawable&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onException</span><span class="params">(Exception e, String model, Target&lt;GlideDrawable&gt; target, <span class="keyword">boolean</span> isFirstResource)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onResourceReady</span><span class="params">(GlideDrawable resource, String model, Target&lt;GlideDrawable&gt; target, <span class="keyword">boolean</span> isFromMemoryCache, <span class="keyword">boolean</span> isFirstResource)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Target是接受最终结果的地方，这里举了一个SimpleTarget的类型，它可以把最终的Bitmap或其他类型自己处理而不是直接显示到ImageView中。</span></span><br><span class="line">    Target&lt;Bitmap&gt; target = <span class="keyword">new</span> SimpleTarget&lt;Bitmap&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Bitmap resource, GlideAnimation glideAnimation)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    DrawableRequestBuilder requestBuilder = Glide.with(<span class="keyword">this</span>).load(url);</span><br><span class="line"></span><br><span class="line">    Glide.with(getApplicationContext()) <span class="comment">// 指定Context,with方法是用于创建一个加载图片的实例，可以传入Activity、Fragment、ApplicationContext，</span></span><br><span class="line">            <span class="comment">// 传入不同的参数可以决定Glide的生命周期，可以理解成OkHttpClient</span></span><br><span class="line">            .load(url)<span class="comment">// 指定图片的URL</span></span><br><span class="line">            <span class="comment">//显示gif</span></span><br><span class="line">            .asGif()<span class="comment">//glide可以用非常简单的代码展示GIF图和MP4，这算是Glide的优势之一，其他框架有的不支持，有的会比较麻烦,只能放在load方法后面</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//占位图Api</span></span><br><span class="line">            .placeholder(R.mipmap.ic_launcher)<span class="comment">// 为设置图片加载前占位图,指定图片未成功加载前显示的图片，不能再放网络图片url</span></span><br><span class="line">            .error(R.mipmap.ic_launcher)<span class="comment">// 为设置加载出错后占位图,指定图片加载失败显示的图片，也可以采取异常回调，一般处理就用error就可以了</span></span><br><span class="line">            .fallback(R.mipmap.ic_launcher)<span class="comment">//fallback为设置load函数传入null时的占位图</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//图片裁剪Api</span></span><br><span class="line">            .override(<span class="number">300</span>, <span class="number">300</span>)<span class="comment">//!!!指定图片的尺寸，避免内存浪费</span></span><br><span class="line">            .fitCenter()<span class="comment">//裁剪技术，指定图片缩放类型为fitCenter，fitCenter可以根据imageview的大小按比例缩小图片，让图片完全显示出来，但是如果图片宽高比和imageview不同，就会造成imageview留白</span></span><br><span class="line">            .centerCrop()<span class="comment">// 裁剪技术，指定图片缩放类型为centerCrop，centerCrop可以根据imageview大小按比例放大图片，让图片完全充满imageview，如果图片宽高比和imageview不同就会显示不全</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//加载动画Api</span></span><br><span class="line">            .crossFade(<span class="number">300</span>)</span><br><span class="line">            .animate(R.anim.move)<span class="comment">//加载动画可以使我们图片加载过程效果更平滑顺畅,Glide默认使用crossFade动画，时间是300毫秒，当然可以设置其他时间；animate函数可以传入自定义动画，参数为Animator，Animation或者动画资源id</span></span><br><span class="line">            .dontAnimate()<span class="comment">//不使用任何动画</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//缩略图Api</span></span><br><span class="line">            <span class="comment">//当图片比较大，不能很快加载，或者像listview等快速浏览控件中展示，或者网络比较慢的时候大图需要长时间下载等情况，我们可以使用缩略图先进行大概展示，等原图完全加载到内存再高清展示。</span></span><br><span class="line">            <span class="comment">// 缩略图跟占位图的差别：1 缩略图一般是原图的低品质图，是原图已在本地后进行提取的，2 缩略图可以从网络动态加载，展位图只能是本地资源。</span></span><br><span class="line">            .thumbnail(<span class="number">0.1f</span>)<span class="comment">//缩略图函数thumbnail有两个重载函数，1 参数为浮点型，代表缩略图取原图大小的百分比，0.1f即原图大小*0.1，在原图比较大的时候会先显示一个其十分之一大小的低品质图；</span></span><br><span class="line">            .thumbnail(requestBuilder)<span class="comment">//2 参数类型为DrawableRequestBuilder ，缩略图从网络下载，当原图太大需要长时间下载，则可以先加载一个小图。总之可以理解缩略图为一种更好的占位图，让我们预先了解到原图的梗概。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//缓存相关Api</span></span><br><span class="line">            .skipMemoryCache(<span class="keyword">true</span>)<span class="comment">// 跳过内存缓存，意味着不会将加载的图片放到内存缓存中，默认是使用false</span></span><br><span class="line">            .diskCacheStrategy(DiskCacheStrategy.NONE)<span class="comment">//跳过磁盘缓存,不缓存</span></span><br><span class="line">            .diskCacheStrategy(DiskCacheStrategy.SOURCE)<span class="comment">//仅仅只缓存原来的全分辨率的图像,只缓存原始图片</span></span><br><span class="line">            .diskCacheStrategy(DiskCacheStrategy.RESULT)<span class="comment">//仅仅缓存最终的图像，将原图降低分辨率后的图片,只缓存转换后图片</span></span><br><span class="line">            .diskCacheStrategy(DiskCacheStrategy.ALL)<span class="comment">//缓存所有版本的图像,缓存原始图片和转换后图片</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//优先级APi</span></span><br><span class="line">            .priority(Priority.HIGH)<span class="comment">//指定优先级.Glide将会用他们作为一个准则，并尽可能的处理这些请求，但是它不能保证所有的图片都会按照所要求的顺序加载。优先级排序:IMMEDIATE &gt; HIGH &gt; NORMAL &gt;　LOW</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//回调Api</span></span><br><span class="line">            .listener(listener)<span class="comment">//RequestListener是对过程进行拦截的，可以拦截错误状态和成功的结果。在onException中如果返回true则说明错误被处理了，不会向下进行传递，可以根据错误和其他传入参数进行一些处理。返回false则错误会继续由Glide进行处理。onResourceReady也是同理，可以在结果最终返回之前，进行各种处理</span></span><br><span class="line">            <span class="comment">//.into(target)//Target是接受最终结果的地方，这里举了一个SimpleTarget的类型，它可以把最终的Bitmap或其他类型自己处理而不是直接显示到ImageView中。</span></span><br><span class="line"></span><br><span class="line">            .into(imageView);<span class="comment">//指定显示图片的ImageView</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *以上是Glide的简单使用，当然Glide还支持扩展各种特效，比如高斯模糊、蒙版、各种过滤器等这些高级用法，</span></span><br><span class="line"><span class="comment">     * 一般和GitHub的https://github.com/wasabeef/glide-transformations这个特效库联合使用.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Glide源码整体流程梳理"><a href="#Glide源码整体流程梳理" class="headerlink" title="Glide源码整体流程梳理"></a>Glide源码整体流程梳理</h2><h3 id="几个概念"><a href="#几个概念" class="headerlink" title="几个概念"></a>几个概念</h3><p><strong>Model</strong>：要加载的图片数据源，可以是URL、本地资源、资源ID类型等<br><strong>Data</strong>：从数据源中获取的Model要加工成原始数据，一般会是InputStream，而从Model变成Data的过程叫做ModelLoader<br><strong>Resource</strong>：对原始数据进行解码之后的数据称为Resources，比如将InputStream解码成Bitmap，而解码之后的资源也就是Bitmap，我们称为Resource<br><strong>TransformedResource</strong>：对图片进行裁剪之后的数据称为TransformedResources，对资源Resource(Bitmap)进行裁剪、变换等操作，在Glide中用ResourceTransformed实现，而转换后的资源<br>我们称为TransformedResource<br><strong>TranscodedResource</strong>：Glide可以加载gif动态图，但是解码后的bitmap和XxDrawable其实类型是不统一的，为了逻辑方便处理，Glide就会吧Bitmap转换成XxBitmapDrawable,<br>负责转码的角色称为Transcode，而转码完成之后的角色称为TranscodedResources<br><strong>Target</strong>：将要显示的图片封装成Target，将资源封装成Target交给ImageView</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Model---(ModelLoader)---&gt;Data(原始数据)---(Decoder解码、ResourceTranscoder)---&gt;Resource---(Transform裁剪变换)---&gt;TransformedResource---(Transcode转码操作)---&gt;TranscodedResource---(封装)---&gt;Target</span><br><span class="line">url                     InputStream                                          Bitmap  </span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="主流程图"><a href="#主流程图" class="headerlink" title="主流程图"></a>主流程图</h3><p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-2a274eebbf9c66cf.jpg"  alt="img"></p>
<p>三件大事：</p>
<ul>
<li>“准备数据”。Glide中存在着大量的类和对象，而Glide的做法是在最开始的时候，都尽量把各种将来要用的对象就构造出来，并按需封装起来，然后层层向后面的流程进行传递。漫长的调用链条中，时不时就要用到最开始就创建好的对象，并且可能经过层层的解封装才能拿到真正想要用到的对象。也正是因此，使得读者往往迷失其中，造成了Glide源代码阅读起来较为困难。<br> 但仔细阅读代码，还是可以看出规律，“准备数据”其实可以划分两件小事：第一阶段，构建出GenericRequest对象，该对象封装了大量对象于一身，并且这些对象受用户调用API或者修改配置所影响；第二阶段，从GenericRequest对象中，解封装拿到需要的对象，构建出decodeJob对象，该对象是“异步处理”中的核心对象。可以这样理解：GenericRequest对象面向用户而构建，decodeJob对象面向Glide而构建。</li>
<li>“异步处理”。经过前面的大量准备工作，这一步，在工作线程中，Glide就要开始大干拳脚了。可以划分为三件小事：发起网络请求，拿到数据流；将数据流解码成bitmap对象；将bitmap对象转码成Drawable对象。</li>
<li>“切换到主线程”：满足要求的Drawable对象已经拿到，那么我们就要切换回主线程，目的是将其显示出来。这一步主要就是一件小事：显示Drawable。</li>
</ul>
<h3 id="主流程细化"><a href="#主流程细化" class="headerlink" title="主流程细化"></a>主流程细化</h3><h4 id="with"><a href="#with" class="headerlink" title="with"></a>with</h4><blockquote>
<p>Glide.with(this).load(url).into(imageView);</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RequestManager Glide.with(context)</span><br></pre></td></tr></table></figure>





<p>with属于“准备数据”之“第一阶段”，我们先展示其时序图:</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-bbd54d9ebab56d7d.jpg"  alt="img"></p>
<blockquote>
<p>从上图我们可以看出，with的代码流程，还是比较简单，最终会返回一个<strong>RequestManager</strong>类型的对象，以供下一步调用。<br> 另外需要说明的是：</p>
<ul>
<li>with中传入的参数，决定了图片加载的生命周期。</li>
<li>如果在工作线程中使用Glide，不管with中传入参数是什么，Glide生命周期都与Application对象的生命周期一致。</li>
</ul>
</blockquote>
<p><strong>RequestManager</strong>作用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 管理图片加载请求</span><br><span class="line">2. 完成Glide对象的构造</span><br><span class="line">3. 控制整个界面生命周期的监听</span><br></pre></td></tr></table></figure>





<p><strong>源码拆分：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>).load(url).into(imageView);</span><br></pre></td></tr></table></figure>



<h5 id="Glide类"><a href="#Glide类" class="headerlink" title="Glide类"></a>Glide类</h5><p>Glide提供了一系列的with静态重载方法，目的就是为了将我们图片加载与组件的生命周期相挂钩</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Retriever:金毛寻回犬</span></span><br><span class="line">    <span class="comment">//RequestManagerRetriever：主要目的是产生RequestManager，而RequestManager可以简单理解为处理图片加载请求，RequestManager就是对请求进行管理。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">        <span class="keyword">return</span> retriever.get(context);<span class="comment">// retriever.get也有多个重载</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先获取RequestManager对象，然后调用retriever.get()方法，我们进入到RequestManagerRetriever类中。</p>
<h5 id="RequestManagerRetriever类"><a href="#RequestManagerRetriever类" class="headerlink" title="RequestManagerRetriever类"></a>RequestManagerRetriever类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestManagerRetriever INSTANCE = <span class="keyword">new</span> RequestManagerRetriever();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> RequestManager applicationManager;</span><br><span class="line">    </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManagerRetriever <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *RequestManagerRetriever的get方法有多个重载，我们可以把它分为两类:Application和非Application的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You cannot start a load on a null Context"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;<span class="comment">//判断是不是在主线程</span></span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                <span class="keyword">return</span> get((FragmentActivity) context);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">                <span class="keyword">return</span> get((Activity) context);<span class="comment">//传入的是Activity上下文</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">                <span class="keyword">return</span> get(((ContextWrapper) context).getBaseContext());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果传进来的是Application上下文，则会返回唯一的RequestManager applicationManager，然后用他进行网络图片的处理</span></span><br><span class="line">        <span class="keyword">return</span> getApplicationManager(context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//返回了单例的RequestManager对象applicationManager</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RequestManager <span class="title">getApplicationManager</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Either an application context or we're on a background thread.</span></span><br><span class="line">        <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Normally pause/resume is taken care of by the fragment we add to the fragment or activity.</span></span><br><span class="line">                    <span class="comment">// However, in this case since the manager attached to the application will not receive lifecycle</span></span><br><span class="line">                    <span class="comment">// events, we must force the manager to start resumed using ApplicationLifecycle.</span></span><br><span class="line">                    applicationManager = <span class="keyword">new</span> RequestManager(context.getApplicationContext(),</span><br><span class="line">                            <span class="keyword">new</span> ApplicationLifecycle(), <span class="keyword">new</span> EmptyRequestManagerTreeNode());<span class="comment">//new 实例化出RequestManager</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> applicationManager;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Util.isOnBackgroundThread() || Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">            <span class="comment">//子线程进入这里，然后调用ApplicationContext的方法，返回单例的RequestManager对象applicationManager</span></span><br><span class="line">            <span class="keyword">return</span> get(activity.getApplicationContext());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果是在UI线程中调用的，则会进入这里</span></span><br><span class="line">            assertNotDestroyed(activity);</span><br><span class="line">            <span class="comment">//回顾FragmentManager作用是将Fragment加入的Activity中</span></span><br><span class="line">            android.app.FragmentManager fm = activity.getFragmentManager();</span><br><span class="line">            <span class="keyword">return</span> fragmentGet(activity, fm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RequestManagerFragment:继承Fragment，里面有个成员变量requestManager。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 回想一下Fragment添加到Activity两种方式，一种是有界面的，一种是无界面的。</span></span><br><span class="line"><span class="comment">     * 而glide就是用到了无界面添加，创建了一个无UI的Fragment添加到Activity中，主要目的还是监听Activity的生命周期。</span></span><br><span class="line"><span class="comment">     * glide是无法直接监听Activity生命周期，而可以通过空的RequestManagerFragment来监听的，从而绑定Activity生命周期，来选择图片加载的过程。</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * RequestManager作用：</span></span><br><span class="line"><span class="comment">     * 1. 管理图片加载请求</span></span><br><span class="line"><span class="comment">     * 2. 完成Glide对象的构造</span></span><br><span class="line"><span class="comment">     * 3. 控制整个界面生命周期的监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</span><br><span class="line">    <span class="function">RequestManager <span class="title">fragmentGet</span><span class="params">(Context context, android.app.FragmentManager fm)</span> </span>&#123;</span><br><span class="line">        RequestManagerFragment current = getRequestManagerFragment(fm);<span class="comment">//创建空的Fragment，思考：空的Fragment是如何和requestManager建立关系的呢？</span></span><br><span class="line">        RequestManager requestManager = current.getRequestManager();</span><br><span class="line">        <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            requestManager = <span class="keyword">new</span> RequestManager(context, current.getLifecycle(), current.getRequestManagerTreeNode());<span class="comment">//new 实例化出RequestManager</span></span><br><span class="line">            current.setRequestManager(requestManager);<span class="comment">//!!!非常重要，调用setRequestManager方法之后，就将空的Fragment和创建好的requestManager进行了绑定</span></span><br><span class="line">            <span class="comment">//目的：将监听Activity生命周期和图片加载关联了在一起，一个RequestManagerFragment对应一个requestManager</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> requestManager;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建RequestManagerFragment对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.JELLY_BEAN_MR1)</span><br><span class="line">    <span class="function">RequestManagerFragment <span class="title">getRequestManagerFragment</span><span class="params">(<span class="keyword">final</span> android.app.FragmentManager fm)</span> </span>&#123;</span><br><span class="line">        RequestManagerFragment current = (RequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">        <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">            current = pendingRequestManagerFragments.get(fm);</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">                current = <span class="keyword">new</span> RequestManagerFragment();</span><br><span class="line">                pendingRequestManagerFragments.put(fm, current);</span><br><span class="line">                fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">                handler.obtainMessage(ID_REMOVE_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> current;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RequestManagerRetriever的get方法有多个重载，我们可以把它分为两类:Application和非Application的，先看Application的情况，调用getApplicationManager(context)方法，返回了单例的RequestManager对象applicationManager，new 实例化出RequestManager。后面我们会看RequestManager的构造函数都做了哪些操作。</p>
<p>假如传入的是Activity则会调用return get((Activity) context)方法，检查线程如果是在子线程调用的Glide.with()方法，则返回单例的RequestManager对象applicationManager。</p>
<p>如果是在UI线程中调用的则会先获取FragmentManager对象，然后调用fragmentGet(activity, fm)方法，我们进入看到：</p>
<ol>
<li>通过getRequestManagerFragment方法获取RequestManagerFragment对象</li>
<li>创建RequestManager对象，new 实例化出RequestManager</li>
<li>将RequestManagerFragment对象和RequestManager进行关联</li>
</ol>
<p>这里我们简单看一下RequestManagerFragment类：</p>
<h5 id="RequestManagerFragment类"><a href="#RequestManagerFragment类" class="headerlink" title="RequestManagerFragment类"></a>RequestManagerFragment类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="comment">//思考：空的Fragment是如何和requestManager建立关系的呢？关键就在于ActivityFragmentLifecycle，</span></span><br><span class="line">    <span class="comment">//其实RequestManager就是在RequestManagerFragment里面注册了一些生命周期的回调接口，比如这个类当中onStart、onStop方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityFragmentLifecycle lifecycle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestManagerTreeNode requestManagerTreeNode = <span class="keyword">new</span> FragmentRequestManagerTreeNode();</span><br><span class="line">    <span class="keyword">private</span> RequestManager requestManager;<span class="comment">//这里是将RequestManagerFragment和RequestManager进行关联的重要环节</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;RequestManagerFragment&gt; childRequestManagerFragments</span><br><span class="line">            = <span class="keyword">new</span> HashSet&lt;RequestManagerFragment&gt;();</span><br><span class="line">    <span class="keyword">private</span> RequestManagerFragment rootRequestManagerFragment;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestManagerFragment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> ActivityFragmentLifecycle());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For testing only.</span></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"ValidFragment"</span>)</span><br><span class="line">    RequestManagerFragment(ActivityFragmentLifecycle lifecycle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the current &#123;<span class="doctag">@link</span> RequestManager&#125;.</span></span><br><span class="line"><span class="comment">     * 将RequestManagerFragment和RequestManager进行关联</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestManager The request manager to use.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRequestManager</span><span class="params">(RequestManager requestManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.requestManager = requestManager;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();<span class="comment">//调用父类的onStart方法</span></span><br><span class="line">        lifecycle.onStart();<span class="comment">//调用成员变量lifecycle的onStart方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        lifecycle.onStop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        lifecycle.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>小结：</strong></p>
<blockquote>
<p>with方法主要是做些基础工作，返回RequestManager。RequestManager的产生又是通过RequestManagerRetriever这个类获取的，<br>首先创建了一个空的Fragment也就是RequestManagerFragment current，然后new出来RequestManager对象，调用的方法为：new RequestManager(context, current.getLifecycle(), current.getRequestManagerTreeNode())<br>通过current.setRequestManager(requestManager);//!!!非常重要，调用setRequestManager方法之后，就将空的Fragment和创建好的requestManager进行了绑定</p>
<p>补充：巧妙的用到的可以添加一个没有界面的Fragment，因为Fragment是和Activity生命周期绑定的。通过RequestManagerFragment来监听Activity的生命周期。<br>RequestManager除了管理和请求外，还有Glide的对象构造，控制Glide方法中的各种方法。还有就是可以控制整个界面的生命周期的监听。</p>
</blockquote>
<h4 id="load"><a href="#load" class="headerlink" title="load"></a>load</h4><blockquote>
<p>Glide.with(this).load(url).into(imageView);</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DrawableTypeRequest RequestManager.load(url)</span><br></pre></td></tr></table></figure>

<p>load属于“准备数据”之“第一阶段”，我们先展示其时序图：</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-c8de90a2e5d97d51.jpg"  alt="img"></p>
<p>从上图我们可以看出，load的代码流程，稍微复杂了一些，但是实质上还是做前期的数据准备，主要就是构造对象，封装对象。<br> 另外需要说明的是：</p>
<ul>
<li>load中的参数可以多种多样，这里我们以传入String对象为例，进行讲解。</li>
<li>图中的streamModelLoader实际上是StreamStringLoader，没有注释由来。简单说一下：主要是因为在Glide对象的构造过程中就注册了对应关系，这里只是通过这层对应关系，找到了StreamStringLoader对象而已。在后面的“替换组件”章节，还会提到这一段代码的。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register(String<span class="class">.<span class="keyword">class</span>, <span class="title">InputStream</span>.<span class="title">class</span>, <span class="title">new</span> <span class="title">StreamStringLoader</span>.<span class="title">Factory</span>())</span>;</span><br></pre></td></tr></table></figure>



<p>分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">也是做了一些初始化工作，最终返回了DrawableTypeRequest对象，通过这个对象我们可以获取请求对象的Request</span><br><span class="line">源码分析注意项：</span><br><span class="line">   1. 一个方法功能是什么，做了哪些工作？</span><br><span class="line">   2. 这个方法返回值是什么？返回值类型代表什么意义。</span><br><span class="line">总结：load方法也是一些初始化操作，主要是获得DrawableTypeRequest对象。而到了最后的into方法，才会用到这个DrawableRequest、tracker等对象方法。</span><br><span class="line">继承关系：DrawableTypeRequest--&gt;DrawableRequestBuilder--&gt;GenericRequestBuilder</span><br></pre></td></tr></table></figure>



<p><strong>源码拆分：</strong></p>
<h5 id="RequestManager类"><a href="#RequestManager类" class="headerlink" title="RequestManager类"></a>RequestManager类</h5><p>作用：</p>
<blockquote>
<ol>
<li>管理图片加载请求</li>
<li>完成Glide对象的构造</li>
<li>控制整个界面生命周期的监听</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context context;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lifecycle lifecycle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestManagerTreeNode treeNode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestTracker requestTracker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Glide glide;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OptionsApplier optionsApplier;</span><br><span class="line">    <span class="keyword">private</span> DefaultOptions options;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestManager</span><span class="params">(Context context, Lifecycle lifecycle, RequestManagerTreeNode treeNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, lifecycle, treeNode, <span class="keyword">new</span> RequestTracker(), <span class="keyword">new</span> ConnectivityMonitorFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RequestManager(Context context, <span class="keyword">final</span> Lifecycle lifecycle, RequestManagerTreeNode treeNode,</span><br><span class="line">                   RequestTracker requestTracker, ConnectivityMonitorFactory factory) &#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context.getApplicationContext();</span><br><span class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</span><br><span class="line">        <span class="keyword">this</span>.treeNode = treeNode;</span><br><span class="line">        <span class="keyword">this</span>.requestTracker = requestTracker;</span><br><span class="line">        <span class="keyword">this</span>.glide = Glide.get(context);<span class="comment">//初始化Glide对象</span></span><br><span class="line">        <span class="keyword">this</span>.optionsApplier = <span class="keyword">new</span> OptionsApplier();</span><br><span class="line"></span><br><span class="line">        ConnectivityMonitor connectivityMonitor = factory.build(context,</span><br><span class="line">                <span class="keyword">new</span> RequestManagerConnectivityListener(requestTracker));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we're the application level request manager, we may be created on a background thread. In that case we</span></span><br><span class="line">        <span class="comment">// cannot risk synchronously pausing or resuming requests, so we hack around the issue by delaying adding</span></span><br><span class="line">        <span class="comment">// ourselves as a lifecycle listener by posting to the main thread. This should be entirely safe.</span></span><br><span class="line">        <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">            <span class="keyword">new</span> Handler(Looper.getMainLooper()).post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    lifecycle.addListener(RequestManager.<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lifecycle.addListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        lifecycle.addListener(connectivityMonitor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//DrawableTypeRequest:代表glide当中，加载图片的所有请求</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;String&gt; <span class="title">load</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (DrawableTypeRequest&lt;String&gt;) fromString().load(string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;Uri&gt; <span class="title">load</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (DrawableTypeRequest&lt;Uri&gt;) fromUri().load(uri);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;File&gt; <span class="title">load</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (DrawableTypeRequest&lt;File&gt;) fromFile().load(file);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;String&gt; <span class="title">fromString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loadGeneric(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;File&gt; <span class="title">fromFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loadGeneric(File<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">DrawableTypeRequest&lt;T&gt; <span class="title">loadGeneric</span><span class="params">(Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建两个ModelLoader，而ModelLoader作用就是将我们的数据来源Model(url、file)加载成原始数据Data(InputStream)</span></span><br><span class="line">        ModelLoader&lt;T, InputStream&gt; streamModelLoader = Glide.buildStreamModelLoader(modelClass, context);</span><br><span class="line">        ModelLoader&lt;T, ParcelFileDescriptor&gt; fileDescriptorModelLoader = Glide.buildFileDescriptorModelLoader(modelClass, context);</span><br><span class="line">        <span class="keyword">if</span> (modelClass != <span class="keyword">null</span> &amp;&amp; streamModelLoader == <span class="keyword">null</span> &amp;&amp; fileDescriptorModelLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown type "</span> + modelClass + <span class="string">". You must provide a Model of a type for"</span></span><br><span class="line">                    + <span class="string">" which there is a registered ModelLoader, if you are using a custom model, you must first call"</span></span><br><span class="line">                    + <span class="string">" Glide#register with a ModelLoaderFactory for your custom model class"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> optionsApplier.apply(</span><br><span class="line">                <span class="keyword">new</span> DrawableTypeRequest&lt;T&gt;(modelClass, streamModelLoader, fileDescriptorModelLoader, context,</span><br><span class="line">                        glide, requestTracker, lifecycle, optionsApplier));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>分析：</p>
<ol>
<li>在RequestManager构造函数中有这样一句话this.glide = Glide.get(context)是用来初始化Glide对象的</li>
<li>RequestManager类中也有很多load方法的重载，我们只对String参数做分析<ol>
<li>load(url)–&gt;fromString()–&gt;loadGenerice(String.class)–&gt;retrun new DrawableTypeRequest，在DrawableTypeRequest的构造函数中，关键方法buildProvider</li>
<li>DrawableTypeRequest.load(url)</li>
</ol>
</li>
</ol>
<p>DrawableTypeRequest继承DrawableRequestBuilder，DrawableRequestBuilder继承GenericRequestBuilder</p>
<h5 id="DrawableTypeRequest类"><a href="#DrawableTypeRequest类" class="headerlink" title="DrawableTypeRequest类"></a>DrawableTypeRequest类</h5><p>作用：</p>
<blockquote>
<p>这个类的主要作用是将我们的图片转成bitmap或gif</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个类的主要作用是将我们的图片转成bitmap或gif</span></span><br><span class="line"><span class="comment"> * 里面有两个重要的方法：</span></span><br><span class="line"><span class="comment"> * BitmapTypeRequest asBitmap</span></span><br><span class="line"><span class="comment"> * GifTypeRequest asGif</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawableTypeRequest</span>&lt;<span class="title">ModelType</span>&gt; <span class="keyword">extends</span> <span class="title">DrawableRequestBuilder</span>&lt;<span class="title">ModelType</span>&gt; <span class="keyword">implements</span> <span class="title">DownloadOptions</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RequestManager.OptionsApplier optionsApplier;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个方法返回FixedLoadProvider，实际是实现了LoadProvider接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;A, Z, R&gt; <span class="function">FixedLoadProvider&lt;A, ImageVideoWrapper, Z, R&gt; <span class="title">buildProvider</span><span class="params">(Glide glide,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                                         ModelLoader&lt;A, InputStream&gt; streamModelLoader, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                                         ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorModelLoader, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                                         Class&lt;Z&gt; resourceClass, Class&lt;R&gt; transcodedClass, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                                         ResourceTranscoder&lt;Z, R&gt; transcoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (streamModelLoader == <span class="keyword">null</span> &amp;&amp; fileDescriptorModelLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断ResourceTranscoder是否为空，ResourceTranscoder的作用就是对Data原始数据进行解码（Data--&gt;Resource）</span></span><br><span class="line">        <span class="keyword">if</span> (transcoder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            transcoder = glide.buildTranscoder(resourceClass, transcodedClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//DataLoadProvider:用于图片的编解码，是一个接口，有一个实现类是LoadProvider</span></span><br><span class="line">        DataLoadProvider&lt;ImageVideoWrapper, Z&gt; dataLoadProvider = glide.buildDataProvider(ImageVideoWrapper<span class="class">.<span class="keyword">class</span>, <span class="title">resourceClass</span>)</span>;</span><br><span class="line">        <span class="comment">//内部封装了streamModelLoader和fileDescriptorModelLoader</span></span><br><span class="line">        ImageVideoModelLoader&lt;A&gt; modelLoader = <span class="keyword">new</span> ImageVideoModelLoader&lt;A&gt;(streamModelLoader, fileDescriptorModelLoader);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FixedLoadProvider&lt;A, ImageVideoWrapper, Z, R&gt;(modelLoader, transcoder, dataLoadProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DrawableTypeRequest(Class&lt;ModelType&gt; modelClass, ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader,</span><br><span class="line">                        ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader, Context context, Glide glide,</span><br><span class="line">                        RequestTracker requestTracker, Lifecycle lifecycle, RequestManager.OptionsApplier optionsApplier) &#123;</span><br><span class="line">        <span class="keyword">super</span>(context, modelClass, buildProvider(glide, streamModelLoader, fileDescriptorModelLoader, GifBitmapWrapper<span class="class">.<span class="keyword">class</span>, <span class="title">GlideDrawable</span>.<span class="title">class</span>, <span class="title">null</span>),</span></span><br><span class="line"><span class="class">                <span class="title">glide</span>, <span class="title">requestTracker</span>, <span class="title">lifecycle</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.streamModelLoader = streamModelLoader;</span><br><span class="line">        <span class="keyword">this</span>.fileDescriptorModelLoader = fileDescriptorModelLoader;</span><br><span class="line">        <span class="keyword">this</span>.optionsApplier = optionsApplier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to always load the resource as a &#123;<span class="doctag">@link</span> android.graphics.Bitmap&#125;, even if it could actually be animated.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A new request builder for loading a &#123;<span class="doctag">@link</span> android.graphics.Bitmap&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BitmapTypeRequest&lt;ModelType&gt; <span class="title">asBitmap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> optionsApplier.apply(<span class="keyword">new</span> BitmapTypeRequest&lt;ModelType&gt;(<span class="keyword">this</span>, streamModelLoader,</span><br><span class="line">                fileDescriptorModelLoader, optionsApplier));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempts to always load the resource as a &#123;<span class="doctag">@link</span> com.bumptech.glide.load.resource.gif.GifDrawable&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * If the underlying data is not a GIF, this will fail. As a result, this should only be used if the model</span></span><br><span class="line"><span class="comment">     * represents an animated GIF and the caller wants to interact with the GIfDrawable directly. Normally using</span></span><br><span class="line"><span class="comment">     * just an &#123;<span class="doctag">@link</span> DrawableTypeRequest&#125; is sufficient because it will determine whether or</span></span><br><span class="line"><span class="comment">     * not the given data represents an animated GIF and return the appropriate animated or not animated</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> android.graphics.drawable.Drawable&#125; automatically.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A new request builder for loading a &#123;<span class="doctag">@link</span> com.bumptech.glide.load.resource.gif.GifDrawable&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GifTypeRequest&lt;ModelType&gt; <span class="title">asGif</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> optionsApplier.apply(<span class="keyword">new</span> GifTypeRequest&lt;ModelType&gt;(<span class="keyword">this</span>, streamModelLoader, optionsApplier));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;Y extends Target&lt;File&gt;&gt; <span class="function">Y <span class="title">downloadOnly</span><span class="params">(Y target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDownloadOnlyRequest().downloadOnly(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FutureTarget&lt;File&gt; <span class="title">downloadOnly</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getDownloadOnlyRequest().downloadOnly(width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GenericTranscodeRequest&lt;ModelType, InputStream, File&gt; <span class="title">getDownloadOnlyRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> optionsApplier.apply(<span class="keyword">new</span> GenericTranscodeRequest&lt;ModelType, InputStream, File&gt;(File<span class="class">.<span class="keyword">class</span>, <span class="title">this</span>,</span></span><br><span class="line"><span class="class">                <span class="title">streamModelLoader</span>, <span class="title">InputStream</span>.<span class="title">class</span>, <span class="title">File</span>.<span class="title">class</span>, <span class="title">optionsApplier</span>))</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="DrawableRequestBuilder类（DrawableTypeRequest的父类）"><a href="#DrawableRequestBuilder类（DrawableTypeRequest的父类）" class="headerlink" title="DrawableRequestBuilder类（DrawableTypeRequest的父类）"></a>DrawableRequestBuilder类（DrawableTypeRequest的父类）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要功能：对glide初始化参数的配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawableRequestBuilder</span>&lt;<span class="title">ModelType</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">GenericRequestBuilder</span>&lt;<span class="title">ModelType</span>, <span class="title">ImageVideoWrapper</span>, <span class="title">GifBitmapWrapper</span>, <span class="title">GlideDrawable</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">BitmapOptions</span>, <span class="title">DrawableOptions</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    DrawableRequestBuilder(Context context, Class&lt;ModelType&gt; modelClass,</span><br><span class="line">                           LoadProvider&lt;ModelType, ImageVideoWrapper, GifBitmapWrapper, GlideDrawable&gt; loadProvider, Glide glide,</span><br><span class="line">                           RequestTracker requestTracker, Lifecycle lifecycle) &#123;</span><br><span class="line">        <span class="keyword">super</span>(context, modelClass, loadProvider, GlideDrawable<span class="class">.<span class="keyword">class</span>, <span class="title">glide</span>, <span class="title">requestTracker</span>, <span class="title">lifecycle</span>)</span>;</span><br><span class="line">        <span class="comment">// Default to animating.</span></span><br><span class="line">        crossFade();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h5 id="GenericRequestBuilder类（DrawableRequestBuilder的父类）"><a href="#GenericRequestBuilder类（DrawableRequestBuilder的父类）" class="headerlink" title="GenericRequestBuilder类（DrawableRequestBuilder的父类）"></a>GenericRequestBuilder类（DrawableRequestBuilder的父类）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericRequestBuilder</span>&lt;<span class="title">ModelType</span>, <span class="title">DataType</span>, <span class="title">ResourceType</span>, <span class="title">TranscodeType</span>&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">        GenericRequestBuilder(Context context, Class&lt;ModelType&gt; modelClass,</span><br><span class="line">            LoadProvider&lt;ModelType, DataType, ResourceType, TranscodeType&gt; loadProvider,</span><br><span class="line">            Class&lt;TranscodeType&gt; transcodeClass, Glide glide, RequestTracker requestTracker, Lifecycle lifecycle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        <span class="keyword">this</span>.modelClass = modelClass;</span><br><span class="line">        <span class="keyword">this</span>.transcodeClass = transcodeClass;</span><br><span class="line">        <span class="keyword">this</span>.glide = glide;</span><br><span class="line">        <span class="keyword">this</span>.requestTracker = requestTracker;</span><br><span class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</span><br><span class="line">        <span class="keyword">this</span>.loadProvider = loadProvider != <span class="keyword">null</span></span><br><span class="line">                ? <span class="keyword">new</span> ChildLoadProvider&lt;ModelType, DataType, ResourceType, TranscodeType&gt;(loadProvider) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Context can't be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (modelClass != <span class="keyword">null</span> &amp;&amp; loadProvider == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"LoadProvider must not be null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> 	<span class="comment">//....</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="Glide类-1"><a href="#Glide类-1" class="headerlink" title="Glide类"></a>Glide类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Glide</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Glide glide;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GenericLoaderFactory loaderFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Engine engine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BitmapPool bitmapPool;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MemoryCache memoryCache;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DecodeFormat decodeFormat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImageViewTargetFactory imageViewTargetFactory = <span class="keyword">new</span> ImageViewTargetFactory();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TranscoderRegistry transcoderRegistry = <span class="keyword">new</span> TranscoderRegistry();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataLoadProviderRegistry dataLoadProviderRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CenterCrop bitmapCenterCrop;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GifBitmapWrapperTransformation drawableCenterCrop;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FitCenter bitmapFitCenter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GifBitmapWrapperTransformation drawableFitCenter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mainHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BitmapPreFiller bitmapPreFiller;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Glide<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Context applicationContext = context.getApplicationContext();</span><br><span class="line">                    List&lt;GlideModule&gt; modules = <span class="keyword">new</span> ManifestParser(applicationContext).parse();</span><br><span class="line"></span><br><span class="line">                    GlideBuilder builder = <span class="keyword">new</span> GlideBuilder(applicationContext);</span><br><span class="line">                    <span class="keyword">for</span> (GlideModule <span class="keyword">module</span> : modules) &#123;</span><br><span class="line">                        <span class="keyword">module</span>.applyOptions(applicationContext, builder);</span><br><span class="line">                    &#125;</span><br><span class="line">                    glide = builder.createGlide();</span><br><span class="line">                    <span class="keyword">for</span> (GlideModule <span class="keyword">module</span> : modules) &#123;</span><br><span class="line">                        <span class="keyword">module</span>.registerComponents(applicationContext, glide);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> glide;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GlideBuilder：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlideBuilder</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Engine engine;</span><br><span class="line">    <span class="keyword">private</span> BitmapPool bitmapPool;</span><br><span class="line">    <span class="keyword">private</span> MemoryCache memoryCache;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService sourceService;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService diskCacheService;</span><br><span class="line">    <span class="keyword">private</span> DecodeFormat decodeFormat;</span><br><span class="line">    <span class="keyword">private</span> DiskCache.Factory diskCacheFactory;</span><br><span class="line">    </span><br><span class="line">	<span class="function">Glide <span class="title">createGlide</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sourceService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> cores = Math.max(<span class="number">1</span>, Runtime.getRuntime().availableProcessors());</span><br><span class="line">            sourceService = <span class="keyword">new</span> FifoPriorityThreadPoolExecutor(cores);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (diskCacheService == <span class="keyword">null</span>) &#123;</span><br><span class="line">            diskCacheService = <span class="keyword">new</span> FifoPriorityThreadPoolExecutor(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MemorySizeCalculator calculator = <span class="keyword">new</span> MemorySizeCalculator(context);</span><br><span class="line">        <span class="keyword">if</span> (bitmapPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">                <span class="keyword">int</span> size = calculator.getBitmapPoolSize();</span><br><span class="line">                bitmapPool = <span class="keyword">new</span> LruBitmapPool(size);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bitmapPool = <span class="keyword">new</span> BitmapPoolAdapter();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (memoryCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">            memoryCache = <span class="keyword">new</span> LruResourceCache(calculator.getMemoryCacheSize());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (diskCacheFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            diskCacheFactory = <span class="keyword">new</span> InternalCacheDiskCacheFactory(context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">            engine = <span class="keyword">new</span> Engine(memoryCache, diskCacheFactory, diskCacheService, sourceService);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (decodeFormat == <span class="keyword">null</span>) &#123;</span><br><span class="line">            decodeFormat = DecodeFormat.DEFAULT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Glide(engine, memoryCache, bitmapPool, context, decodeFormat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="into-1"><a href="#into-1" class="headerlink" title="into-1"></a>into-1</h4><blockquote>
<p>Glide.with(this).load(url).into(imageView);</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Target&lt;GlideDrawable&gt; DrawableTypeRequest.into(imageView)--&gt;</span><br><span class="line">Target&lt;GlideDrawable&gt; DrawableRequestBuilder.into(imageView)--&gt;</span><br><span class="line">Target&lt;TranscodeType&gt; GenericRequestBuilder.into(ImageView view)</span><br></pre></td></tr></table></figure>



<p>into比较复杂，其涉及了“准备数据”，“异步处理”，“切换到主线程”这三大步的内容。因为其内容较多，一张时序图实在展示不下，我们会分解成5张时序图，来顺序进行说明。</p>
<p>分析到requestTracker.begin()方法为止</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-4d626aa3d05d1229.jpg"  alt="img"></p>
<p>从上图我们可以看出，into-1的代码流程，实质上还是做数据准备，主要就是构造对象，封装对象。需要关注的是其构造出了GenericRequest对象。<br> 另外需要说明的是：</p>
<ul>
<li>最后调用的into函数接收Target类型的对象，也就是说我们在外部使用Glide时候，可以一步到位，不必传ImageView类型的对象，而直接传递Target类型的对象。而Target实际上是一个接口，可以让我知道图片加载过程中的各种状态，如开始，结束，失败等等。</li>
<li>buildRequest函数，最终将所有相关的对象，都封装到一个<strong>单一</strong>的对象中，即GenericRequest类型的对象。<strong>至此“准备数据”的“第一阶段”完成。从begin函数起，进入“准备数据”的“第二阶段”，此阶段会以GenericRequest对象为单位进行后续流程。</strong> </li>
<li>onLoadStarted和onLoadFailed函数可以显示用户设置的占位符。</li>
<li>如果使用了override() API为图片指定了一个固定的宽高，那么直接调用onSizeReady函数；如果没有指定，那么调用getSize函数，由Glide帮我们计算出宽高，但最终还是会调用会onSizeReady函数。所以这张图的出口就是onSizeReady函数。</li>
</ul>
<p><strong>源码拆分：</strong></p>
<h5 id="DrawableRequestBuilder类"><a href="#DrawableRequestBuilder类" class="headerlink" title="DrawableRequestBuilder类"></a>DrawableRequestBuilder类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawableRequestBuilder</span>&lt;<span class="title">ModelType</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">GenericRequestBuilder</span>&lt;<span class="title">ModelType</span>, <span class="title">ImageVideoWrapper</span>, <span class="title">GifBitmapWrapper</span>, <span class="title">GlideDrawable</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">BitmapOptions</span>, <span class="title">DrawableOptions</span> </span>&#123;</span><br><span class="line"> 	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Target&lt;GlideDrawable&gt; <span class="title">into</span><span class="params">(ImageView view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.into(view);</span><br><span class="line">    &#125;            </span><br><span class="line">            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="GenericRequestBuilder类"><a href="#GenericRequestBuilder类" class="headerlink" title="GenericRequestBuilder类"></a>GenericRequestBuilder类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericRequestBuilder</span>&lt;<span class="title">ModelType</span>, <span class="title">DataType</span>, <span class="title">ResourceType</span>, <span class="title">TranscodeType</span>&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Target&lt;TranscodeType&gt; <span class="title">into</span><span class="params">(ImageView view)</span> </span>&#123;</span><br><span class="line">        Util.assertMainThread();</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> into(glide.buildImageViewTarget(view, transcodeClass));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个方法主要有3个功能</span></span><br><span class="line"><span class="comment">     * 1. 创建图片加载的Request</span></span><br><span class="line"><span class="comment">     * 2. 在创建Request之前要删除Target原先绑定的Request，将新创建的Request绑定到Target上面</span></span><br><span class="line"><span class="comment">     * 3. 发送Request，交给requestTracker来进行响应的跟踪处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(Y target)</span> </span>&#123;</span><br><span class="line">        Util.assertMainThread();</span><br><span class="line">        <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must pass in a non null Target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must first set a model (try #load())"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取当前Target绑定的Request对象</span></span><br><span class="line">        Request previous = target.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">            previous.clear();</span><br><span class="line">            requestTracker.removeRequest(previous);<span class="comment">//将Glide监听Request的工作暂停</span></span><br><span class="line">            previous.recycle();<span class="comment">//将Request对象成员变量赋值为null</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Request request = buildRequest(target);<span class="comment">//如何构建Request？看源码</span></span><br><span class="line">        target.setRequest(request);<span class="comment">//绑定操作，防止因为复用导致图片错位问题</span></span><br><span class="line">        lifecycle.addListener(target);<span class="comment">//设置监听</span></span><br><span class="line">        requestTracker.runRequest(request);<span class="comment">//!!!将创建好的Request请求对象之后，交给RequestTracker去执行这个请求</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>步骤一、glide.buildImageViewTarget(view, transcodeClass)分析：</p>
<ul>
<li>通过一系列调用最终返回GlideDrawableImageViewTarget对象</li>
</ul>
</li>
<li><p>步骤二、GenericRequestBuilder.into(GlideDrawableImageViewTarget)分析</p>
<ul>
<li>创建图片加载的Request，将创建好的Request请求对象之后，交给RequestTracker去执行这个请求</li>
<li>最终会走到GenericRequest类中执行begin()</li>
</ul>
</li>
</ul>
<h5 id="Glide类-2"><a href="#Glide类-2" class="headerlink" title="Glide类"></a>Glide类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Glide</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过工厂构建Target</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;R&gt; <span class="function">Target&lt;R&gt; <span class="title">buildImageViewTarget</span><span class="params">(ImageView imageView, Class&lt;R&gt; transcodedClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> imageViewTargetFactory.buildTarget(imageView, transcodedClass);<span class="comment">//可以理解成返回GlideDrawableImageViewTarget对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="ImageViewTargetFactory类"><a href="#ImageViewTargetFactory类" class="headerlink" title="ImageViewTargetFactory类"></a>ImageViewTargetFactory类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTargetFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> &lt;Z&gt; <span class="function">Target&lt;Z&gt; <span class="title">buildTarget</span><span class="params">(ImageView view, Class&lt;Z&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (GlideDrawable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;<span class="comment">//如果没有调用asBitmap方法会走这里</span></span><br><span class="line">            <span class="keyword">return</span> (Target&lt;Z&gt;) <span class="keyword">new</span> GlideDrawableImageViewTarget(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Bitmap<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">clazz</span>)) </span>&#123;<span class="comment">//调用了asBitmap方法之后会走这里</span></span><br><span class="line">            <span class="keyword">return</span> (Target&lt;Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Drawable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;<span class="comment">//用的比较少</span></span><br><span class="line">            <span class="keyword">return</span> (Target&lt;Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(view);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unhandled class: "</span> + clazz</span><br><span class="line">                    + <span class="string">", try .as*(Class).transcode(ResourceTranscoder)"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="RequestTracker类"><a href="#RequestTracker类" class="headerlink" title="RequestTracker类"></a>RequestTracker类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestTracker</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Most requests will be for views and will therefore be held strongly (and safely) by the view via the tag.</span></span><br><span class="line">    <span class="comment">// However, a user can always pass in a different type of target which may end up not being strongly referenced even</span></span><br><span class="line">    <span class="comment">// though the user still would like the request to finish. Weak references are therefore only really functional in</span></span><br><span class="line">    <span class="comment">// this context for view targets. Despite the side affects, WeakReferences are still essentially required. A user</span></span><br><span class="line">    <span class="comment">// can always make repeated requests into targets other than views, or use an activity manager in a fragment pager</span></span><br><span class="line">    <span class="comment">// where holding strong references would steadily leak bitmaps and/or views.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Request&gt; requests = Collections.newSetFromMap(<span class="keyword">new</span> WeakHashMap&lt;Request, Boolean&gt;());</span><br><span class="line">    <span class="comment">// A set of requests that have not completed and are queued to be run again. We use this list to maintain hard</span></span><br><span class="line">    <span class="comment">// references to these requests to ensure that they are not garbage collected before they start running or</span></span><br><span class="line">    <span class="comment">// while they are paused. See #346.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"MismatchedQueryAndUpdateOfCollection"</span>)</span><br><span class="line">    <span class="comment">//悬挂的结合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Request&gt; pendingRequests = <span class="keyword">new</span> ArrayList&lt;Request&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isPaused;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Starts tracking the given request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        requests.add(request);</span><br><span class="line">        <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">            request.begin();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果正在请求，则加入到悬挂集合当中，set集合</span></span><br><span class="line">            pendingRequests.add(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Visible for testing.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        requests.add(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stops tracking the given request.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">        requests.remove(request);</span><br><span class="line">        pendingRequests.remove(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns &#123;<span class="doctag">@code</span> true&#125; if requests are currently paused, and &#123;<span class="doctag">@code</span> false&#125; otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPaused</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isPaused;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stops any in progress requests.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pauseRequests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isPaused = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (Request request : Util.getSnapshot(requests)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.isRunning()) &#123;</span><br><span class="line">                request.pause();</span><br><span class="line">                pendingRequests.add(request);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Starts any not yet completed or failed requests.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resumeRequests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        isPaused = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Request request : Util.getSnapshot(requests)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!request.isComplete() &amp;&amp; !request.isCancelled() &amp;&amp; !request.isRunning()) &#123;</span><br><span class="line">                request.begin();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pendingRequests.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cancels all requests and clears their resources.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearRequests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Request request : Util.getSnapshot(requests)) &#123;</span><br><span class="line">            request.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        pendingRequests.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Restarts failed requests and cancels and restarts in progress requests.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restartRequests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Request request : Util.getSnapshot(requests)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!request.isComplete() &amp;&amp; !request.isCancelled()) &#123;</span><br><span class="line">                <span class="comment">// Ensure the request will be restarted in onResume.</span></span><br><span class="line">                request.pause();</span><br><span class="line">                <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">                    request.begin();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pendingRequests.add(request);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="GenericRequest类"><a href="#GenericRequest类" class="headerlink" title="GenericRequest类"></a>GenericRequest类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericRequest</span>&lt;<span class="title">A</span>, <span class="title">T</span>, <span class="title">Z</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Request</span>, <span class="title">SizeReadyCallback</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ResourceCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        startTime = LogTime.getLogTime();</span><br><span class="line">        <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">            onException(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = Status.WAITING_FOR_SIZE;</span><br><span class="line">        <span class="comment">//isValidDimensions:判断是否调用了override方法</span></span><br><span class="line">        <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">            onSizeReady(overrideWidth, overrideHeight);<span class="comment">//getSize之后也会走到这个方法里面</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target.getSize(<span class="keyword">this</span>);<span class="comment">//重新计算宽高，后面最终还是会走到onSizeReady这个方法中</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否已经完成、是否图片还不是失败状态</span></span><br><span class="line">        <span class="comment">//如果使用了override() API为图片指定了一个固定的宽高，那么直接调用onSizeReady函数；</span></span><br><span class="line">        <span class="comment">// 如果没有指定，那么调用getSize函数，由Glide帮我们计算出宽高，但最终还是会调用会onSizeReady函数。</span></span><br><span class="line">        <span class="comment">// 所以这张图的出口就是onSizeReady函数</span></span><br><span class="line">        <span class="keyword">if</span> (!isComplete() &amp;&amp; !isFailed() &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">            target.onLoadStarted(getPlaceholderDrawable());<span class="comment">//onLoadStarted就是设定图片</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="into-2-onSizeReady"><a href="#into-2-onSizeReady" class="headerlink" title="into-2 onSizeReady"></a>into-2 onSizeReady</h4><p>into-2属于“准备数据”之“第二阶段”，并最终开启了“异步调用”的大门，先展示其时序图：</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-745c69da1189d3b8.jpg"  alt="img"></p>
<p>从上图我们可以看出，into-2的代码流程，实质上还是做数据准备，主要就是构造对象，封装对象。需要注意的是，这里开始使用“第一阶段”生成的GenericRequest对象，从GenericRequest对象取出各种需要的对象，传递给Engine的load函数，最终构造出了decodeJob对象。</p>
<ul>
<li><p>decodeJob对象是下一步“异步调用”的核心对象，“发起网络请求，拿到数据流”、“将数据流解码成bitmap对象”和“将bitmap对象转码成Drawable对象”，都是从decodeJob对象中发起的。在接下来的into-3和into-4中，读者就可以看到。</p>
</li>
<li><p>图中的StreamStringLoader的getResourceFetcher函数返回的是HttpUrlFetcher对象，没有注释由来。简单说一下：主要还是因为在Glide对象的构造过程中就注册了多个对应关系，经过三个对应关系的链式传递，最终返回了HttpUrlFetcher对象。这里贴一下简单的代码，有兴趣的同学，可以根据此线索追踪一下：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">register(String<span class="class">.<span class="keyword">class</span>, <span class="title">InputStream</span>.<span class="title">class</span>, <span class="title">new</span> <span class="title">StreamStringLoader</span>.<span class="title">Factory</span>())</span>;</span><br><span class="line">register(Uri<span class="class">.<span class="keyword">class</span>, <span class="title">InputStream</span>.<span class="title">class</span>, <span class="title">new</span> <span class="title">StreamUriLoader</span>.<span class="title">Factory</span>())</span>;</span><br><span class="line">register(GlideUrl<span class="class">.<span class="keyword">class</span>, <span class="title">InputStream</span>.<span class="title">class</span>, <span class="title">new</span> <span class="title">HttpUrlGlideUrlLoader</span>.<span class="title">Factory</span>())</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">ModelLoaderFactory</span>&lt;<span class="title">String</span>, <span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelLoader&lt;String, InputStream&gt; <span class="title">build</span><span class="params">(Context context, GenericLoaderFactory factories)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StreamStringLoader(factories.buildModelLoader(Uri<span class="class">.<span class="keyword">class</span>, <span class="title">InputStream</span>.<span class="title">class</span>))</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">ModelLoaderFactory</span>&lt;<span class="title">Uri</span>, <span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelLoader&lt;Uri, InputStream&gt; <span class="title">build</span><span class="params">(Context context, GenericLoaderFactory factories)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StreamUriLoader(context, factories.buildModelLoader(GlideUrl<span class="class">.<span class="keyword">class</span>, <span class="title">InputStream</span>.<span class="title">class</span>))</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">ModelLoaderFactory</span>&lt;<span class="title">GlideUrl</span>, <span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelLoader&lt;GlideUrl, InputStream&gt; <span class="title">build</span><span class="params">(Context context, GenericLoaderFactory factories)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpUrlGlideUrlLoader(modelCache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUrlGlideUrlLoader</span> <span class="keyword">implements</span> <span class="title">ModelLoader</span>&lt;<span class="title">GlideUrl</span>, <span class="title">InputStream</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataFetcher&lt;InputStream&gt; <span class="title">getResourceFetcher</span><span class="params">(GlideUrl model, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpUrlFetcher(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>源码拆分：</strong></p>
<h5 id="GenericRequest类-1"><a href="#GenericRequest类-1" class="headerlink" title="GenericRequest类"></a>GenericRequest类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericRequest</span>&lt;<span class="title">A</span>, <span class="title">T</span>, <span class="title">Z</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Request</span>, <span class="title">SizeReadyCallback</span>,</span></span><br><span class="line"><span class="class">        <span class="title">ResourceCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        startTime = LogTime.getLogTime();</span><br><span class="line">        <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">            onException(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        status = Status.WAITING_FOR_SIZE;</span><br><span class="line">        <span class="comment">//isValidDimensions:判断是否调用了override方法</span></span><br><span class="line">        <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">            onSizeReady(overrideWidth, overrideHeight);<span class="comment">//getSize之后也会走到这个方法里面</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target.getSize(<span class="keyword">this</span>);<span class="comment">//重新计算宽高，后面最终还是会走到onSizeReady这个方法中</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否已经完成、是否图片还不是失败状态</span></span><br><span class="line">        <span class="comment">//如果使用了override() API为图片指定了一个固定的宽高，那么直接调用onSizeReady函数；</span></span><br><span class="line">        <span class="comment">// 如果没有指定，那么调用getSize函数，由Glide帮我们计算出宽高，但最终还是会调用会onSizeReady函数。</span></span><br><span class="line">        <span class="comment">// 所以这张图的出口就是onSizeReady函数</span></span><br><span class="line">        <span class="keyword">if</span> (!isComplete() &amp;&amp; !isFailed() &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">            target.onLoadStarted(getPlaceholderDrawable());<span class="comment">//onLoadStarted就是设定图片</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A callback method that should never be invoked directly.</span></span><br><span class="line"><span class="comment">     * 1. 通过loadProvider获取ModelLoader和ResourceTranscoder，loadProvider是GenericRequest的一个成员变量，在哪里被初始化的可以看它的子类DrawableTypeRequest</span></span><br><span class="line"><span class="comment">     * 2. 通过ModelLoader获取DataFetcher</span></span><br><span class="line"><span class="comment">     * 3. 最后调用engine.load()进行实际的图片加载</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"Got onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        status = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">        width = Math.round(sizeMultiplier * width);</span><br><span class="line">        height = Math.round(sizeMultiplier * height);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ModelLoader:是将图片数据源Model转成原始数据Data，一般是指InputStream</span></span><br><span class="line">        ModelLoader&lt;A, T&gt; modelLoader = loadProvider.getModelLoader();<span class="comment">//loadProvider里面有三个重要的对象：ModelLoader、ResourceTranscoder、</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//DataFetcher:是将Data原始数据转成直接用的不同形式的类型，ByteArrayFetcher、HttpUrlFetcher、如ImageVideoFetcher</span></span><br><span class="line">        <span class="keyword">final</span> DataFetcher&lt;T&gt; dataFetcher = modelLoader.getResourceFetcher(model, width, height);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dataFetcher == <span class="keyword">null</span>) &#123;</span><br><span class="line">            onException(<span class="keyword">new</span> Exception(<span class="string">"Failed to load model: \'"</span> + model + <span class="string">"\'"</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ResourceTranscoder:是一个将原始对象解码的一个对象，将获取的原始数据io流、数据流解码成Bitmap，解码之后的资源称为Resource</span></span><br><span class="line">        ResourceTranscoder&lt;Z, R&gt; transcoder = loadProvider.getTranscoder();</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"finished setup for calling load in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">        loadedFromMemoryCache = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//load方法包含了图片加载的实际全过程</span></span><br><span class="line">        loadStatus = engine.load(signature, width, height, dataFetcher, loadProvider, transformation, transcoder,</span><br><span class="line">                priority, isMemoryCacheable, diskCacheStrategy, <span class="keyword">this</span>);</span><br><span class="line">        loadedFromMemoryCache = resource != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logV(<span class="string">"finished onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;        </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最后调用到了Engine.load方法</p>
<blockquote>
<p>engine.load(signature, width, height, dataFetcher, loadProvider, transformation, transcoder,              priority, isMemoryCacheable, diskCacheStrategy, this);</p>
</blockquote>
<h5 id="Engine类"><a href="#Engine类" class="headerlink" title="Engine类"></a>Engine类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engine</span></span>&#123;</span><br><span class="line">     <span class="keyword">public</span> &lt;T, Z, R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(Key signature, <span class="keyword">int</span> width, <span class="keyword">int</span> height, DataFetcher&lt;T&gt; fetcher,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     DataLoadProvider&lt;T, Z&gt; loadProvider, Transformation&lt;Z&gt; transformation, ResourceTranscoder&lt;Z, R&gt; transcoder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     Priority priority, <span class="keyword">boolean</span> isMemoryCacheable, DiskCacheStrategy diskCacheStrategy, ResourceCallback cb)</span> </span>&#123;</span><br><span class="line">        Util.assertMainThread();</span><br><span class="line">        <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String id = fetcher.getId();<span class="comment">//id可以理解为加载图片的唯一标识</span></span><br><span class="line">        <span class="comment">//如果调用了over传入了不同的宽和高，就会生成不同的EngineKey，而EngineKey就是Glide缓存的key</span></span><br><span class="line">        EngineKey key = keyFactory.buildKey(id, signature, width, height, loadProvider.getCacheDecoder(),</span><br><span class="line">                loadProvider.getSourceDecoder(), transformation, loadProvider.getEncoder(),</span><br><span class="line">                transcoder, loadProvider.getSourceEncoder());</span><br><span class="line"></span><br><span class="line">        EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);<span class="comment">//从缓存中读取图片，表示：最近使用的，而当前不在使用，LinkedHaspMap，以LruCache来管理</span></span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cb.onResourceReady(cached);<span class="comment">//接口回调</span></span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Loaded resource from cache"</span>, startTime, key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);<span class="comment">//从正在使用的图片中去找，保存正在使用的EngineResource，以弱引用来管理，HaspMap</span></span><br><span class="line">        <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cb.onResourceReady(active);<span class="comment">//接口回调，EngineJob</span></span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Loaded resource from active resources"</span>, startTime, key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EngineJob current = jobs.get(key);</span><br><span class="line">        <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">            current.addCallback(cb);</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">"Added to existing load"</span>, startTime, key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启请求从网络上面下载</span></span><br><span class="line">        <span class="comment">//engineJob、decodeJob、EngineRunnable、addCallback</span></span><br><span class="line">        EngineJob engineJob = engineJobFactory.build(key, isMemoryCacheable);</span><br><span class="line">        DecodeJob&lt;T, Z, R&gt; decodeJob = <span class="keyword">new</span> DecodeJob&lt;T, Z, R&gt;(key, width, height, fetcher, loadProvider, transformation,</span><br><span class="line">                transcoder, diskCacheProvider, diskCacheStrategy, priority);</span><br><span class="line">        EngineRunnable runnable = <span class="keyword">new</span> EngineRunnable(engineJob, decodeJob, priority);</span><br><span class="line">        jobs.put(key, engineJob);</span><br><span class="line">        engineJob.addCallback(cb);</span><br><span class="line">        engineJob.start(runnable);<span class="comment">//异步处理</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">            logWithTimeAndKey(<span class="string">"Started new load"</span>, startTime, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最终会走到engineJob.start(runnable)方法，decodeJob对象是下一步“异步调用”的核心对象，“发起网络请求，拿到数据流”、“将数据流解码成bitmap对象”和“将bitmap对象转码成Drawable对象”，都是从decodeJob对象中发起的。</p>
<h4 id="into-3-run"><a href="#into-3-run" class="headerlink" title="into-3-run"></a>into-3-run</h4><p>into-3和into-4可以连在一起看。into-3属于“异步处理”之“发起网络请求，拿到数据流”和“将数据流解码成bitmap对象”，先展示其时序图：</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-ba7961161451d685.jpg"  alt="img"></p>
<p>从上图我们可以看出，into-3的代码流程，主要完成了“发起网络请求，拿到数据流”和“将数据流解码成bitmap对象”两件小事。<br> 另外需要说明的是：</p>
<ul>
<li>该时序图涉及的流程中，有些对象比较难追溯，我都写了相关注释，方便读者阅读源代码。</li>
<li>拿到bitmap对象之后，并没有直接返回bitmap对象，而是进行了封装，其目的就是为了封装之后，Bitmap图片和Gif图片可以统一处理。</li>
</ul>
<h4 id="into-4"><a href="#into-4" class="headerlink" title="into-4"></a>into-4</h4><p>into-4和into-3可以连在一起看。into-4属于“异步处理”之“将bitmap对象转码成Drawable对象”，先展示其时序图：</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-1eb83ff2f1c7dcb2.jpg"  alt="img"></p>
<p>从上图我们可以看出，into-4的代码流程，主要完成了“异步处理”中的第三件小事：“将bitmap对象转码成Drawable对象”<br> 另外需要说明的是：</p>
<ul>
<li>该时序图涉及的流程中，有些对象比较难追溯，我都写了相关注释，方便读者阅读源代码。</li>
<li>转码的原因：只有Bitmap或者Drawable才能显示到ImageView上，而Bitmap转换成Drawable是为了保证静图和动图的类型一致性（动图的类型是Drawable），逻辑上好处理。具体可以参考如下代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;GlideDrawable&gt; <span class="title">transcode</span><span class="params">(Resource&lt;GifBitmapWrapper&gt; toTranscode)</span> </span>&#123;</span><br><span class="line">    GifBitmapWrapper gifBitmap = toTranscode.get();</span><br><span class="line">    Resource&lt;Bitmap&gt; bitmapResource = gifBitmap.getBitmapResource();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Resource&lt;? extends GlideDrawable&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (bitmapResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = bitmapDrawableResourceTranscoder.transcode(bitmapResource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = gifBitmap.getGifResource();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// This is unchecked but always safe, anything that extends a Drawable can be safely cast to a Drawable.</span></span><br><span class="line">    <span class="keyword">return</span> (Resource&lt;GlideDrawable&gt;) result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Bitmap&gt; <span class="title">getBitmapResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bitmapResource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;GifDrawable&gt; <span class="title">getGifResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gifResource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="into-5"><a href="#into-5" class="headerlink" title="into-5"></a>into-5</h4><p>into-5属于“切换到主线程”之“显示Drawable对象”，先展示其时序图：</p>
<p><img src="/" class="lazyload" data-src="/img/glide_assets/5105267-d4d70aa429af00f8.jpg"  alt="img"></p>
<p>从上图我们可以看出，into-5的代码流程，主要完成了在主线程中显示Drawable对象<br> 另外需要说明的是：</p>
<ul>
<li>该时序图涉及的流程中，有些对象比较难追溯，我都写了相关注释，方便读者阅读源代码。</li>
<li>通过Handler机制，Glide从工作线程切换到主线程，并最终将Drawable对象显示到ImageView上。</li>
</ul>
<p>总结：</p>
<blockquote>
<p>经过一番图文讲解，读者是不是对于Glide源码整体流程有了大致的了解。如果想进一步了解的话，建议读者跟着时序图，走一遍源代码，应该会收获更多。<br> 对于阅读复杂的源码，分享给大家一点经验：先从框架或者主流程入手，然后再逐个细化各个模块，最后再想想作者为什么要这么设计，我们能学习或者借鉴到什么。<br> 好了，这一篇就到这里吧，接下来的几篇文章，会针对各个特性，进行针对性介绍，敬请期待。</p>
</blockquote>
<h2 id="END"><a href="#END" class="headerlink" title="END."></a>END.</h2></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Glide/">Glide</a></div><div class="post_share"><div class="social-share" data-image="https://pic4.zhimg.com/v2-eb05d8524374771337ecde8cca28cfff_1440w.jpg?source=172ae18b" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/05/21/%E5%8D%9A%E6%96%87%E5%9C%B0%E5%9D%80%E6%8E%A8%E8%8D%90/"><img class="prev_cover lazyload" data-src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1591889554697&amp;di=6cd48317171455e6e367313f3430a2e2&amp;imgtype=0&amp;src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180717%2Fab8a30734c7f45ad847ca089864e25e4.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">博文地址推荐</div></div></a></div><div class="next-post pull_right"><a href="/2020/05/18/Android%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Retrofit/"><img class="next_cover lazyload" data-src="https://img.cniao5.com/o_1avp1uvsgh7irrvv158jn7mf9.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android源码分析——Retrofit</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/05/25/Android源码分析——Dagger2（未完）/" title="Android源码分析——Dagger2（未完）"><img class="relatedPosts_cover lazyload"data-src="https://img.cniao5.com/o_1b3rl8h6mk8d162i1i0p1ha6p989.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-25</div><div class="relatedPosts_title">Android源码分析——Dagger2（未完）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/18/Android源码分析——Retrofit/" title="Android源码分析——Retrofit"><img class="relatedPosts_cover lazyload"data-src="https://img.cniao5.com/o_1avp1uvsgh7irrvv158jn7mf9.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-18</div><div class="relatedPosts_title">Android源码分析——Retrofit</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/21/博文地址推荐/" title="博文地址推荐"><img class="relatedPosts_cover lazyload"data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591889554697&di=6cd48317171455e6e367313f3430a2e2&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180717%2Fab8a30734c7f45ad847ca089864e25e4.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-21</div><div class="relatedPosts_title">博文地址推荐</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/13/开发技能汇总/" title="开发技能汇总"><img class="relatedPosts_cover lazyload"data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1589358596541&di=ec2608777052785cb20f0d366f2d82b7&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20170830%2F544fed872efd40a5acf7ebcec0067fc1.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-13</div><div class="relatedPosts_title">开发技能汇总</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/25/Android源码分析——EventBus/" title="Android源码分析——EventBus"><img class="relatedPosts_cover lazyload"data-src="https://img-blog.csdnimg.cn/20181208105518324.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-25</div><div class="relatedPosts_title">Android源码分析——EventBus</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/15/Android源码分析——OKHttp/" title="Android源码分析——OKHttp"><img class="relatedPosts_cover lazyload"data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=357267695,3859876688&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-15</div><div class="relatedPosts_title">Android源码分析——OKHttp</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Kai</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>